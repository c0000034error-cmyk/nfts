<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NFT Universe</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --primary: #f59e0b;
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
            --text: #f1f5f9;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 5000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI –≠–õ–ï–ú–ï–ù–¢–´ */
        button { border: none; outline: none; cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.1s; }
        button:active { transform: scale(0.97); opacity: 0.9; }

        .btn { background: var(--primary); color: #000; padding: 12px; border-radius: 10px; width: 100%; font-size: 14px; }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-admin { background: #ff0055; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; margin-left: 10px; display: none; }

        /* –®–ê–ü–ö–ê */
        .header {
            padding: 15px; padding-top: max(15px, env(safe-area-inset-top));
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
            backdrop-filter: blur(10px);
        }
        .balance-box { font-size: 16px; color: var(--primary); font-weight: bold; display: flex; align-items: center; gap: 5px; }

        /* –ö–û–ù–¢–ï–ù–¢ */
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–ê–†–¢–û–ß–ö–ò –ò –°–ï–¢–ö–ê */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card {
            background: var(--panel); border-radius: var(--radius); padding: 10px;
            display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.05);
            position: relative; overflow: hidden;
        }

        /* NFT –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø */
        .nft-img {
            width: 100%; aspect-ratio: 1; border-radius: 10px; margin-bottom: 8px;
            background: #333; object-fit: cover; display: block;
        }
        .rarity-badge {
            position: absolute; top: 8px; right: 8px; font-size: 10px;
            padding: 4px 8px; border-radius: 6px; background: rgba(0,0,0,0.8);
            color: white; font-weight: bold; backdrop-filter: blur(4px);
        }

        /* –ú–û–î–ê–õ–ö–ò (–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            width: 100%; max-width: 400px; background: var(--bg);
            padding: 24px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        input {
            background: #0f172a; border: 1px solid #334155; padding: 14px;
            border-radius: 12px; color: white; width: 100%; margin-bottom: 12px;
            font-size: 16px; outline: none;
        }
        input:focus { border-color: var(--accent); }

        /* –¢–ê–ü–ê–õ–ö–ê */
        .tap-circle {
            width: 240px; height: 240px; margin: 20px auto;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fbbf24, #d97706);
            box-shadow: 0 0 60px rgba(245, 158, 11, 0.4), inset 0 0 20px rgba(255,255,255,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 80px; cursor: pointer; transition: transform 0.05s;
            border: 8px solid rgba(255,255,255,0.1);
        }
        .tap-circle:active { transform: scale(0.95); }

        /* –ú–ï–ù–Æ */
        .navbar {
            position: fixed; bottom: 0; width: 100%; background: rgba(30, 41, 59, 0.95);
            display: flex; border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(10px); z-index: 100;
        }
        .nav-item { flex: 1; padding: 14px 0; text-align: center; font-size: 11px; color: #64748b; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        /* –ö–ê–ó–ò–ù–û –¢–ê–ë–´ */
        .game-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .game-tab { white-space: nowrap; padding: 8px 16px; background: var(--panel); border-radius: 20px; font-size: 13px; color: #94a3b8; }
        .game-tab.active { background: var(--primary); color: #000; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 10px 20px; border-radius: 50px; z-index: 3000;
            display: none; border: 1px solid #555; font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <!-- –ó–ê–ì–†–£–ó–ö–ê -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div style="font-size: 14px; color: #888;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –í–•–û–î–ê/–†–ï–ì–ò–°–¢–†–ê–¶–ò–ò -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="auth-title">–í—Ö–æ–¥</h2>
            <p style="color:#64748b; margin-bottom:20px; font-size:14px;">–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –æ–±–ª–∞–∫–µ</p>
            
            <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            
            <button class="btn" onclick="submitAuth()">–ü–æ–µ—Ö–∞–ª–∏ üöÄ</button>
            
            <div onclick="toggleAuth()" style="margin-top:20px; font-size:13px; color:var(--primary); text-decoration:underline; cursor:pointer;">
                –°–º–µ–Ω–∏—Ç—å –Ω–∞ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é / –í—Ö–æ–¥
            </div>
            <div id="auth-error" style="color:var(--danger); font-size:12px; margin-top:10px;"></div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ü–†–û–î–ê–ñ–ò -->
    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NFT</h3>
            <img src="" id="sell-img" class="nft-img" style="border-radius:12px;">
            <p id="sell-info" style="color:#94a3b8; margin-bottom:15px;"></p>
            
            <button class="btn btn-outline" onclick="sellToSystem()">
                ‚ôªÔ∏è –°–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º–µ (+<span id="sys-price">0</span>üí∞)
            </button>
            
            <div style="display:flex; align-items:center; gap:10px; margin:15px 0;">
                <div style="height:1px; background:#334155; flex:1;"></div>
                <span style="font-size:12px; color:#64748b;">–ò–õ–ò</span>
                <div style="height:1px; background:#334155; flex:1;"></div>
            </div>

            <input type="number" id="p2p-price" placeholder="–¶–µ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤">
            <button class="btn" onclick="sellToP2P()">üì¢ –ü—Ä–æ–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞–º</button>
            <button class="btn btn-danger" onclick="closeModal('sell-modal')" style="margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨ -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-box" style="border-color: #ff0055;">
            <h2 style="color: #ff0055;">üëë ADMIN PANEL</h2>
            <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –ì–æ—Å–ø–æ–¥–∏–Ω kayivi</p>
            <div class="grid">
                <button class="btn" onclick="adminAddMoney()">+5000 üí∞</button>
                <button class="btn" onclick="adminFillEnergy()">Energy Full</button>
                <button class="btn btn-danger" onclick="adminClearMarket()">Reset Market</button>
            </div>
            <button class="btn btn-outline" onclick="closeModal('admin-modal')" style="margin-top:20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</div>

    <!-- HEADER -->
    <div class="header">
        <div style="display:flex; align-items:center;">
            <span style="font-size:20px; margin-right:5px;">üë§</span>
            <span id="my-nick" style="font-weight:600;">...</span>
            <button id="admin-btn" class="btn-admin" onclick="openModal('admin-modal')">ADMIN</button>
        </div>
        <div class="balance-box">
            <span id="balance">0</span> üí∞
        </div>
    </div>

    <!-- –ö–û–ù–¢–ï–ù–¢ -->
    <div class="content">

        <!-- 1. –ì–õ–ê–í–ù–ê–Ø -->
        <div id="tab-home" class="screen active">
            <div class="tap-circle" id="tap-btn">‚Çø</div>
            <div style="text-align:center; color:#94a3b8; margin-bottom:20px;">
                ‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">1000</span>/1000
            </div>
            <h3>–ú–æ—è –ö–æ–ª–ª–µ–∫—Ü–∏—è</h3>
            <div class="grid" id="inventory-list"></div>
        </div>

        <!-- 2. –†–´–ù–û–ö -->
        <div id="tab-market" class="screen">
            <div class="game-tabs">
                <div class="game-tab active" onclick="switchShop('sys')" id="tab-sys">üè™ –í–∏—Ç—Ä–∏–Ω–∞ –°–∏—Å—Ç–µ–º—ã</div>
                <div class="game-tab" onclick="switchShop('p2p')" id="tab-p2p">üåç –ë–∏—Ä–∂–∞ –ò–≥—Ä–æ–∫–æ–≤</div>
            </div>

            <!-- –°–∏—Å—Ç–µ–º–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω -->
            <div id="view-sys">
                <p style="font-size:12px; color:#64748b; margin-bottom:10px;">–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ)</p>
                <div class="grid" id="system-shop-list"></div>
            </div>

            <!-- P2P -->
            <div id="view-p2p" style="display:none;">
                <button class="btn btn-outline" onclick="loadP2P()" style="margin-bottom:10px; padding:8px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <div class="grid" id="p2p-list">
                    <p style="width:200%; text-align:center; color:#64748b;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>

        <!-- 3. –ö–ê–ó–ò–ù–û -->
        <div id="tab-casino" class="screen">
            <div class="game-tabs">
                <div class="game-tab active" onclick="switchGame('slots')">Slots</div>
                <div class="game-tab" onclick="switchGame('coin')">Coin</div>
                <div class="game-tab" onclick="switchGame('dice')">Dice</div>
            </div>

            <!-- SLOTS -->
            <div id="game-slots" class="card" style="text-align:center; padding:30px;">
                <h2 style="margin:0 0 20px 0;">üé∞ 777</h2>
                <div style="font-size:40px; letter-spacing:10px; margin-bottom:20px;" id="slots-display">üçí üçí üçí</div>
                <input type="number" id="slots-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <button class="btn" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å (x5)</button>
            </div>

            <!-- COIN FLIP -->
            <div id="game-coin" class="card" style="text-align:center; padding:30px; display:none;">
                <h2 style="margin:0 0 20px 0;">ü™ô –û—Ä—ë–ª –∏–ª–∏ –†–µ—à–∫–∞</h2>
                <div style="font-size:60px; margin-bottom:20px;" id="coin-display">‚ùì</div>
                <input type="number" id="coin-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <div class="grid">
                    <button class="btn" style="background:#fbbf24; color:black;" onclick="playCoin('heads')">–û—Ä—ë–ª</button>
                    <button class="btn" style="background:#94a3b8; color:white;" onclick="playCoin('tails')">–†–µ—à–∫–∞</button>
                </div>
                <p style="font-size:12px; color:#64748b; margin-top:10px;">–ü–æ–±–µ–¥–∞ x1.9</p>
            </div>

            <!-- DICE -->
            <div id="game-dice" class="card" style="text-align:center; padding:30px; display:none;">
                <h2 style="margin:0 0 20px 0;">üé≤ –ö–æ—Å—Ç–∏</h2>
                <p style="color:#94a3b8;">–í—ã–ø–∞–¥–µ—Ç –±–æ–ª—å—à–µ 50?</p>
                <div style="font-size:50px; margin-bottom:20px; color:var(--accent); font-weight:bold;" id="dice-display">50</div>
                <input type="number" id="dice-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <div class="grid">
                    <button class="btn btn-danger" onclick="playDice('under')">–ú–µ–Ω—å—à–µ 50</button>
                    <button class="btn btn-success" onclick="playDice('over')">–ë–æ–ª—å—à–µ 50</button>
                </div>
                <p style="font-size:12px; color:#64748b; margin-top:10px;">–ü–æ–±–µ–¥–∞ x1.9</p>
            </div>
        </div>

    </div>

    <!-- –ú–ï–ù–Æ -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home')"><span class="nav-icon">üè†</span>–î–æ–º</div>
        <div class="nav-item" onclick="nav('market')"><span class="nav-icon">üõí</span>–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="nav-item" onclick="nav('casino')"><span class="nav-icon">üé≤</span>–ò–≥—Ä—ã</div>
    </div>

    <script>
        /* === CONFIG === */
        const firebaseConfig = {
            apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg",
            authDomain: "nfts-dc174.firebaseapp.com",
            projectId: "nfts-dc174",
            storageBucket: "nfts-dc174.firebasestorage.app",
            messagingSenderId: "327365720624",
            appId: "1:327365720624:web:eb42c9d671566b5d118bf5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let myUid = null, myData = null;
        let isRegMode = false;
        let selectedIdx = null; // –î–ª—è –ø—Ä–æ–¥–∞–∂–∏
        let shopItems = []; // –¢–µ–∫—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã –≤ –º–∞–≥–∞–∑–∏–Ω–µ —Å–∏—Å—Ç–µ–º—ã

        // === AUTH & LOADING ===
        auth.onAuthStateChanged(user => {
            document.getElementById('loading-screen').style.display = 'none';
            if (user) {
                myUid = user.uid;
                closeModal('auth-modal');
                initGame();
            } else {
                openModal('auth-modal');
            }
        });

        function toggleAuth() {
            isRegMode = !isRegMode;
            document.getElementById('auth-title').innerText = isRegMode ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
            document.getElementById('auth-error').innerText = "";
        }

        async function submitAuth() {
            const nick = document.getElementById('auth-nick').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const email = `${nick.replace(/[^a-z0-9]/gi,'')}@nfts.game`.toLowerCase();
            const err = document.getElementById('auth-error');

            if(pass.length < 6) return err.innerText = "–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤";

            try {
                if(isRegMode) {
                    const snap = await db.collection('users').where('nickname', '==', nick).get();
                    if(!snap.empty) throw new Error("–ù–∏–∫ –∑–∞–Ω—è—Ç");
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(cred.user.uid).set({
                        nickname: nick, balance: 1000, energy: 1000, inventory: [], createdAt: Date.now()
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch(e) {
                err.innerText = "–û—à–∏–±–∫–∞: " + e.message;
            }
        }

        // === GAME INIT ===
        function initGame() {
            db.collection('users').doc(myUid).onSnapshot(doc => {
                if(doc.exists) {
                    myData = doc.data();
                    updateUI();
                    renderInventory();
                    
                    // ADMIN CHECK
                    if(myData.nickname === 'kayivi') {
                        document.getElementById('admin-btn').style.display = 'block';
                    }
                }
            });
            generateSystemShop();
            loadP2P();
        }

        function updateUI() {
            if(!myData) return;
            document.getElementById('balance').innerText = Math.floor(myData.balance);
            document.getElementById('energy').innerText = Math.floor(myData.energy);
            document.getElementById('my-nick').innerText = myData.nickname;
        }

        // === NFT SYSTEM ===
        function generateNFT(forcedRarity) {
            const r = Math.random();
            let rarity = forcedRarity || (r>0.98?"Legendary":r>0.8?"Rare":"Common");
            const seed = Math.floor(Math.random()*1000000);
            return {
                id: Date.now() + "_" + Math.floor(Math.random()*1000),
                seed: seed,
                rarity: rarity,
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ —á–µ—Ä–µ–∑ Picsum –ø–æ seed
                img: `https://picsum.photos/seed/${seed}/300/300`,
                price: rarity==='Legendary'?2000:(rarity==='Rare'?500:50)
            };
        }

        function getRarityColor(r) {
            if(r==='Legendary') return '#fbbf24'; // Gold
            if(r==='Rare') return '#818cf8'; // Indigo
            return '#94a3b8'; // Gray
        }

        // === TAP ===
        document.getElementById('tap-btn').addEventListener('click', (e) => {
            if(myData.energy < 1) return showToast("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏ ‚ö°");
            
            myData.balance++;
            myData.energy--;
            
            // –®–∞–Ω—Å –¥—Ä–æ–ø–∞
            if(Math.random() < 0.005) {
                const nft = generateNFT();
                myData.inventory.push(nft);
                showToast(`üéÅ –í—ã–ø–∞–ª NFT: ${nft.rarity}`);
            }

            if(myData.balance%20===0) saveGame();
            updateUI();
            
            // –≠—Ñ—Ñ–µ–∫—Ç
            const f = document.createElement('div');
            f.innerText = "+1"; f.style.position='absolute'; 
            f.style.left=e.clientX+'px'; f.style.top=e.clientY+'px';
            f.style.color='white'; f.style.pointerEvents='none';
            document.body.appendChild(f);
            setTimeout(()=>f.remove(), 500);
        });

        setInterval(() => {
            if(myData && myData.energy < 1000) {
                myData.energy = Math.min(1000, myData.energy + 5);
                updateUI();
            }
        }, 1000);

        function saveGame() {
            db.collection('users').doc(myUid).update({
                balance: myData.balance, energy: myData.energy, inventory: myData.inventory
            });
        }

        // === INVENTORY & SELL ===
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            myData.inventory.forEach((nft, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <span class="rarity-badge" style="background:${getRarityColor(nft.rarity)}">${nft.rarity}</span>
                    <img src="${nft.img}" class="nft-img" loading="lazy">
                    <button class="btn btn-outline" style="font-size:12px; padding:8px;" onclick="openSellModal(${i})">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
                `;
                list.appendChild(div);
            });
        }

        function openSellModal(i) {
            selectedIdx = i;
            const nft = myData.inventory[i];
            document.getElementById('sell-img').src = nft.img;
            document.getElementById('sell-info').innerText = `${nft.rarity} | –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞: ${nft.price}`;
            document.getElementById('sys-price').innerText = Math.floor(nft.price * 0.5);
            openModal('sell-modal');
        }

        function sellToSystem() {
            const nft = myData.inventory[selectedIdx];
            const price = Math.floor(nft.price * 0.5);
            myData.balance += price;
            myData.inventory.splice(selectedIdx, 1);
            saveGame();
            closeModal('sell-modal');
            showToast(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${price}`);
        }

        function sellToP2P() {
            const price = parseInt(document.getElementById('p2p-price').value);
            if(!price || price < 1) return showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞");
            
            const nft = myData.inventory[selectedIdx];
            
            db.runTransaction(async (t) => {
                const ref = db.collection('users').doc(myUid);
                const doc = await t.get(ref);
                const inv = doc.data().inventory;
                inv.splice(selectedIdx, 1);
                
                t.update(ref, {inventory: inv});
                const mRef = db.collection('market').doc();
                t.set(mRef, {
                    seller: myUid, sellerName: myData.nickname,
                    price: price, nft: nft, createdAt: Date.now()
                });
            }).then(() => {
                closeModal('sell-modal');
                showToast("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä—ã–Ω–æ–∫");
                loadP2P();
            });
        }

        // === SHOP SYSTEM ===
        function generateSystemShop() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 4 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã
            shopItems = [];
            for(let i=0; i<4; i++) {
                shopItems.push(generateNFT());
            }
            renderSystemShop();
        }

        function renderSystemShop() {
            const list = document.getElementById('system-shop-list');
            list.innerHTML = '';
            shopItems.forEach((nft, i) => {
                // –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ = –±–∞–∑–æ–≤–∞—è * 1.5 (–Ω–∞—Ü–µ–Ω–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞)
                const buyPrice = Math.floor(nft.price * 1.5);
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <span class="rarity-badge" style="background:${getRarityColor(nft.rarity)}">${nft.rarity}</span>
                    <img src="${nft.img}" class="nft-img" loading="lazy">
                    <button class="btn" onclick="buySystemItem(${i}, ${buyPrice})">${buyPrice} üí∞</button>
                `;
                list.appendChild(div);
            });
        }

        function buySystemItem(i, price) {
            if(myData.balance < price) return showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥");
            
            myData.balance -= price;
            myData.inventory.push(shopItems[i]);
            saveGame();
            showToast("–ö—É–ø–ª–µ–Ω–æ!");
            
            // –ó–∞–º–µ–Ω—è–µ–º –∫—É–ø–ª–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –Ω–æ–≤—ã–º
            shopItems[i] = generateNFT();
            renderSystemShop();
        }

        function switchShop(type) {
            document.getElementById('view-sys').style.display = type==='sys'?'block':'none';
            document.getElementById('view-p2p').style.display = type==='p2p'?'block':'none';
            document.getElementById('tab-sys').classList.toggle('active', type==='sys');
            document.getElementById('tab-p2p').classList.toggle('active', type==='p2p');
            if(type==='p2p') loadP2P();
        }

        function loadP2P() {
            const list = document.getElementById('p2p-list');
            db.collection('market').orderBy('createdAt', 'desc').limit(20).get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p style="text-align:center; width:200%; color:#64748b;">–ü—É—Å—Ç–æ</p>'; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMine = d.seller === myUid;
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <span class="rarity-badge" style="background:${getRarityColor(d.nft.rarity)}">${d.nft.rarity}</span>
                        <img src="${d.nft.img}" class="nft-img" loading="lazy">
                        <div style="font-size:11px; margin-bottom:5px;">–ü—Ä–æ–¥–∞–≤–µ—Ü: ${d.sellerName}</div>
                        <button class="btn ${isMine?'btn-danger':'btn-success'}" onclick="${isMine?`cancelP2P('${doc.id}')`:`buyP2P('${doc.id}', ${d.price})`}">
                            ${isMine ? '–°–Ω—è—Ç—å' : `–ö—É–ø–∏—Ç—å ${d.price}`}
                        </button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function buyP2P(id, price) {
            if(myData.balance < price) return showToast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
            db.runTransaction(async (t) => {
                const mRef = db.collection('market').doc(id);
                const mDoc = await t.get(mRef);
                if(!mDoc.exists) throw "–£–∂–µ –∫—É–ø–∏–ª–∏";
                const lot = mDoc.data();
                
                t.update(db.collection('users').doc(lot.seller), { balance: firebase.firestore.FieldValue.increment(price) });
                t.update(db.collection('users').doc(myUid), { 
                    balance: firebase.firestore.FieldValue.increment(-price),
                    inventory: firebase.firestore.FieldValue.arrayUnion(lot.nft)
                });
                t.delete(mRef);
            }).then(() => { showToast("–ö—É–ø–ª–µ–Ω–æ!"); loadP2P(); }).catch(e => showToast(e));
        }

        function cancelP2P(id) {
            db.collection('market').doc(id).get().then(doc => {
                db.collection('users').doc(myUid).update({
                    inventory: firebase.firestore.FieldValue.arrayUnion(doc.data().nft)
                });
                doc.ref.delete();
                loadP2P();
            });
        }

        // === CASINO ===
        function switchGame(g) {
            ['slots','coin','dice'].forEach(x => document.getElementById('game-'+x).style.display = 'none');
            document.getElementById('game-'+g).style.display = 'block';
        }

        function playSlots() {
            const bet = parseInt(document.getElementById('slots-bet').value);
            if(!bet || bet > myData.balance) return showToast("–°—Ç–∞–≤–∫–∞?");
            myData.balance -= bet;
            updateUI();
            
            const em = ['üçí','üçã','üçá','7Ô∏è‚É£'];
            const res = [0,0,0].map(()=>em[Math.floor(Math.random()*em.length)]);
            document.getElementById('slots-display').innerText = res.join(' ');
            
            if(res[0]===res[1] && res[1]===res[2]) {
                const w = bet*5; myData.balance+=w; showToast(`x5 WIN! +${w}`);
            } else if(res[0]===res[1] || res[1]===res[2] || res[0]===res[2]) {
                const w = Math.floor(bet*1.5); myData.balance+=w; showToast(`x1.5 WIN! +${w}`);
            }
            saveGame();
        }

        function playCoin(choice) {
            const bet = parseInt(document.getElementById('coin-bet').value);
            if(!bet || bet > myData.balance) return showToast("–°—Ç–∞–≤–∫–∞?");
            myData.balance -= bet;
            
            const res = Math.random()<0.5 ? 'heads' : 'tails';
            const display = res==='heads'?'ü¶Ö':'ü™ô';
            document.getElementById('coin-display').innerText = display;
            
            if(res === choice) {
                const w = Math.floor(bet * 1.9);
                myData.balance += w;
                showToast(`–ü–æ–±–µ–¥–∞! +${w}`);
            } else {
                showToast("–ü—Ä–æ–∏–≥—Ä—ã—à");
            }
            updateUI(); saveGame();
        }

        function playDice(choice) {
            const bet = parseInt(document.getElementById('dice-bet').value);
            if(!bet || bet > myData.balance) return showToast("–°—Ç–∞–≤–∫–∞?");
            myData.balance -= bet;
            
            const roll = Math.floor(Math.random() * 100) + 1; // 1-100
            document.getElementById('dice-display').innerText = roll;
            
            let win = false;
            if(choice === 'over' && roll > 50) win = true;
            if(choice === 'under' && roll < 50) win = true;
            
            if(win) {
                const w = Math.floor(bet * 1.9);
                myData.balance += w;
                showToast(`–ü–æ–±–µ–¥–∞! +${w}`);
            } else {
                showToast("–ü—Ä–æ–∏–≥—Ä—ã—à");
            }
            updateUI(); saveGame();
        }

        // === ADMIN (kayivi) ===
        function adminAddMoney() {
            myData.balance += 5000;
            updateUI(); saveGame(); showToast("Admin: Money Added");
        }
        function adminFillEnergy() {
            myData.energy = 1000;
            updateUI(); saveGame(); showToast("Admin: Energy Full");
        }
        function adminClearMarket() {
            // –û–ø–∞—Å–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–µ–º–æ. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –±–∞—Ç—á–∞–º–∏.
            // –ó–¥–µ—Å—å –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä–æ–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            alert("–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏");
        }

        // === UTILS ===
        function nav(t) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const map = {'home':0, 'market':1, 'casino':2};
            document.querySelectorAll('.nav-item')[map[t]].classList.add('active');
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showToast(m) {
            const t = document.getElementById('toast'); t.innerText=m; t.style.display='block';
            setTimeout(()=>t.style.display='none', 2000);
        }
    </script>
</body>
</html>
