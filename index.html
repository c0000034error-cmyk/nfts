<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>NFT Universe ‚Äî HARDCORE (3D GLoss)</title>

<!-- Firebase (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Remix icons -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
:root{
  --bg:#050505; --card:#151517; --muted:#8b8b91; --primary:#6366f1; --accent:#d946ef;
  --gold:#fbbf24; --danger:#ef4444; --success:#10b981; --glass: rgba(255,255,255,0.03);
  --radius:14px;
}
*{box-sizing:border-box; -webkit-tap-highlight-color: transparent; user-select:none}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial;background:var(--bg);color:#fff}
.header{
  position:sticky; top:0; z-index:60; display:flex; align-items:center; justify-content:space-between;
  padding:12px 16px; gap:12px; background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.3));
  border-bottom:1px solid rgba(255,255,255,0.03);
}
.header-left{display:flex;align-items:center;gap:12px}
.avatar-frame{width:52px;height:52px;border-radius:50%;background:#111;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:20px;border:2px solid transparent}
.user-block{display:flex;flex-direction:column}
.user-nick{font-weight:900;font-size:15px}
.user-sub{font-size:12px;color:var(--muted)}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:linear-gradient(135deg,var(--primary),var(--accent));border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 10px 30px rgba(99,102,241,0.08)}
.btn-sm{padding:6px 10px;font-size:13px;border-radius:8px}
.btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06); color:#fff}
.btn-danger{background:var(--danger); color:#fff}
.btn-gold{background:var(--gold); color:#000; font-weight:900}
.toast{position:fixed;left:50%;top:22px;transform:translateX(-50%);background:rgba(12,12,12,0.95);padding:10px 16px;border-radius:18px;border:1px solid rgba(255,255,255,0.05);display:none;z-index:9999}

.content{padding:18px 18px 120px; min-height:calc(100vh - 110px)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:10px;background:#111;color:#bdbdbd;cursor:pointer}
.tab.active{background:#222;color:#fff}

.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));align-items:start}
.card{background:var(--card);border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;position:relative;transition:transform .18s ease, box-shadow .18s ease}
.card:hover{transform:translateY(-8px);box-shadow:0 24px 60px rgba(0,0,0,0.6)}
.nft-plate{width:92px;height:92px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:inset 0 1px rgba(255,255,255,0.02)}
.nft-img{width:78px;height:78px;object-fit:contain;transition:transform .35s ease}
.nft-3d{transform-style:preserve-3d; perspective:900px}
.nft-3d:hover .nft-img{transform:rotateX(8deg) rotateY(10deg) scale(1.05)}
.nft-name{font-weight:800;font-size:13px;margin-top:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
.nft-type{font-size:11px;color:#cfcfcf;background:rgba(0,0,0,0.35);padding:4px 8px;border-radius:8px;margin-top:6px}
.price{font-weight:900;padding:6px 8px;border-radius:8px;margin-top:8px;background:linear-gradient(180deg,#6b5df2,#b76cd7)}
.supply{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.45);padding:4px 6px;border-radius:8px;font-size:11px}
.equipped-marker{position:absolute;top:8px;right:8px;width:12px;height:12px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success)}

.navbar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0.9),rgba(0,0,0,0.95));display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid rgba(255,255,255,0.03);z-index:90}
.nav-item{color:#8b8b90;font-size:12px;text-align:center;cursor:pointer}
.nav-item.active{color:var(--primary)}

.screen{display:none}
.screen.active{display:block}

/* slot styles */
.slot-row{font-size:48px;margin:18px 0;letter-spacing:22px;background:#000;padding:12px;border-radius:12px;height:88px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.slot-reel{display:flex;gap:18px;align-items:center}
.slot-cell{font-size:44px;display:inline-block;transition:transform .7s cubic-bezier(.22,.98,.3,1), filter .4s ease}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:none;align-items:center;justify-content:center;z-index:999; padding:18px}
.modal-box{width:100%;max-width:520px;background:#0f0f11;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03)}
.modal-title{font-weight:900;margin:0}

/* profile cosmetics */
.style-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}

/* colors and frames */
.nick-gold{color:var(--gold);text-shadow:0 0 10px rgba(250,204,21,0.2)}
.nick-neon{color:#00f2ff;text-shadow:0 0 10px rgba(0,242,255,0.12)}
.nick-red{color:#ff6b6b;text-shadow:0 0 10px rgba(255,107,107,0.08)}
.nick-purple{color:#d946ef;text-shadow:0 0 10px rgba(217,70,239,0.08)}
.frame-gold{border-color:var(--gold);box-shadow:0 0 12px rgba(251,191,36,0.08)}
.frame-neon{border-color:#00f2ff;box-shadow:0 0 12px rgba(0,242,255,0.08)}
.frame-red{border-color:#ff6b6b;box-shadow:0 0 8px rgba(255,107,107,0.06)}
.frame-purple{border-color:#d946ef;box-shadow:0 0 10px rgba(217,70,239,0.06)}

.kv{font-size:12px;color:#bdbdbd}
.bigid{font-family:monospace;font-weight:800;font-size:12px;color:#ddd;background:rgba(0,0,0,0.25);padding:4px 6px;border-radius:6px}

/* smooth small animations to decorate but not heavy */
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.header .avatar-frame{animation:floaty 3.8s ease-in-out infinite}

</style>
</head>
<body>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- AUTH modal (shown by default if no session) -->
<div id="auth-modal" class="modal-overlay" style="display:flex; z-index:2000;">
  <div class="modal-box" style="background:transparent;border:none;text-align:center;">
    <div style="font-size:64px;margin-bottom:6px;">üèÜ</div>
    <h1 style="margin:0">NFT UNIVERSE</h1>
    <div style="color:var(--gold);margin-bottom:12px">HARDCORE ‚Äî –ì–ª—è–Ω—Ü–µ–≤—ã–π —Å—Ç–∏–ª—å</div>
    <div style="background:#0b0b0c;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:100%;max-width:420px;margin:0 auto">
      <h3 id="auth-title" style="margin:0 0 8px">–í—Ö–æ–¥</h3>
      <input id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;padding:10px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff;margin-bottom:8px">
      <input id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:100%;padding:10px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff;margin-bottom:8px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
        <input type="checkbox" id="remember-me" checked> –ó–∞–ø–æ–º–Ω–∏—Ç—å
      </div>
      <button class="btn" onclick="submitAuth()">–í–æ–π—Ç–∏</button>
      <div style="margin-top:12px;color:#a9a9a9;cursor:pointer" onclick="toggleAuth()">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="color:var(--primary)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></div>
      <div id="auth-error" style="color:var(--danger);margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <div id="my-frame" class="avatar-frame">U</div>
    <div class="user-block">
      <div id="my-nick" class="user-nick">User</div>
      <div class="user-sub"><span id="balance">0</span> üíé ‚Ä¢ <span id="energy">0</span> ‚ö°</div>
    </div>
  </div>

  <div class="controls">
    <button id="admin-btn" class="btn-gold btn-sm" style="display:none" onclick="openModal('admin-modal')">ADM</button>
    <button class="btn btn-sm btn-outline" onclick="openModal('boost-modal')">‚ö° Boost</button>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
    <div class="tabs">
      <div class="tab active" onclick="showScreen('home', this)">–î–æ–º</div>
      <div class="tab" onclick="showScreen('shop', this)">–®–æ–ø</div>
      <div class="tab" onclick="showScreen('casino', this)">–ò–≥—Ä—ã</div>
      <div class="tab" onclick="showScreen('profile', this)">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="kv">ID: <span id="user-id" class="bigid">-</span></div>
    </div>
  </div>

  <!-- HOME -->
  <div id="screen-home" class="screen active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:900;font-size:18px">–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è (<span id="inv-count">0</span>)</div>
      <div style="display:flex;gap:8px"><button class="btn btn-sm btn-outline" onclick="renderInv()">–û–±–Ω–æ–≤–∏—Ç—å</button></div>
    </div>
    <div class="grid" id="inventory-list"></div>
  </div>

  <!-- SHOP -->
  <div id="screen-shop" class="screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="color:#bdbdbd">‚òº –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –æ—Ç 100 000; –∫–∞–∂–¥–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç —Ü–µ–Ω—É (+1% –Ω–∞ –ø—Ä–æ–¥–∞–∂–∏)</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-outline" onclick="loadShop()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-sm" onclick="openModal('admin-modal')">ADM</button>
      </div>
    </div>
    <div class="grid" id="shop-list"></div>
  </div>

  <!-- CASINO -->
  <div id="screen-casino" class="screen" style="display:none">
    <div style="display:flex;gap:12px">
      <div style="flex:1;background:#0d0d0e;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–°–ª–æ—Ç—ã</h3>
        <div class="slot-row">
          <div class="slot-reel" id="slots-view">
            <div class="slot-cell" id="slot1">üçí</div>
            <div class="slot-cell" id="slot2">üçí</div>
            <div class="slot-cell" id="slot3">üçí</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="slots-bet" placeholder="–°—Ç–∞–≤–∫–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn" id="btn-spin" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å</button>
        </div>
        <div id="slot-info" style="margin-top:8px;color:#a9a9a9">–®–∞–Ω—Å –¥–∂–µ–∫–ø–æ—Ç–∞: 0.5%</div>
      </div>
      <div style="width:320px;background:#0d0d0e;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ú–∏–Ω—ã</h3>
        <div id="mines-field" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px"></div>
        <div style="display:flex;gap:8px">
          <input id="mines-bet" placeholder="–°—Ç–∞–≤–∫–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn" id="mines-btn" onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="screen-profile" class="screen" style="display:none">
    <div style="display:flex;gap:12px">
      <div style="flex:1;background:#0d0d0e;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div style="background:#0b0b0c;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>–ü–∞—Ä–æ–ª—å</div>
          <button class="btn-sm btn-outline" onclick="changePass()">–°–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div style="background:#0b0b0c;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div style="color:var(--danger)">–ó–æ–Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
          <button class="btn-sm btn-danger" onclick="deleteAcc()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
        <button class="btn btn-outline" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
      <div style="width:420px;background:#0d0d0e;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ì–∞—Ä–¥–µ—Ä–æ–±</h3>
        <div style="margin-bottom:8px"><b>–¶–≤–µ—Ç –Ω–∏–∫–∞</b></div>
        <div class="style-grid" id="style-colors"></div>
        <div style="margin-top:12px"><b>–†–∞–º–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞</b></div>
        <div class="style-grid" id="style-frames"></div>
      </div>
    </div>
  </div>

</div> <!-- end content -->

<!-- Confirm modal -->
<div id="confirm-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
    <div id="confirm-text" style="color:#cfcfcf;margin:8px 0">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="confirmAction()">–î–∞</button>
      <button class="btn btn-outline" onclick="closeModal('confirm-modal')">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- NFT modal (view/sell/gift) -->
<div id="nft-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 id="modal-name" class="modal-title">Item</h3>
    <div style="display:flex;gap:12px;margin-top:10px">
      <div style="width:140px">
        <div class="nft-3d" style="width:140px;height:140px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);">
          <img id="modal-img" src="" style="width:120px;height:120px;object-fit:contain;border-radius:10px;"/>
        </div>
      </div>
      <div style="flex:1">
        <div id="modal-serial" style="color:#a9a9a9">#00001</div>
        <div id="modal-type" class="nft-type">Type</div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn" onclick="equipNft()">–î–µ–π—Å—Ç–≤–∏—è</button>
          <button class="btn btn-outline" onclick="setNftTab('sell', this)">–ü—Ä–æ–¥–∞—Ç—å</button>
          <button class="btn btn-outline" onclick="setNftTab('gift', this)">–ü–æ–¥–∞—Ä–∏—Ç—å</button>
        </div>

        <div id="tab-equip" style="margin-top:10px">
          <div style="color:#a9a9a9">–ù–∞–¥–µ—Ç—å/—Å–Ω—è—Ç—å, –æ—Å–º–æ—Ç—Ä–µ—Ç—å 3D (–ø—Å–µ–≤–¥–æ-3D)</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-sm" onclick="toggleEquip()">–ù–∞–¥–µ—Ç—å/–°–Ω—è—Ç—å</button>
            <button class="btn btn-sm btn-outline" onclick="returnToShop()">–í–µ—Ä–Ω—É—Ç—å –≤ —à–æ–ø</button>
          </div>
        </div>

        <div id="tab-sell" style="display:none;margin-top:10px">
          <div style="color:#a9a9a9">–°–∂–µ—á—å (—á–∞—Å—Ç—å —Ü–µ–Ω—ã) / –≤—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –±–∏—Ä–∂—É</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-sm btn-danger" onclick="sellSystem()">–°–∂–µ—á—å</button>
            <input id="p2p-price" placeholder="–¶–µ–Ω–∞ –¥–ª—è –±–∏—Ä–∂–∏" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
            <button class="btn btn-sm" onclick="sellP2P()">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
          </div>
        </div>

        <div id="tab-gift" style="display:none;margin-top:10px">
          <div style="color:#a9a9a9">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –¥—Ä—É–≥–æ–º—É –∏–≥—Ä–æ–∫—É</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="gift-nick" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
            <button class="btn btn-sm" onclick="sendGift()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
        </div>

      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-outline" onclick="closeModal('nft-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Boost modal -->
<div id="boost-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 style="margin:0 0 8px">–ü—Ä–æ–∫–∞—á–∫–∞</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
        <div><b>–ú—É–ª—å—Ç–∏-—Ç–∞–ø</b><br><span class="kv">–£—Ä. <span id="tap-lvl">1</span></span></div>
        <button class="btn-sm btn-outline" onclick="buyTap()">+1 (<span id="tap-cost">100</span>)</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
        <div><b>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞</b><br><span class="kv">–£—Ä. <span id="crit-lvl">1</span></span></div>
        <button class="btn-sm btn-outline" onclick="buyCrit()">+1% (<span id="crit-cost">500</span>)</button>
      </div>
      <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
        <div><b>–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏</b><br><span class="kv">–£—Ä. <span id="regen-lvl">1</span></span></div>
        <button class="btn-sm btn-outline" onclick="buyRegen()">+0.2/—Å (<span id="regen-cost">300</span>)</button>
      </div>
      <button class="btn btn-outline" onclick="closeModal('boost-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Admin modal -->
<div id="admin-modal" class="modal-overlay">
  <div class="modal-box">
    <h3 class="modal-title" style="color:var(--danger)">GOD MODE</h3>
    <input id="adm-target" placeholder="–ù–∏–∫ / Item" style="width:100%;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff;margin:8px 0">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn btn-sm" onclick="adminUnban()">–†–ê–ó–ë–ê–ù</button>
      <button class="btn btn-sm btn-gold" onclick="adminGiveSelf()">–í–´–î–ê–¢–¨ –°–ï–ë–ï</button>
      <button class="btn btn-sm btn-danger" onclick="adminBan()">–ë–ê–ù</button>
      <button class="btn btn-sm btn-outline" onclick="adminAddShop()">+ –í –®–û–ü</button>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px">
      <button class="btn btn-outline" onclick="closeModal('admin-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Hidden P2P holder -->
<div id="p2p-holder" style="display:none"></div>

<!-- NAVBAR (bottom) -->
<div class="navbar">
  <div class="nav-item active" onclick="showScreen('home', this)"><i class="ri-home-5-line"></i><div>–î–æ–º</div></div>
  <div class="nav-item" onclick="showScreen('shop', this)"><i class="ri-store-2-line"></i><div>–®–æ–ø</div></div>
  <div class="nav-item" onclick="showScreen('casino', this)"><i class="ri-gamepad-line"></i><div>–ò–≥—Ä—ã</div></div>
  <div class="nav-item" onclick="showScreen('profile', this)"><i class="ri-user-settings-line"></i><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
</div>

<!-- PART 1 SCRIPT: CONFIG, ASSET GENERATION, COSMETICS, INIT -->
<script>
/* FIREBASE CONFIG - –¢–≤–æ–∏ –∫–ª—é—á–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ) */
const firebaseConfig = {
  apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg",
  authDomain: "nfts-dc174.firebaseapp.com",
  projectId: "nfts-dc174",
  storageBucket: "nfts-dc174.firebasestorage.app",
  messagingSenderId: "327365720624",
  appId: "1:327365720624:web:eb42c9d671566b5d118bf5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* CDN base for emoji icons */
const BASE_URL = "https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis";

/* Utils */
function pad(n, len=5){ return (''+n).padStart(len,'0'); }
function toast(msg){ const t=document.getElementById('toast'); t.innerText = msg; t.style.display='block'; setTimeout(()=>t.style.display='none',2200); }
function safeURL(u){ try { return BASE_URL + u; } catch { return 'https://via.placeholder.com/120?text=NFT'; } }

/* Build 120+ glossy-style assets programmatically (IDs 00001.. ) */
const basePalette = [
  ["Rocket","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Rocket.png"],
  ["Crown","–†–æ—Å–∫–æ—à—å","/Objects/Crown.png"],
  ["Gem","–†–æ—Å–∫–æ—à—å","/Objects/Gem%20Stone.png"],
  ["Money","–†–æ—Å–∫–æ—à—å","/Objects/Money%20Bag.png"],
  ["Dragon","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Dragon.png"],
  ["Unicorn","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Unicorn.png"],
  ["Burger","–ï–¥–∞","/Food/Hamburger.png"],
  ["Pizza","–ï–¥–∞","/Food/Pizza.png"],
  ["Cat","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Cat%20Face.png"],
  ["Laptop","–¢–µ—Ö–Ω–æ","/Objects/Laptop.png"],
  ["Fire","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Travel%20and%20places/Fire.png"],
  ["Ghost","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Smilies/Ghost.png"],
  ["Car","–ê–≤—Ç–æ","/Travel%20and%20places/Automobile.png"],
  ["Plane","–ê–≤—Ç–æ","/Travel%20and%20places/Airplane.png"],
  ["UFO","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Flying%20Saucer.png"],
  ["Book","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Book.png"],
  ["Phone","–¢–µ—Ö–Ω–æ","/Objects/Smartphone.png"],
  ["Key","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Key.png"],
  ["Shield","–ë–æ–µ–≤—ã–µ","/Objects/Shield.png"],
  ["Sword","–ë–æ–µ–≤—ã–µ","/Objects/Sword.png"]
];

let ASSETS = [];
let idCounter = 1;
for(let round=0; round<7; round++){
  basePalette.forEach((b, idx)=>{
    if(idCounter > 120) return;
    const name = `${b[0]} ${round>0?round:''}`.trim();
    // base price: start 100k + random supricing, multiply to be "hardcore"
    const basePrice = 100000 + Math.floor(Math.random()*2000000) + idx*5000 + round*3000;
    const supply = 100 + Math.floor(Math.random()*900); // between 100..1000
    ASSETS.push({
      id: pad(idCounter,5),
      n: name,
      t: b[1],
      u: b[2],
      p: basePrice,
      l: supply
    });
    idCounter++;
  });
}
// ensure at least 120
while(ASSETS.length < 120){
  const b = basePalette[Math.floor(Math.random()*basePalette.length)];
  ASSETS.push({
    id: pad(idCounter,5),
    n: b[0] + ' X',
    t: b[1],
    u: b[2],
    p: 100000 + Math.floor(Math.random()*1000000),
    l: 200 + Math.floor(Math.random()*800)
  });
  idCounter++;
}

/* COSMETICS */
const COSMETICS = {
  colors:[
    {id:'nick_def',name:'Default',hex:'#ffffff',cost:0},
    {id:'nick_gold',name:'Gold',hex:'#fbbf24',cost:250000},
    {id:'nick_neon',name:'Neon',hex:'#00f2ff',cost:150000},
    {id:'nick_red',name:'Red',hex:'#ff6b6b',cost:100000},
    {id:'nick_purple',name:'Purple',hex:'#d946ef',cost:120000}
  ],
  frames:[
    {id:'frame_def',name:'Default',cls:'',cost:0},
    {id:'frame_gold',name:'Gold',cls:'frame-gold',cost:500000},
    {id:'frame_neon',name:'Neon',cls:'frame-neon',cost:350000},
    {id:'frame_red',name:'Red',cls:'frame-red',cost:200000},
    {id:'frame_purple',name:'Purple',cls:'frame-purple',cost:250000}
  ]
};

/* STATE */
let myNick = localStorage.getItem('nft_nick') || sessionStorage.getItem('nft_nick') || null;
let data = null; // user doc data
let globalStats = {}; // from game/stats.items
let pendingBuy = null;
let selIdx = null;
let clickQueue = [];
let warnings = 0;

/* Color mapping for classes */
const COLOR_MAP = { nick_def:'', nick_gold:'nick-gold', nick_neon:'nick-neon', nick_red:'nick-red', nick_purple:'nick-purple' };

/* Ensure stats doc exists (prevents "update non-existent document" errors) */
(async function ensureStats(){
  try {
    const statsRef = db.collection('game').doc('stats');
    const s = await statsRef.get();
    if(!s.exists){ await statsRef.set({ items: {} }); console.log("Created game/stats"); }
  } catch(e){ console.error("stats init err", e); }
})();

/* INIT session if logged */
if(myNick){
  document.getElementById('auth-modal').style.display='none';
  startSession();
} else {
  document.getElementById('auth-modal').style.display='flex';
}

/* AUTH functions (register/login) */
let isReg = false;
function toggleAuth(){ isReg = !isReg; document.getElementById('auth-title').innerText = isReg ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥"; }
async function submitAuth(){
  const nick = document.getElementById('auth-nick').value.trim();
  const pass = document.getElementById('auth-pass').value.trim();
  const remember = document.getElementById('remember-me').checked;
  if(nick.length < 3 || pass.length < 4){ document.getElementById('auth-error').innerText = "–ö–æ—Ä–æ—Ç–∫–∏–µ –¥–∞–Ω–Ω—ã–µ"; return; }
  const ref = db.collection('users').doc(nick);
  try {
    const doc = await ref.get();
    if(isReg){
      if(doc.exists){ document.getElementById('auth-error').innerText = "–ù–∏–∫ –∑–∞–Ω—è—Ç"; return; }
      const u = {
        password: pass,
        nickname: nick,
        balance: 5000000,
        energy: 100,
        inventory: [],
        friends: [],
        equipped: [],
        tapLvl: 1,
        critLvl: 1,
        regenLvl: 1,
        owned_colors: ['nick_def'],
        owned_frames: ['frame_def'],
        active_color: 'nick_def',
        active_frame: 'frame_def',
        isBanned: false,
        warnings: 0,
        createdAt: Date.now()
      };
      await ref.set(u);
      if(remember) localStorage.setItem('nft_nick', nick); else sessionStorage.setItem('nft_nick', nick);
      myNick = nick; document.getElementById('auth-modal').style.display='none'; startSession();
    } else {
      if(!doc.exists || doc.data().password !== pass){ document.getElementById('auth-error').innerText = "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å"; return; }
      if(doc.data().isBanned){ showBanScreen(nick); return; }
      if(remember) localStorage.setItem('nft_nick', nick); else sessionStorage.setItem('nft_nick', nick);
      myNick = nick; document.getElementById('auth-modal').style.display='none'; startSession();
    }
  } catch(e){ document.getElementById('auth-error').innerText = e.toString(); }
}

/* Start session: listen to user doc and stats */
function startSession(){
  if(!myNick) return;
  document.getElementById('user-id').innerText = myNick;
  db.collection('users').doc(myNick).onSnapshot(snap=>{
    if(!snap.exists){ logout(); return; }
    data = snap.data();
    if(data.isBanned){ showBanScreen(myNick); return; }
    // ensure defaults
    data.owned_colors = data.owned_colors || ['nick_def'];
    data.owned_frames = data.owned_frames || ['frame_def'];
    data.active_color = data.active_color || 'nick_def';
    data.active_frame = data.active_frame || 'frame_def';
    updateUI(); renderInv(); renderCosmetics();
    if(myNick === 'kayivi') document.getElementById('admin-btn').style.display='inline-block';
  });
  db.collection('game').doc('stats').onSnapshot(s=>{
    globalStats = s.exists ? s.data().items || {} : {};
    renderShop();
  });
  // energy: per request, DO NOT auto-regen (no regen loop)
}

/* UI update function (nick, balance, frame) */
function updateUI(){
  if(!data) return;
  document.getElementById('balance').innerText = Math.floor(data.balance || 0).toLocaleString();
  document.getElementById('energy').innerText = Math.floor(data.energy || 0);
  document.getElementById('inv-count').innerText = (data.inventory || []).length;
  const nickEl = document.getElementById('my-nick'); nickEl.innerText = myNick;
  // color
  Object.values(COLOR_MAP).forEach(c=>{ if(c) nickEl.classList.remove(c) });
  const mapped = COLOR_MAP[data.active_color] || '';
  if(mapped) nickEl.classList.add(mapped);
  // frame
  const frameEl = document.getElementById('my-frame');
  frameEl.innerText = myNick[0] ? myNick[0].toUpperCase() : 'U';
  frameEl.className = 'avatar-frame';
  const fobj = COSMETICS.frames.find(f=>f.id === data.active_frame);
  if(fobj && fobj.cls) frameEl.classList.add(fobj.cls);
}

/* Render shop (basic listing) */
function renderShop(){
  const list = document.getElementById('shop-list'); list.innerHTML = '';
  ASSETS.forEach(a=>{
    const sold = globalStats[a.n] || 0;
    const priceMult = 1 + (sold * 0.01); // +1% per sold
    const price = Math.max(100000, Math.floor(a.p * priceMult));
    const remaining = Math.max(0, a.l - sold);
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `
      <div class="supply">${remaining}/${a.l}</div>
      <div class="nft-type">${a.t}</div>
      <div class="nft-plate nft-3d"><img class="nft-img" src="${safeURL(a.u)}" onerror="this.src='https://via.placeholder.com/120?text=NFT'"/></div>
      <div class="nft-name" title="${a.n}">${a.n}</div>
      <div style="display:flex;gap:8px;width:100%;margin-top:8px">
        <div class="price">${price.toLocaleString()} üíé</div>
        <button class="btn btn-sm btn-outline" onclick="reqBuyShop('${a.n}', ${price})" ${remaining<=0?'disabled':''}>–ö—É–ø–∏—Ç—å</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px;width:100%">
        <button class="btn-sm btn-outline" style="flex:1" onclick="viewShopItem('${a.n}')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
      </div>
    `;
    list.appendChild(div);
  });
}

/* Render inventory (home) */
function renderInv(){
  const list = document.getElementById('inventory-list'); list.innerHTML = '';
  (data.inventory || []).forEach((item, idx)=>{
    const isEq = (data.equipped || []).find(e => e.id === item.id);
    const card = document.createElement('div'); card.className='card';
    card.style.background = item.bg || '';
    card.innerHTML = `
      ${isEq?'<div class="equipped-marker"></div>':''}
      <div class="nft-type">${item.type}</div>
      <div class="nft-plate nft-3d"><img class="nft-img" src="${safeURL(item.u)}" onerror="this.src='https://via.placeholder.com/120?text=NFT'"/></div>
      <div class="nft-name">${item.name}</div>
      <div style="display:flex;gap:8px;margin-top:8px;width:100%">
        <button class="btn-sm btn-outline" style="flex:1" onclick="openNft(${idx})">–ú–µ–Ω—é</button>
        <div class="bigid">${pad(idx+1,5)}</div>
      </div>
    `;
    list.appendChild(card);
  });
}

/* Render cosmetics (profile) */
function renderCosmetics(){
  const cl = document.getElementById('style-colors'); cl.innerHTML = '';
  COSMETICS.colors.forEach(c=>{
    const owned = (data.owned_colors || []).includes(c.id);
    const active = data.active_color === c.id;
    const div = document.createElement('div'); div.className = 'card';
    div.innerHTML = `<div style="color:${c.hex};font-weight:800">${c.name}</div><div class="kv">${owned ? (active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ö—É–ø–ª–µ–Ω–æ') : c.cost.toLocaleString()+' üíé'}</div><div style="margin-top:8px"><button class="btn btn-sm ${active?'btn-gold':''}" onclick="${owned?`equipStyle('color','${c.id}')`:`buyStyle('color','${c.id}',${c.cost})`}">${active?'‚úì':'–ö—É–ø–∏—Ç—å'}</button></div>`;
    cl.appendChild(div);
  });
  const fr = document.getElementById('style-frames'); fr.innerHTML = '';
  COSMETICS.frames.forEach(f=>{
    const owned = (data.owned_frames || []).includes(f.id);
    const active = data.active_frame === f.id;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div class="${f.cls}" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:8px">A</div><div class="kv">${owned ? (active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ö—É–ø–ª–µ–Ω–æ') : f.cost.toLocaleString()+' üíé'}</div><div style="margin-top:8px"><button class="btn btn-sm ${active?'btn-gold':''}" onclick="${owned?`equipStyle('frame','${f.id}')`:`buyStyle('frame','${f.id}',${f.cost})`}">${active?'‚úì':'–ö—É–ø–∏—Ç—å'}</button></div>`;
    fr.appendChild(div);
  });
}

/* small helpers for modal / nav */
function openModal(id){ document.getElementById(id).style.display='flex'; }
function closeModal(id){ document.getElementById(id).style.display='none'; }
function showScreen(name, el){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  if(el) el.classList.add('active');
}

/* view shop item using nft-modal (preview) */
function viewShopItem(name){
  const asset = ASSETS.find(a=>a.n === name);
  if(!asset) return;
  const fake = { id: 'shop-'+asset.id, name: asset.n, u: asset.u, serial: 0, p: asset.p, type: asset.t, bg: '', hue: '' };
  document.getElementById('modal-name').innerText = fake.name;
  document.getElementById('modal-img').src = safeURL(fake.u);
  document.getElementById('modal-serial').innerText = `ID ${asset.id}`;
  document.getElementById('modal-type').innerText = fake.type;
  setNftTab('equip');
  openModal('nft-modal');
}

/* Set nft modal tab */
function setNftTab(tab, el){
  ['tab-equip','tab-sell','tab-gift'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('tab-'+tab).style.display='block';
}

/* placeholder functions to be implemented in Part 2 */
function reqBuyShop(name, price){ pendingBuy = { type:'shop', name, price }; document.getElementById('confirm-text').innerText = `–ö—É–ø–∏—Ç—å "${name}" –∑–∞ ${price.toLocaleString()} üíé?`; openModal('confirm-modal'); }
function confirmAction(){ /* implemented in Part 2 */ toast('–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ... (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤–æ 2-–π —á–∞—Å—Ç–∏)'); closeModal('confirm-modal'); }

/* expose some to window for inline onclicks */
window.reqBuyShop = reqBuyShop;
window.viewShopItem = viewShopItem;
window.openNft = function(i){ /* implemented in Part 2 */ toast('–û—Ç–∫—Ä—ã—Ç–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (—Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –≤–æ 2-–π —á–∞—Å—Ç–∏)'); }

/* finish part1 script */
</script>
<!-- END PART 1 -->
<script>
/* ===========================================================
   PART 2 ‚Äî FULL LOGIC
=========================================================== */

/* --- Open NFT modal from inventory --- */
window.openNft = function(i){
  selIdx = i;
  const it = data.inventory[i];
  if(!it) return toast("–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞");

  document.getElementById('modal-name').innerText = it.name;
  document.getElementById('modal-img').src = safeURL(it.u);
  document.getElementById('modal-serial').innerText = "ID " + it.id;
  document.getElementById('modal-type').innerText = it.type;

  setNftTab("equip");
  openModal("nft-modal");
};

/* --- Equip/unequip item --- */
window.toggleEquip = async function(){
  const it = data.inventory[selIdx];
  if(!it) return;

  const eq = data.equipped || [];
  const exists = eq.find(x=>x.id === it.id);

  if(exists){
    await db.collection("users").doc(myNick).update({
      equipped: eq.filter(x=>x.id !== it.id)
    });
    toast("–°–Ω—è—Ç–æ");
  } else {
    eq.push(it);
    await db.collection("users").doc(myNick).update({ equipped: eq });
    toast("–ù–∞–¥–µ—Ç–æ");
  }
};

/* --- Return item to shop --- */
window.returnToShop = async function(){
  const it = data.inventory[selIdx];
  if(!it) return;

  const inv = data.inventory.filter((x,idx)=>idx!==selIdx);
  const eq  = (data.equipped||[]).filter(x=>x.id !== it.id);

  await db.collection('users').doc(myNick).update({
    inventory: inv,
    equipped: eq
  });

  toast("–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ —à–æ–ø (–±–µ–∑ –≤–æ–∑–º–µ—â–µ–Ω–∏—è)");
  closeModal("nft-modal");
};

/* --- Sell System (burn) --- */
window.sellSystem = async function(){
  const it = data.inventory[selIdx];
  if(!it) return;

  const refund = Math.floor((it.basePrice || 100000)/3);

  const inv = data.inventory.filter((x,idx)=>idx!==selIdx);
  const eq  = (data.equipped||[]).filter(x=>x.id !== it.id);

  await db.collection("users").doc(myNick).update({
    balance: (data.balance||0) + refund,
    inventory: inv,
    equipped: eq
  });

  toast("–°–æ–∂–∂–µ–Ω–æ +" + refund.toLocaleString());
  closeModal("nft-modal");
};

/* --- Sell P2P (put on market) --- */
window.sellP2P = async function(){
  const it = data.inventory[selIdx];
  if(!it) return;

  const price = parseInt(document.getElementById("p2p-price").value);
  if(isNaN(price) || price<1000) return toast("–ú–∏–Ω–∏–º—É–º 1 000");

  const doc = it.id+"_P2P";
  await db.collection("market").doc(doc).set({
    seller: myNick,
    item: it,
    price: price,
    placedAt: Date.now()
  });

  toast("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ P2P");
};

/* --- Gift item to friend --- */
window.sendGift = async function(){
  const it = data.inventory[selIdx];
  if(!it) return;

  const nick = document.getElementById("gift-nick").value.trim();
  if(!nick) return toast("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");

  if(nick === myNick) return toast("–°–∞–º–æ–º—É —Å–µ–±–µ –Ω–µ–ª—å–∑—è");

  const target = await db.collection("users").doc(nick).get();
  if(!target.exists) return toast("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω");

  let inv1 = data.inventory.filter((x,idx)=>idx!==selIdx);
  let eq1 = (data.equipped||[]).filter(x=>x.id !== it.id);

  await db.collection("users").doc(myNick).update({
    inventory: inv1,
    equipped: eq1
  });

  const ti = target.data().inventory || [];
  ti.push(it);

  await db.collection("users").doc(nick).update({
    inventory: ti
  });

  toast("–ü–æ–¥–∞—Ä–µ–Ω–æ –∏–≥—Ä–æ–∫—É " + nick);
  closeModal("nft-modal");
};

/* --- Buy item from shop --- */
window.confirmAction = async function(){
  if(!pendingBuy) return;

  const { name, price } = pendingBuy;

  const asset = ASSETS.find(a=>a.n === name);
  if(!asset) return toast("–û—à–∏–±–∫–∞ —Ç–æ–≤–∞—Ä–∞");

  if(data.balance < price){
    toast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ üíé");
    closeModal("confirm-modal");
    return;
  }

  await db.runTransaction(async t=>{
    const me = db.collection("users").doc(myNick);
    const stats = db.collection("game").doc("stats");

    const meDoc = await t.get(me);
    const sDoc = await t.get(stats);

    const d = meDoc.data();
    const g = sDoc.data();

    const sold = g.items[name] || 0;
    if(sold >= asset.l) throw "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";

    t.update(me,{
      balance: d.balance - price,
      inventory: [...(d.inventory||[]), {
        id: Date.now(),
        name: asset.n,
        type: asset.t,
        u: asset.u,
        serial: sold+1,
        basePrice: asset.p
      }]
    });

    t.update(stats,{
      [`items.${name}`]: sold+1
    });
  });

  toast("–ö—É–ø–ª–µ–Ω–æ!");
  closeModal("confirm-modal");
  pendingBuy = null;
};

/* --- BUY STYLE (color or frame) --- */
window.buyStyle = async function(type,id,cost){
  if(data.balance < cost) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");

  if(type === 'color'){
    await db.collection("users").doc(myNick).update({
      balance: data.balance - cost,
      owned_colors: [...data.owned_colors, id]
    });
  } else {
    await db.collection("users").doc(myNick).update({
      balance: data.balance - cost,
      owned_frames: [...data.owned_frames, id]
    });
  }
  toast("–ö—É–ø–ª–µ–Ω–æ");
};

/* --- Equip Style --- */
window.equipStyle = async function(type,id){
  if(type==='color')
    await db.collection("users").doc(myNick).update({ active_color:id });
  else
    await db.collection("users").doc(myNick).update({ active_frame:id });

  toast("–ü—Ä–∏–º–µ–Ω–µ–Ω–æ");
};

/* --- Boosts --- */
window.buyTap = async function(){
  const cost = (data.tapLvl||1)*100;
  if(data.balance < cost) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");
  await db.collection("users").doc(myNick).update({
    balance: data.balance - cost,
    tapLvl: (data.tapLvl||1)+1
  });
};
window.buyCrit = async function(){
  const cost = (data.critLvl||1)*500;
  if(data.balance < cost) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");
  await db.collection("users").doc(myNick).update({
    balance: data.balance - cost,
    critLvl: (data.critLvl||1)+1
  });
};
window.buyRegen = async function(){
  const cost = (data.regenLvl||1)*300;
  if(data.balance < cost) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");
  await db.collection("users").doc(myNick).update({
    balance: data.balance - cost,
    regenLvl: (data.regenLvl||1)+1
  });
  toast("–†–µ–≥–µ–Ω –∫—É–ø–ª–µ–Ω (–Ω–æ –æ—Ç–∫–ª—é—á—ë–Ω)");
};

/* --- Admin Panel --- */
window.adminBan = async function(){
  const n = document.getElementById("adm-target").value.trim();
  if(!n) return toast("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
  await db.collection("users").doc(n).update({ isBanned:true });
  toast("–ó–∞–±–∞–Ω–µ–Ω");
};
window.adminUnban = async function(){
  const n = document.getElementById("adm-target").value.trim();
  if(!n) return toast("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫");
  await db.collection("users").doc(n).update({ isBanned:false });
  toast("–†–∞–∑–±–∞–Ω–µ–Ω");
};
window.adminGiveSelf = async function(){
  const item = document.getElementById("adm-target").value.trim();
  if(!item) return toast("–ù–∞–∑–≤–∞–Ω–∏–µ?");
  const asset = ASSETS.find(a=>a.n===item);
  if(!asset) return toast("–ù–µ—Ç—É —Ç–∞–∫–æ–≥–æ");
  const inv = data.inventory || [];
  inv.push({
    id: Date.now(),
    name: asset.n,
    type: asset.t,
    u: asset.u,
    serial: 999,
    basePrice: asset.p
  });
  await db.collection("users").doc(myNick).update({ inventory:inv });
  toast("–í—ã–¥–∞–Ω–æ");
};
window.adminAddShop = async function(){
  toast("–í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî —à–æ–ø –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏");
};

/* --- Logout / delete / password --- */
window.logout = function(){
  localStorage.removeItem("nft_nick");
  sessionStorage.removeItem("nft_nick");
  location.reload();
};
window.deleteAcc = async function(){
  await db.collection("users").doc(myNick).delete();
  logout();
};
window.changePass = async function(){
  const p = prompt("–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:");
  if(!p) return;
  await db.collection("users").doc(myNick).update({ password:p });
  toast("–ü–∞—Ä–æ–ª—å —Å–º–µ–Ω—ë–Ω");
};

/* --- AntiCheat: simple tap system (energy drain) --- */


/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CASINO ‚Äî SLOTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const slotSymbols = ["üçí","üçã","üçá","üíé","üçÄ","‚≠ê","7Ô∏è‚É£"];

window.playSlots = async function(){
  let bet = parseInt(document.getElementById("slots-bet").value);
  if(isNaN(bet) || bet<100) return toast("–ú–∏–Ω–∏–º—É–º 100");

  if(data.balance < bet) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");

  await db.collection("users").doc(myNick).update({
    balance: data.balance - bet
  });

  spinAnim("slot1");
  spinAnim("slot2");
  spinAnim("slot3");

  const r1 = rand(slotSymbols);
  const r2 = rand(slotSymbols);
  const r3 = rand(slotSymbols);

  setTimeout(async ()=>{
    document.getElementById("slot1").innerText = r1;
    document.getElementById("slot2").innerText = r2;
    document.getElementById("slot3").innerText = r3;

    let win = 0;
    if(r1===r2 && r2===r3){
      if(r1==="7Ô∏è‚É£") win = bet*50;
      else if(r1==="üíé") win = bet*25;
      else win = bet*10;
    } else if(r1===r2 || r2===r3){
      win = bet*2;
    }

    if(win>0){
      await db.collection("users").doc(myNick).update({
        balance: (data.balance||0) + win
      });
      toast("–í—ã–∏–≥—Ä—ã—à +" + win.toLocaleString());
    } else {
      toast("–ü—Ä–æ–∏–≥—Ä—ã—à");
    }

  },800);
};

function spinAnim(id){
  const el=document.getElementById(id);
  el.style.transition="transform 0.3s";
  el.style.transform="rotateX(360deg)";
  setTimeout(()=>{el.style.transform="none";},300);
}

function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CASINO ‚Äî MINES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let minesActive = false;
let minesField = [];
let minesOpened = 0;

window.startMines = async function(){
  if(minesActive) return toast("–£–∂–µ –∏–¥—ë—Ç –∏–≥—Ä–∞");

  let bet = parseInt(document.getElementById("mines-bet").value);
  if(isNaN(bet) || bet<100) return toast("–ú–∏–Ω–∏–º—É–º 100");
  if(data.balance < bet) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");

  await db.collection("users").doc(myNick).update({
    balance: data.balance - bet
  });

  minesActive = true;
  minesOpened = 0;

  minesField = Array(16).fill("safe");
  let bomb = Math.floor(Math.random()*16);
  minesField[bomb]="bomb";

  renderMines();
};

function renderMines(){
  const f=document.getElementById("mines-field");
  f.innerHTML="";
  minesField.forEach((x,i)=>{
    const d=document.createElement("div");
    d.style.background="#111";
    d.style.borderRadius="8px";
    d.style.height="60px";
    d.style.display="flex";
    d.style.alignItems="center";
    d.style.justifyContent="center";
    d.style.cursor="pointer";
    d.onclick=()=>openMine(i);
    f.appendChild(d);
  });
}

async function openMine(i){
  if(!minesActive) return;

  const f=document.getElementById("mines-field").children[i];

  if(minesField[i]==="bomb"){
    f.innerText="üí£";
    f.style.background="#400";
    minesActive=false;
    toast("–ë–æ–º–±–∞ ‚Äî –ø—Ä–æ–∏–≥—Ä—ã—à");
    return;
  }

  f.innerText="üíé";
  f.style.background="#063";
  minesField[i]="open";
  minesOpened++;

  let reward = 200 * minesOpened;
  await db.collection("users").doc(myNick).update({
    balance:(data.balance||0)+reward
  });

  toast("+"+reward);
}

/* ===========================================================
   END PART 2
=========================================================== */
</script>
</body>
</html>



