<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Market Empire</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg: #09090b;
            --panel: #18181b;
            --primary: #f59e0b; /* Orange/Gold */
            --accent: #6366f1;  /* Indigo */
            --danger: #ef4444;
            --success: #22c55e;
            --text: #e4e4e7;
            --radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 0;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden; user-select: none;
        }

        /* === UI –ö–û–ú–ü–û–ù–ï–ù–¢–´ === */
        button { border: none; outline: none; cursor: pointer; font-family: inherit; transition: 0.2s; font-weight: bold; }
        button:active { transform: scale(0.96); }

        .header {
            padding: 15px; background: rgba(24, 24, 27, 0.95);
            border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; z-index: 50;
        }
        .balance { font-size: 18px; color: var(--primary); }

        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .screen { display: none; animation: fade 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card {
            background: var(--panel); border-radius: var(--radius); padding: 10px;
            border: 1px solid #333; position: relative; display: flex; flex-direction: column;
        }

        .btn { background: var(--primary); color: #000; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
        .btn-outline { background: transparent; border: 1px solid #444; color: #ccc; }
        .btn-sm { padding: 4px 8px; font-size: 12px; width: auto; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: black; }

        /* –í–•–û–î / MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            width: 100%; max-width: 350px; background: var(--panel);
            padding: 20px; border-radius: 20px; border: 1px solid #444; text-align: center;
        }
        input {
            background: #27272a; border: 1px solid #444; padding: 12px;
            border-radius: 8px; color: #fff; width: 100%; margin-bottom: 10px; font-size: 16px; outline: none;
        }

        /* TAB SWITCHER (MARKET) */
        .tab-switcher { display: flex; background: #222; border-radius: 10px; padding: 4px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; border-radius: 8px; background: transparent; color: #888; font-size: 13px; }
        .tab-btn.active { background: #333; color: white; }

        /* NFT VISUALS */
        .nft-preview {
            width: 100%; aspect-ratio: 1; border-radius: 8px; margin-bottom: 8px;
            background-size: 150%; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .rarity-tag {
            position: absolute; top: 5px; right: 5px; font-size: 10px; padding: 2px 6px;
            border-radius: 4px; background: rgba(0,0,0,0.8); color: white;
        }

        /* NAVIGATION */
        .navbar {
            position: fixed; bottom: 0; width: 100%; background: #111;
            display: flex; border-top: 1px solid #333; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { flex: 1; padding: 12px 0; text-align: center; font-size: 10px; color: #666; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 3px; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 8px 16px; border-radius: 20px; z-index: 2000;
            display: none; border: 1px solid #555; font-size: 14px;
        }
    </style>
</head>
<body>

    <!-- –ú–û–î–ê–õ–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò -->
    <div id="auth-modal" class="modal-overlay" style="display: flex;">
        <div class="modal-box">
            <h2 id="auth-title">–í—Ö–æ–¥</h2>
            <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="submitAuth()">–ü–æ–µ—Ö–∞–ª–∏</button>
            <p onclick="toggleAuth()" style="margin-top:15px; font-size:12px; color:#888; text-decoration:underline;">–°–º–µ–Ω–∏—Ç—å –Ω–∞ –í—Ö–æ–¥/–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</p>
            <p id="auth-error" style="color:var(--danger); font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê –ü–†–û–î–ê–ñ–ò (–í–´–ë–û–†) -->
    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>–ü—Ä–æ–¥–∞–∂–∞ NFT</h3>
            <div class="nft-preview" id="sell-preview"></div>
            <p id="sell-name" style="margin-bottom: 15px; color:#aaa;"></p>
            
            <div style="display:flex; flex-direction:column; gap:10px;">
                <!-- 1. –ü–†–û–î–ê–¢–¨ –°–ò–°–¢–ï–ú–ï -->
                <button class="btn btn-outline" onclick="sellToSystem()">
                    ‚ö° –°–ª–∏—Ç—å –°–∏—Å—Ç–µ–º–µ <br>
                    <span style="font-size:12px; color:var(--success)">+<span id="system-price">0</span> üí∞</span>
                </button>

                <div style="display:flex; align-items:center; gap:10px; margin: 10px 0;">
                    <hr style="flex:1; border-color:#333;"> <span style="font-size:12px; color:#555">–ò–õ–ò</span> <hr style="flex:1; border-color:#333;">
                </div>

                <!-- 2. –ü–†–û–î–ê–¢–¨ –ò–ì–†–û–ö–£ -->
                <input type="number" id="market-price-input" placeholder="–í–∞—à–∞ —Ü–µ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤">
                <button class="btn" onclick="sellToMarket()">üì¢ –ù–∞ –ë–∏—Ä–∂—É</button>
            </div>
            <button class="btn btn-danger" style="margin-top:15px;" onclick="closeSellModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –£–í–ï–î–û–ú–õ–ï–ù–ò–ï -->
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <!-- HEADER -->
    <div class="header">
        <div style="font-size:13px; color:#888;">üë§ <span id="my-nick">...</span></div>
        <div class="balance"><span id="balance">0</span> üí∞</div>
    </div>

    <!-- CONTENT -->
    <div class="content">

        <!-- –î–û–ú (–ö–õ–ò–ö–ï–† + –ò–ù–í–ï–ù–¢–ê–†–¨) -->
        <div id="tab-home" class="screen active">
            <div style="display:flex; justify-content:center; padding: 20px;">
                <div class="card" style="border-radius:50%; width:200px; height:200px; justify-content:center; align-items:center; cursor:pointer; border: 4px solid #fff; box-shadow: 0 0 30px rgba(255,165,0,0.2); background: radial-gradient(circle, #f59e0b, #b45309);" id="tap-btn">
                    <span style="font-size:60px;">‚Çø</span>
                </div>
            </div>
            <div style="text-align:center; margin-bottom:20px; font-size:12px; color:#666;">
                –≠–Ω–µ—Ä–≥–∏—è: <span id="energy">1000</span>
            </div>

            <h3 style="margin-bottom:10px;">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
            <div class="grid" id="inventory-list"></div>
        </div>

        <!-- –†–´–ù–û–ö (–ú–ê–ì–ê–ó–ò–ù + –ë–ò–†–ñ–ê) -->
        <div id="tab-market" class="screen">
            <div class="tab-switcher">
                <button class="tab-btn active" onclick="switchMarket('shop')" id="btn-shop">üè™ –ú–∞–≥–∞–∑–∏–Ω (–°–∏—Å—Ç–µ–º–∞)</button>
                <button class="tab-btn" onclick="switchMarket('p2p')" id="btn-p2p">üåç –ë–∏—Ä–∂–∞ (–ò–≥—Ä–æ–∫–∏)</button>
            </div>

            <!-- –ú–∞–≥–∞–∑–∏–Ω –°–∏—Å—Ç–µ–º—ã -->
            <div id="view-shop">
                <div class="card">
                    <div style="font-size:30px; margin-bottom:5px;">üì¶</div>
                    <h3>–ë–∞–∑–æ–≤—ã–π –ë–æ–∫—Å</h3>
                    <p style="font-size:12px; color:#888;">–®–∞–Ω—Å –Ω–∞ –û–±—ã—á–Ω—ã–π –∏ –†–µ–¥–∫–∏–π</p>
                    <button class="btn" onclick="buySystemBox('basic', 100)">–ö—É–ø–∏—Ç—å –∑–∞ 100üí∞</button>
                </div>
                <div class="card" style="margin-top:10px; border-color: gold;">
                    <div style="font-size:30px; margin-bottom:5px;">üåü</div>
                    <h3>–ü—Ä–µ–º–∏—É–º –ë–æ–∫—Å</h3>
                    <p style="font-size:12px; color:#888;">–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π —à–∞–Ω—Å –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–≥–æ</p>
                    <button class="btn btn-outline" style="color:gold; border-color:gold;" onclick="buySystemBox('premium', 1000)">–ö—É–ø–∏—Ç—å –∑–∞ 1000üí∞</button>
                </div>
            </div>

            <!-- –ë–∏—Ä–∂–∞ –ò–≥—Ä–æ–∫–æ–≤ -->
            <div id="view-p2p" style="display:none;">
                <button class="btn-sm btn-outline" onclick="loadP2PMarket()" style="width:100%; margin-bottom:10px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                <div class="grid" id="market-list">
                    <p style="color:#666; width:200%;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>

        <!-- –ö–ê–ó–ò–ù–û -->
        <div id="tab-casino" class="screen">
            <h2>üé∞ –°–ª–æ—Ç—ã 777</h2>
            <div class="card" style="text-align:center; padding:30px;">
                <div style="font-size:40px; letter-spacing:10px; margin-bottom:20px;" id="slots-res">üçí üçí üçí</div>
                <input type="number" id="slot-bet" placeholder="–°—Ç–∞–≤–∫–∞" style="text-align:center;">
                <button class="btn" onclick="spinSlots()">–ö—Ä—É—Ç–∏—Ç—å (x5)</button>
            </div>
        </div>

    </div>

    <!-- NAVBAR -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home')"><span class="nav-icon">üè†</span>–î–æ–º</div>
        <div class="nav-item" onclick="nav('market')"><span class="nav-icon">üõí</span>–¢–æ—Ä–≥–æ–≤–ª—è</div>
        <div class="nav-item" onclick="nav('casino')"><span class="nav-icon">üé∞</span>–ò–≥—Ä—ã</div>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg",
            authDomain: "nfts-dc174.firebaseapp.com",
            projectId: "nfts-dc174",
            storageBucket: "nfts-dc174.firebasestorage.app",
            messagingSenderId: "327365720624",
            appId: "1:327365720624:web:eb42c9d671566b5d118bf5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // === –î–ê–ù–ù–´–ï ===
        let myUid = null;
        let myData = null;
        let isRegMode = false;
        let selectedNftIndex = null; // –î–ª—è –º–æ–¥–∞–ª–∫–∏ –ø—Ä–æ–¥–∞–∂–∏

        // === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
        auth.onAuthStateChanged(user => {
            if (user) {
                myUid = user.uid;
                document.getElementById('auth-modal').style.display = 'none';
                initGame();
            } else {
                document.getElementById('auth-modal').style.display = 'flex';
            }
        });

        function toggleAuth() {
            isRegMode = !isRegMode;
            document.getElementById('auth-title').innerText = isRegMode ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
        }

        async function submitAuth() {
            const nick = document.getElementById('auth-nick').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const email = `${nick.replace(/[^a-z0-9]/gi, '')}@nfts.game`.toLowerCase();
            const err = document.getElementById('auth-error');

            if(pass.length < 6) return err.innerText = "–ü–∞—Ä–æ–ª—å –º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤";

            try {
                if (isRegMode) {
                    const snap = await db.collection('users').where('nickname', '==', nick).get();
                    if (!snap.empty) throw "–ù–∏–∫ –∑–∞–Ω—è—Ç!";
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(cred.user.uid).set({
                        nickname: nick, balance: 500, energy: 1000, inventory: [], createdAt: Date.now()
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch (e) {
                err.innerText = e.message;
            }
        }

        // === –ò–ì–†–ê ===
        function initGame() {
            db.collection('users').doc(myUid).onSnapshot(doc => {
                if(doc.exists) {
                    myData = doc.data();
                    updateUI();
                    renderInventory();
                }
            });
            loadP2PMarket();
        }

        function updateUI() {
            if(!myData) return;
            document.getElementById('balance').innerText = Math.floor(myData.balance);
            document.getElementById('energy').innerText = Math.floor(myData.energy);
            document.getElementById('my-nick').innerText = myData.nickname;
        }

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø NFT ---
        function generateNFT(tier) {
            const r = Math.random();
            let rarity = "Common";
            if (tier === 'basic') {
                if (r > 0.9) rarity = "Rare";
            } else if (tier === 'premium') {
                if (r > 0.6) rarity = "Rare";
                if (r > 0.9) rarity = "Legendary";
            } else {
                // –°–ª—É—á–∞–π–Ω—ã–π –¥—Ä–æ–ø —Å –∫–ª–∏–∫–∞ (–æ—á–µ–Ω—å —Ä–µ–¥–∫–∏–π)
                 if (r > 0.99) rarity = "Legendary";
                 else if (r > 0.9) rarity = "Rare";
            }

            return {
                id: Date.now() + "_" + Math.floor(Math.random()*10000),
                seed: Math.floor(Math.random() * 1000000),
                rarity: rarity,
                basePrice: rarity === 'Legendary' ? 2000 : (rarity === 'Rare' ? 400 : 50)
            };
        }

        function getGradient(seed, rarity) {
            const h1 = seed % 360; const h2 = (seed * 2) % 360;
            let c = `hsl(${h1},70%,50%), hsl(${h2},70%,30%)`;
            if (rarity==='Legendary') c += ', gold';
            return `linear-gradient(135deg, ${c})`;
        }

        function getRarityColor(r) {
            if(r==='Legendary') return '#FFD700'; // Gold
            if(r==='Rare') return '#9370DB'; // Purple
            return '#A9A9A9'; // Grey
        }

        // --- –ö–õ–ò–ö–ï–† ---
        document.getElementById('tap-btn').addEventListener('click', (e) => {
            if (myData.energy < 1) { showToast("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!"); return; }
            
            myData.balance += 1;
            myData.energy -= 1;
            
            // 0.5% —à–∞–Ω—Å –Ω–∞–π—Ç–∏ NFT
            if (Math.random() < 0.005) {
                const nft = generateNFT('basic');
                myData.inventory.push(nft);
                showToast(`üéÅ –ù–ê–ô–î–ï–ù NFT: ${nft.rarity}!`);
            }

            if (myData.balance % 10 === 0) saveGame();
            updateUI();
            
            // –≠—Ñ—Ñ–µ–∫—Ç
            const el = document.createElement('div');
            el.innerText = "+1"; el.style.position='absolute'; 
            el.style.left=e.clientX+'px'; el.style.top=e.clientY+'px';
            el.style.color='white'; el.style.pointerEvents='none';
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 500);
        });

        setInterval(() => {
            if(myData && myData.energy < 1000) {
                myData.energy = Math.min(1000, myData.energy + 5);
                updateUI();
            }
        }, 1000);

        function saveGame() {
            db.collection('users').doc(myUid).update({
                balance: myData.balance, energy: myData.energy, inventory: myData.inventory
            });
        }

        // --- –ò–ù–í–ï–ù–¢–ê–†–¨ –ò –ü–†–û–î–ê–ñ–ê ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            myData.inventory.forEach((nft, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="nft-preview" style="background:${getGradient(nft.seed, nft.rarity)}">
                        <span class="rarity-tag" style="background:${getRarityColor(nft.rarity)}">${nft.rarity}</span>
                    </div>
                    <button class="btn btn-sm" onclick="openSellModal(${i})">–ü—Ä–æ–¥–∞—Ç—å / –û–±–º–µ–Ω—è—Ç—å</button>
                `;
                list.appendChild(div);
            });
        }

        function openSellModal(index) {
            selectedNftIndex = index;
            const nft = myData.inventory[index];
            const modal = document.getElementById('sell-modal');
            
            // –†–µ–Ω–¥–µ—Ä –ø—Ä–µ–≤—å—é –≤ –º–æ–¥–∞–ª–∫–µ
            document.getElementById('sell-preview').style.background = getGradient(nft.seed, nft.rarity);
            document.getElementById('sell-name').innerText = `–†–µ–¥–∫–æ—Å—Ç—å: ${nft.rarity}`;
            
            // –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã —Å–∏—Å—Ç–µ–º—ã (50% –æ—Ç –±–∞–∑–æ–≤–æ–π)
            const sysPrice = Math.floor(nft.basePrice * 0.5);
            document.getElementById('system-price').innerText = sysPrice;
            
            modal.style.display = 'flex';
        }

        function closeSellModal() {
            document.getElementById('sell-modal').style.display = 'none';
        }

        // 1. –ü–†–û–î–ê–ñ–ê –°–ò–°–¢–ï–ú–ï (–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ)
        async function sellToSystem() {
            if (selectedNftIndex === null) return;
            const nft = myData.inventory[selectedNftIndex];
            const price = Math.floor(nft.basePrice * 0.5);

            myData.inventory.splice(selectedNftIndex, 1);
            myData.balance += price;

            await saveGame();
            closeSellModal();
            showToast(`–ü—Ä–æ–¥–∞–Ω–æ —Å–∏—Å—Ç–µ–º–µ –∑–∞ ${price} üí∞`);
        }

        // 2. –ü–†–û–î–ê–ñ–ê –ò–ì–†–û–ö–ê–ú (–ù–∞ –±–∏—Ä–∂—É)
        async function sellToMarket() {
            const priceInput = document.getElementById('market-price-input');
            const price = parseInt(priceInput.value);
            
            if (!price || price < 1) { showToast("–í–≤–µ–¥–∏—Ç–µ –Ω–æ—Ä–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É"); return; }
            
            const nft = myData.inventory[selectedNftIndex];

            // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: —É–¥–∞–ª–∏—Ç—å —É —Å–µ–±—è, –¥–æ–±–∞–≤–∏—Ç—å –≤ Market
            db.runTransaction(async (t) => {
                const userRef = db.collection('users').doc(myUid);
                const userDoc = await t.get(userRef);
                const currentInv = userDoc.data().inventory;
                
                // –£–¥–∞–ª—è–µ–º
                currentInv.splice(selectedNftIndex, 1);
                
                // –°–æ–∑–¥–∞–µ–º –ª–æ—Ç
                const marketRef = db.collection('market').doc();
                
                t.update(userRef, { inventory: currentInv });
                t.set(marketRef, {
                    sellerId: myUid, sellerName: myData.nickname,
                    price: price, nft: nft, createdAt: Date.now()
                });
            }).then(() => {
                closeSellModal();
                showToast("–õ–æ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ –±–∏—Ä–∂—É!");
                priceInput.value = '';
                loadP2PMarket();
            }).catch(e => showToast("–û—à–∏–±–∫–∞: " + e));
        }

        // --- –ú–ê–ì–ê–ó–ò–ù –ò –†–´–ù–û–ö ---
        function switchMarket(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+type).classList.add('active');
            
            if(type === 'shop') {
                document.getElementById('view-shop').style.display = 'block';
                document.getElementById('view-p2p').style.display = 'none';
            } else {
                document.getElementById('view-shop').style.display = 'none';
                document.getElementById('view-p2p').style.display = 'block';
                loadP2PMarket();
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ —É —Å–∏—Å—Ç–µ–º—ã
        function buySystemBox(tier, cost) {
            if (myData.balance < cost) { showToast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!"); return; }
            
            const newNft = generateNFT(tier);
            myData.balance -= cost;
            myData.inventory.push(newNft);
            
            saveGame();
            showToast(`–ö—É–ø–ª–µ–Ω –±–æ–∫—Å! –í—ã–ø–∞–ª: ${newNft.rarity}`);
            renderInventory();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ P2P —Ä—ã–Ω–∫–∞
        function loadP2PMarket() {
            const list = document.getElementById('market-list');
            db.collection('market').orderBy('createdAt', 'desc').limit(20).get().then(snap => {
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p style="grid-column: span 2; text-align:center;">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</p>'; return; }
                
                snap.forEach(doc => {
                    const data = doc.data();
                    const isMine = data.sellerId === myUid;
                    
                    const div = document.createElement('div');
                    div.className = 'card';
                    div.innerHTML = `
                        <div class="nft-preview" style="background:${getGradient(data.nft.seed, data.nft.rarity)}">
                            <span class="rarity-tag" style="background:${getRarityColor(data.nft.rarity)}">${data.nft.rarity}</span>
                        </div>
                        <div style="font-size:12px; margin-bottom:5px;">
                            –ü—Ä–æ–¥–∞–≤–µ—Ü: <b>${data.sellerName}</b>
                        </div>
                        <button class="btn ${isMine ? 'btn-danger' : 'btn-success'}" 
                            onclick="${isMine ? `cancelP2P('${doc.id}')` : `buyP2P('${doc.id}', ${data.price})`}">
                            ${isMine ? '–°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏' : `–ö—É–ø–∏—Ç—å ${data.price} üí∞`}
                        </button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function buyP2P(lotId, price) {
            if(myData.balance < price) { showToast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥"); return; }
            
            db.runTransaction(async (t) => {
                const marketRef = db.collection('market').doc(lotId);
                const marketDoc = await t.get(marketRef);
                if(!marketDoc.exists) throw "–õ–æ—Ç —É–∂–µ –∫—É–ø–ª–µ–Ω";
                
                const lot = marketDoc.data();
                const buyerRef = db.collection('users').doc(myUid);
                const sellerRef = db.collection('users').doc(lot.sellerId);
                
                // –ü–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –∏ —Ç–æ–≤–∞—Ä–∞
                t.update(sellerRef, { balance: firebase.firestore.FieldValue.increment(price) });
                t.update(buyerRef, { 
                    balance: firebase.firestore.FieldValue.increment(-price),
                    inventory: firebase.firestore.FieldValue.arrayUnion(lot.nft)
                });
                t.delete(marketRef);
            }).then(() => {
                showToast("–£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞!");
                loadP2PMarket();
            }).catch(e => showToast(e));
        }

        function cancelP2P(lotId) {
             db.collection('market').doc(lotId).get().then(doc => {
                 const d = doc.data();
                 db.collection('users').doc(myUid).update({
                     inventory: firebase.firestore.FieldValue.arrayUnion(d.nft)
                 });
                 doc.ref.delete();
                 showToast("–õ–æ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω");
                 loadP2PMarket();
             });
        }

        // --- –ö–ê–ó–ò–ù–û ---
        function spinSlots() {
            const betInput = document.getElementById('slot-bet');
            const bet = parseInt(betInput.value);
            if (!bet || bet < 10 || bet > myData.balance) { showToast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (–º–∏–Ω 10)"); return; }
            
            myData.balance -= bet;
            updateUI();
            
            const icons = ['üçí','üçã','üçá','7Ô∏è‚É£'];
            const res = [0,0,0].map(() => icons[Math.floor(Math.random()*icons.length)]);
            document.getElementById('slots-res').innerText = res.join(' ');
            
            if (res[0]===res[1] && res[1]===res[2]) {
                const w = bet * 5; myData.balance += w; showToast(`–î–∂–µ–∫–ø–æ—Ç! +${w}`);
            } else if (res[0]===res[1] || res[1]===res[2] || res[0]===res[2]) {
                const w = Math.floor(bet * 1.5); myData.balance += w; showToast(`–ü–∞—Ä–∞! +${w}`);
            }
            saveGame();
        }

        // --- UTILS ---
        function nav(tab) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const idx = {'home':0, 'market':1, 'casino':2}[tab];
            document.querySelectorAll('.nav-item')[idx].classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display='block';
            setTimeout(()=>t.style.display='none', 2000);
        }

    </script>
</body>
</html>
