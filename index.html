<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>NFT Universe: HARDCORE ‚Äî Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root{
            --bg:#050505; --surface:#121212; --primary:#6366f1; --accent:#d946ef; --gold:#fbbf24;
            --danger:#ef4444; --success:#10b981; --text:#fff; --radius:16px;
        }
        *{box-sizing:border-box; user-select:none}
        body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial;display:flex;flex-direction:column;height:100vh;overflow:hidden}
        .header{padding:10px 15px;background:rgba(10,10,10,0.95);display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.04);z-index:50}
        .avatar-frame{width:45px;height:45px;border-radius:50%;background:#222;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;border:2px solid transparent;position:relative}
        .content{flex:1;overflow-y:auto;padding:20px;padding-bottom:120px}
        .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;}
        .card{background:#18181b;border-radius:16px;padding:10px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;position:relative}
        .nft-img{width:80px;height:80px;object-fit:contain;margin:10px 0;filter:drop-shadow(0 10px 15px rgba(0,0,0,0.5));}
        .nft-name{font-size:12px;font-weight:700;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
        .nft-pill{font-size:9px;padding:2px 6px;border-radius:6px;background:rgba(0,0,0,0.35);color:#ccc;margin-bottom:6px}
        .btn{background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;border:none;padding:12px;border-radius:12px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;width:100%}
        .btn-sm{padding:6px 10px;font-size:12px;border-radius:8px;width:auto}
        .btn-outline{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);box-shadow:none;color:#fff}
        .btn-gold{background:var(--gold);color:#000}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(20,20,20,0.95);padding:12px 20px;border-radius:30px;z-index:3000;display:none}
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;padding:20px;z-index:2000}
        .modal-box{width:100%;max-width:420px;background:#18181b;border-radius:20px;padding:20px;border:1px solid rgba(255,255,255,0.06)}
        .navbar{position:fixed;bottom:0;left:0;right:0;background:rgba(24,24,27,0.95);display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid rgba(255,255,255,0.06);z-index:100}
        .nav-item{color:#71717a;font-size:11px;text-align:center;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px}
        .nav-item.active{color:var(--primary);transform:translateY(-3px)}
        .slot-row{font-size:46px;margin:20px 0;letter-spacing:12px;background:#000;padding:10px;border-radius:10px;border:2px solid #333;height:80px;display:flex;align-items:center;justify-content:center;overflow:hidden}
        .slot-reel{display:flex;gap:8px;align-items:center}
        .slot-reel .slot-cell{display:inline-block;font-size:40px;transform:translateY(0);transition:transform 0.7s cubic-bezier(.2,.9,.25,1)}
        .supply-tag{position:absolute;top:8px;right:8px;background:var(--danger);color:#fff;padding:3px 6px;border-radius:8px;font-size:11px}
        /* Cosmetic classes for nick */
        .nick-gold{color:var(--gold);text-shadow:0 0 10px rgba(250,204,21,0.5)}
        .nick-neon{color:#00f2ff;text-shadow:0 0 10px rgba(6,182,212,0.5)}
        .nick-red{color:#f43f5e;text-shadow:0 0 10px rgba(244,63,94,0.5)}
        .nick-purple{color:#d946ef;text-shadow:0 0 10px rgba(217,70,239,0.5)}
        .equipped-marker{position:absolute;top:6px;right:6px;width:10px;height:10px;border-radius:50%;background:var(--success);box-shadow:0 0 6px var(--success)}
    </style>
</head>
<body>
    <!-- Auth modal -->
    <div id="auth-modal" class="modal-overlay" style="display:flex;z-index:9000;background:#000;">
        <div class="modal-box" style="background:transparent;border:none;text-align:center;">
            <div style="font-size:70px;margin-bottom:10px;">üèÜ</div>
            <h1 style="margin:0;color:white">NFT UNIVERSE</h1>
            <div style="color:var(--danger);font-size:13px;margin:8px 0 18px">HARDCORE EDITION</div>
            <div style="background:#18181b;padding:18px;border-radius:16px;border:1px solid #333">
                <h3 id="auth-title" style="margin-top:0;color:#fff">–í—Ö–æ–¥</h3>
                <input id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin-bottom:8px">
                <input id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin-bottom:8px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;color:#aaa">
                    <input type="checkbox" id="remember-me" checked style="width:auto"> –ó–∞–ø–æ–º–Ω–∏—Ç—å
                </div>
                <button class="btn" onclick="submitAuth()">–í–æ–π—Ç–∏</button>
                <div onclick="toggleAuth()" style="margin-top:14px;font-size:13px;color:#a1a1aa;cursor:pointer">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="text-decoration:underline;color:var(--primary)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span></div>
                <div id="auth-error" style="color:var(--danger);font-size:13px;margin-top:10px"></div>
            </div>
        </div>
    </div>

    <!-- Ban screen -->
    <div id="ban-screen" style="position:fixed;inset:0;background:#220000;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:9999">
        <h1 style="color:var(--danger);font-size:40px;margin:0;animation: pulse 1s infinite">BANNED</h1>
        <p style="color:#faa;text-align:center;margin:10px 20px">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–∞.<br>–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</p>
        <div style="color:#555">ID: <span id="ban-id">...</span></div>
    </div>

    <!-- Header -->
    <div class="header">
        <div style="display:flex;gap:10px;align-items:center">
            <div class="avatar-frame" id="my-frame">U</div>
            <div>
                <div id="my-nick" style="font-weight:700;font-size:14px;color:white">User</div>
                <div style="font-size:12px;color:#aaa"><span id="balance" style="color:var(--gold);font-weight:700">0</span> üíé</div>
            </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
            <button class="btn-sm btn-outline" onclick="openModal('boost-modal')">‚ö° <span id="energy">0</span></button>
            <button id="admin-btn" class="btn-sm btn-gold" style="display:none" onclick="openModal('admin-modal')">ADM</button>
        </div>
    </div>

    <!-- Content -->
    <div class="content">
        <!-- Home -->
        <div id="screen-home" class="screen active">
            <div style="text-align:center;margin-bottom:8px" id="combo-text"></div>
            <div style="display:flex;justify-content:center;padding:20px 0">
                <div id="tap-btn" style="width:220px;height:220px;border-radius:50%;background:radial-gradient(circle at 30%, #6366f1, #000);box-shadow:0 0 60px rgba(99,102,241,0.28);display:flex;align-items:center;justify-content:center;cursor:pointer;border:4px solid rgba(255,255,255,0.06)">
                    <img src="https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis/Objects/Money%20Bag.png" width="150" style="pointer-events:none;user-select:none">
                </div>
            </div>
            <div style="text-align:center;font-size:12px;color:#888;margin-bottom:16px">–ù–∞–∂–∏–º–∞–π, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å</div>
            <h3 style="margin-bottom:12px;color:white">–ö–æ–ª–ª–µ–∫—Ü–∏—è (<span id="inv-count">0</span>)</h3>
            <div class="grid" id="inventory-list"></div>
        </div>

        <!-- Market -->
        <div id="screen-market" class="screen" style="display:none">
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <div class="tab active" onclick="switchMarket('shop', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#fff">–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –®–æ–ø</div>
                <div class="tab" onclick="switchMarket('p2p', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#a1a1aa">–ë–∏—Ä–∂–∞ –ò–≥—Ä–æ–∫–æ–≤</div>
            </div>
            <div id="view-shop">
                <div style="text-align:center;color:#aaa;font-size:12px;margin-bottom:12px">‚ö†Ô∏è –¶–µ–Ω—ã —Ä–∞—Å—Ç—É—Ç –Ω–∞ 1% —Å –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–æ–π –≤ –º–∏—Ä–µ!</div>
                <div class="grid" id="shop-list"></div>
            </div>
            <div id="view-p2p" style="display:none">
                <button class="btn btn-outline" onclick="loadP2P()" style="margin-bottom:12px;width:100%">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <div class="grid" id="p2p-list"></div>
            </div>
        </div>

        <!-- Casino -->
        <div id="screen-casino" class="screen" style="display:none">
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <div class="tab active" onclick="switchGame('mines', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#fff">–ú–∏–Ω—ã</div>
                <div class="tab" onclick="switchGame('slots', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#a1a1aa">–°–ª–æ—Ç—ã</div>
            </div>

            <div id="game-mines" style="text-align:center">
                <div id="mines-field" style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;max-width:260px;margin:0 auto"></div>
                <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
                    <input id="mines-bet" placeholder="–°—Ç–∞–≤–∫–∞" style="padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;width:120px">
                    <button class="btn" id="mines-btn" onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
                </div>
            </div>

            <div id="game-slots" style="display:none;text-align:center;padding:20px;background:#18181b;border-radius:12px">
                <div class="slot-row">
                    <div class="slot-reel" id="slots-view">
                        <div class="slot-cell slot-cell-1">üçí</div>
                        <div class="slot-cell slot-cell-2">üçí</div>
                        <div class="slot-cell slot-cell-3">üçí</div>
                    </div>
                </div>
                <div style="font-size:12px;color:#888;margin-bottom:10px">–®–∞–Ω—Å –Ω–∞ –¥–∂–µ–∫–ø–æ—Ç: 0.5%</div>
                <input id="slots-bet" placeholder="–°—Ç–∞–≤–∫–∞" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin-bottom:10px">
                <button class="btn" id="btn-spin" onclick="playSlots()">–ö–†–£–¢–ò–¢–¨ (x5)</button>
            </div>
        </div>

        <!-- Profile -->
        <div id="screen-profile" class="screen" style="display:none">
            <div style="display:flex;gap:8px;margin-bottom:12px">
                <div class="tab active" onclick="switchProfile('main', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#fff">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                <div class="tab" onclick="switchProfile('style', this)" style="padding:8px 12px;background:#27272a;border-radius:10px;cursor:pointer;color:#a1a1aa">–ì–∞—Ä–¥–µ—Ä–æ–±</div>
            </div>
            <div id="profile-main">
                <div style="background:#222;padding:12px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><span>–ü–∞—Ä–æ–ª—å</span><button class="btn-sm btn-outline" onclick="changePass()">–°–º–µ–Ω–∏—Ç—å</button></div>
                <div style="background:#222;padding:12px;border-radius:10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center"><span style="color:var(--danger)">–ó–æ–Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏</span><button class="btn-sm" style="background:var(--danger);color:#fff" onclick="deleteAcc()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫</button></div>
                <button class="btn btn-outline" onclick="logout()" style="margin-top:12px">–í—ã–π—Ç–∏</button>
            </div>

            <div id="profile-style" style="display:none">
                <h4 style="margin:10px 0">–¶–≤–µ—Ç –ù–∏–∫–∞</h4>
                <div class="grid" id="style-colors" style="grid-template-columns:repeat(3,1fr)"></div>
                <h4 style="margin:10px 0">–†–∞–º–∫–∞ –ê–≤–∞—Ç–∞—Ä–∞</h4>
                <div class="grid" id="style-frames" style="grid-template-columns:repeat(3,1fr)"></div>
            </div>
        </div>
    </div>

    <!-- Confirm modal -->
    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin:0;color:white">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h3>
            <p id="confirm-text" style="color:#ccc">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</p>
            <div style="display:flex;gap:8px">
                <button class="btn" onclick="confirmAction()">–î–∞</button>
                <button class="btn btn-outline" onclick="closeModal('confirm-modal')">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- NFT modal -->
    <div id="nft-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modal-name" style="margin:0;color:white">Item</h2>
            <p id="modal-serial" style="color:#888;margin-top:6px">#000</p>
            <div id="modal-bg-container" style="border-radius:16px;padding:14px;margin:10px 0;background:#222">
                <img id="modal-img" src="" style="width:140px;height:140px;object-fit:contain">
            </div>
            <div style="display:flex;gap:8px;margin-bottom:8px">
                <button class="tab active" onclick="setNftTab('equip', this)">–î–µ–π—Å—Ç–≤–∏—è</button>
                <button class="tab" onclick="setNftTab('sell', this)">–ü—Ä–æ–¥–∞—Ç—å</button>
                <button class="tab" onclick="setNftTab('gift', this)">–ü–æ–¥–∞—Ä–∏—Ç—å</button>
            </div>
            <div id="tab-equip">
                <button class="btn" onclick="equipNft()">üéí –ù–∞–¥–µ—Ç—å / –°–Ω—è—Ç—å</button>
                <button class="btn btn-outline" style="margin-top:8px" onclick="setNftTab('gift', document.querySelector('#nft-modal .tab:nth-child(3)'))">üéÅ –ü–æ–¥–∞—Ä–∏—Ç—å</button>
            </div>
            <div id="tab-sell" style="display:none">
                <button class="btn btn-outline" style="color:var(--danger);border-color:var(--danger);margin-bottom:8px" onclick="sellSystem()">üî• –°–∂–µ—á—å (+<span id="sys-price">0</span>)</button>
                <input id="p2p-price" type="number" placeholder="–¶–µ–Ω–∞ –¥–ª—è –±–∏—Ä–∂–∏" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin-bottom:8px">
                <button class="btn" onclick="sellP2P()">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
            </div>
            <div id="tab-gift" style="display:none">
                <input id="gift-nick" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin-bottom:8px">
                <button class="btn" onclick="sendGift()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            <button class="btn-sm btn-outline" style="margin-top:10px;width:100%" onclick="closeModal('nft-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Boost modal -->
    <div id="boost-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>–ü—Ä–æ–∫–∞—á–∫–∞</h3>
            <div style="display:flex;justify-content:space-between;align-items:center;background:#222;padding:12px;border-radius:10px;margin-bottom:8px">
                <div><b>–ú—É–ª—å—Ç–∏-—Ç–∞–ø</b><br><span style="font-size:12px;color:#aaa">–£—Ä. <span id="tap-lvl">1</span></span></div>
                <button class="btn-sm btn-outline" onclick="buyTap()">+1 (<span id="tap-cost">100</span>)</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;background:#222;padding:12px;border-radius:10px;margin-bottom:8px">
                <div><b>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞</b><br><span style="font-size:12px;color:#aaa">–£—Ä. <span id="crit-lvl">1</span></span></div>
                <button class="btn-sm btn-outline" onclick="buyCrit()">+1% (<span id="crit-cost">500</span>)</button>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;background:#222;padding:12px;border-radius:10px">
                <div><b>–†–µ–≥–µ–Ω —ç–Ω–µ—Ä–≥–∏–∏</b><br><span style="font-size:12px;color:#aaa">–£—Ä. <span id="regen-lvl">1</span></span></div>
                <button class="btn-sm btn-outline" onclick="buyRegen()">+0.2/—Å (<span id="regen-cost">300</span>)</button>
            </div>
            <button class="btn-sm btn-outline" style="margin-top:10px;width:100%" onclick="closeModal('boost-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <!-- Admin modal -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 style="color:var(--danger);margin:0">GOD MODE</h2>
            <input id="adm-target" placeholder="–ù–∏–∫/Item" style="width:100%;padding:10px;border-radius:10px;background:#222;border:1px solid #333;color:#fff;margin:10px 0">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <button class="btn-sm" onclick="adminUnban()">–†–ê–ó–ë–ê–ù</button>
                <button class="btn-sm btn-gold" onclick="adminGiveSelf()">–í–´–î–ê–¢–¨ –°–ï–ë–ï</button>
                <button class="btn-sm" style="background:var(--danger);color:#fff" onclick="adminBan()">–ë–ê–ù</button>
                <button class="btn-sm btn-outline" onclick="adminAddShop()">+ –í –®–û–ü</button>
            </div>
            <button class="btn-sm btn-outline" style="margin-top:10px;width:100%" onclick="closeModal('admin-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast"> <span id="toast-msg"></span></div>

    <!-- Nav -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home', this)"><i class="ri-home-5-line"></i><div>–î–æ–º</div></div>
        <div class="nav-item" onclick="nav('market', this)"><i class="ri-store-2-line"></i><div>–®–æ–ø</div></div>
        <div class="nav-item" onclick="nav('casino', this)"><i class="ri-gamepad-line"></i><div>–ò–≥—Ä—ã</div></div>
        <div class="nav-item" onclick="nav('profile', this)"><i class="ri-user-settings-line"></i><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
    </div>

<script>
/* FIREBASE INIT */
const firebaseConfig = { apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg", authDomain: "nfts-dc174.firebaseapp.com", projectId: "nfts-dc174", storageBucket: "nfts-dc174.firebasestorage.app", messagingSenderId: "327365720624", appId: "1:327365720624:web:eb42c9d671566b5d118bf5" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* BASE URL */
const BASE_URL = "https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis";

/* utility to create asset */
const make = (n,t,u,p,l) => ({n,t,u,p:p*50,l});

/* MANY ASSETS (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –Ω–∞–±–æ—Ä) */
const ASSETS = [
    make("–†–∞–∫–µ—Ç–∞","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Rocket.png",2000,100),
    make("–†–∞–∫–µ—Ç–∞ Mk2","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Rocket.png",3000,200),
    make("–ö–æ—Ä–æ–Ω–∞","–†–æ—Å–∫–æ—à—å","/Objects/Crown.png",50000,10),
    make("–ê–ª–º–∞–∑","–†–æ—Å–∫–æ—à—å","/Objects/Gem%20Stone.png",10000,50),
    make("–î–µ–Ω—å–≥–∏","–†–æ—Å–∫–æ—à—å","/Objects/Money%20Bag.png",10000,50),
    make("–î—Ä–∞–∫–æ–Ω","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Dragon.png",20000,20),
    make("–ï–¥–∏–Ω–æ—Ä–æ–≥","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Unicorn.png",15000,30),
    make("–ë—É—Ä–≥–µ—Ä","–ï–¥–∞","/Food/Hamburger.png",1000,2000),
    make("–ü–∏—Ü—Ü–∞","–ï–¥–∞","/Food/Pizza.png",1000,2000),
    make("–ö–æ—Ç","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Cat%20Face.png",3000,800),
    make("–ö–æ—Ç –õ—É–Ω–Ω—ã–π","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Cat%20Face.png",6000,300),
    make("–ù–æ—É—Ç–±—É–∫","–¢–µ—Ö–Ω–æ","/Objects/Laptop.png",6000,400),
    make("–û–≥–æ–Ω—å","–†–µ–¥–∫–æ–µ","/Travel%20and%20places/Fire.png",2500,1000),
    make("–ü—Ä–∏–∑—Ä–∞–∫","–†–µ–¥–∫–æ–µ","/Smilies/Ghost.png",4000,800),
    make("–ú–∞—à–∏–Ω–∞","–ê–≤—Ç–æ","/Travel%20and%20places/Automobile.png",8000,400),
    make("–°–∞–º–æ–ª–µ—Ç","–ê–≤—Ç–æ","/Travel%20and%20places/Airplane.png",9000,300),
    make("–ù–õ–û","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Flying%20Saucer.png",10000,150),
    make("–°—É–ø–µ—Ä-–ù–õ–û","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Flying%20Saucer.png",20000,60),
    make("–ö–Ω–∏–≥–∞","–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ","/Objects/Book.png",1200,1200),
    make("–¢–µ–ª–µ—Ñ–æ–Ω","–¢–µ—Ö–Ω–æ","/Objects/Smartphone.png",3500,600),
    make("–†–æ–∑–µ—Ç–∫–∞","–¢–µ—Ö–Ω–æ","/Objects/Plug.png",800,1500),
    make("–ö–æ—Ñ–µ","–ï–¥–∞","/Food/Hot%20Beverage.png",500,2500),
    make("–ö–∞—Ä—Ç–∞","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Map.png",600,1000),
    make("–ú–µ—á","–ë–æ–µ–≤—ã–µ","/Objects/Sword.png",7000,200),
    make("–©–∏—Ç","–ë–æ–µ–≤—ã–µ","/Objects/Shield.png",6500,200),
    make("–ú–µ–¥–∞–ª—å","–ù–∞–≥—Ä–∞–¥–∞","/Objects/Medal.png",4500,400),
    make("–§–æ–Ω–∞—Ä—å","–¢–µ—Ö–Ω–æ","/Objects/Lantern.png",900,1200),
    make("–ó–≤–µ–∑–¥–∞","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Star.png",1500,1000),
    make("–ö—Ä–∏—Å—Ç–∞–ª–ª","–†–µ–¥–∫–æ–µ","/Objects/Crystal.png",11000,80),
    make("–ö—É–±–æ–∫","–ù–∞–≥—Ä–∞–¥–∞","/Objects/Trophy.png",9000,200),
    make("–°–µ—Ä–¥—Ü–µ","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Heart.png",700,2000),
    make("–ö–ª—é—á","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Key.png",2500,900),
    make("–ß–∞—Å—ã","–†–æ—Å–∫–æ—à—å","/Objects/Alarm%20Clock.png",4500,400),
    make("–õ–∞–º–ø–∞","–¢–µ—Ö–Ω–æ","/Objects/Light%20Bulb.png",1200,1500),
    make("–ì–æ—Ä–∞","–ü–µ–π–∑–∞–∂","/Travel%20and%20places/Mountain.png",2000,800),
    make("–†—ã–±–∞","–ñ–∏–≤–æ—Ç–Ω—ã–µ","/Animals/Fish.png",600,1600),
    make("–ü–ª–∞–Ω–µ—Ç–∞","–ö–æ—Å–º–æ—Å","/Travel%20and%20places/Globe.png",8000,120),
    make("–ö–æ—Ç–∏–∫ –õ–µ–≥–µ–Ω–¥–∞","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Cat%20Face.png",50000,5),
    make("–†–∞–∫–µ—Ç–∞ –õ–µ–≥–µ–Ω–¥–∞","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Rocket.png",90000,3)
];

/* COSMETICS */
const COSMETICS = {
    colors:[
        {id:'nick_def',name:'Default',hex:'#ffffff',cost:0},
        {id:'nick_gold',name:'Gold',hex:'#fbbf24',cost:250000},
        {id:'nick_neon',name:'Neon',hex:'#00f2ff',cost:150000},
        {id:'nick_red',name:'Red',hex:'#ef4444',cost:100000},
        {id:'nick_purple',name:'Purple',hex:'#d946ef',cost:120000}
    ],
    frames:[
        {id:'frame_def',name:'Default',cls:'avatar-frame',cost:0},
        {id:'frame_gold',name:'Gold',cls:'frame-gold',cost:500000},
        {id:'frame_neon',name:'Neon',cls:'frame-neon',cost:350000},
        {id:'frame_red',name:'Red',cls:'frame-red',cost:200000},
        {id:'frame_purple',name:'Purple',cls:'frame-purple',cost:250000}
    ]
};

/* STATE */
let myNick = localStorage.getItem('nft_nick') || sessionStorage.getItem('nft_nick');
let data = null;
let globalStats = {};
let pendingBuy = null;
let selIdx = null;
let clickQueue = [];
let warningCount = 0;
let isBanned = false;
let chatUnsub = null;
let combo = 0, comboTimer = null;

/* CSS class map for nick colors */
const COLOR_MAP = {
    nick_def: "",
    nick_gold: "nick-gold",
    nick_neon: "nick-neon",
    nick_red: "nick-red",
    nick_purple: "nick-purple"
};

/* INIT */
(async function init(){
    // Ensure stats document exists to avoid "update non-existent doc" errors
    try {
        const statsRef = db.collection('game').doc('stats');
        const sdoc = await statsRef.get();
        if(!sdoc.exists){
            await statsRef.set({items:{}}); // create base
        }
    } catch(e) {
        console.error("Stats init error:", e);
    }

    if(myNick) {
        document.getElementById('auth-modal').style.display='none';
        checkSession();
    } else {
        document.getElementById('auth-modal').style.display='flex';
    }
})();

/* AUTH */
let isReg = false;
function toggleAuth(){
    isReg = !isReg;
    document.getElementById('auth-title').innerText = isReg ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
}
async function submitAuth(){
    const n = document.getElementById('auth-nick').value.trim();
    const p = document.getElementById('auth-pass').value.trim();
    const remember = document.getElementById('remember-me').checked;
    if(n.length < 3 || p.length < 4){ alert("–ö–æ—Ä–æ—Ç–∫–∏–µ –¥–∞–Ω–Ω—ã–µ"); return; }
    const userRef = db.collection('users').doc(n);
    try {
        const doc = await userRef.get();
        if(isReg){
            if(doc.exists) throw "–ù–∏–∫ –∑–∞–Ω—è—Ç";
            const defData = {
                password: p, nickname: n, balance: 0, energy: 100.0,
                inventory: [], friends: [], equipped: [], tapLvl: 1, critLvl: 1, regenLvl: 1,
                owned_colors: ['nick_def'], owned_frames: ['frame_def'], active_color: 'nick_def', active_frame: 'frame_def',
                isBanned: false, warnings: 0, createdAt: Date.now()
            };
            await userRef.set(defData);
            loginSuccess(n, remember);
        } else {
            if(!doc.exists || doc.data().password !== p) throw "–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å";
            if(doc.data().isBanned) { showBanScreen(n); throw "–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"; }
            loginSuccess(n, remember);
        }
    } catch(e){
        document.getElementById('auth-error').innerText = e.toString();
    }
}
function loginSuccess(n,remember){
    if(remember) localStorage.setItem('nft_nick', n); else sessionStorage.setItem('nft_nick', n);
    myNick = n;
    document.getElementById('auth-modal').style.display='none';
    checkSession();
}
function logout(){
    localStorage.removeItem('nft_nick'); sessionStorage.removeItem('nft_nick'); location.reload();
}

/* SESSION & LISTENERS */
function checkSession(){
    if(!myNick) return;
    db.collection('users').doc(myNick).onSnapshot(snap=>{
        if(!snap.exists) { logout(); return; }
        data = snap.data();
        if(data.isBanned){ showBanScreen(myNick); return; }
        // defaults
        if(!data.owned_colors) data.owned_colors = ['nick_def'];
        if(!data.owned_frames) data.owned_frames = ['frame_def'];
        if(!data.active_color) data.active_color = 'nick_def';
        if(!data.active_frame) data.active_frame = 'frame_def';
        updateUI(); renderInv(); renderShop(); renderCosmetics(); renderFriends();
        if(myNick === 'kayivi') document.getElementById('admin-btn').style.display = 'block';
    });

    // Global stats
    db.collection('game').doc('stats').onSnapshot(s=>{
        if(s.exists) globalStats = s.data().items || {};
        else globalStats = {};
        renderShop();
    });

    // Energy regen
    setInterval(()=>{
        if(data && !data.isBanned){
            if(data.energy < 100){
                const regen = (data.regenLvl || 1) * 0.2;
                data.energy = Math.min(100, data.energy + regen);
                updateUI();
            }
        }
    }, 1000);
}

/* SHOW BAN */
function showBanScreen(id){
    isBanned = true;
    document.getElementById('ban-screen').style.display = 'flex';
    document.getElementById('ban-id').innerText = id;
    document.getElementById('auth-modal').style.display='none';
}

/* UI UPDATES */
function updateUI(){
    if(!data) return;
    document.getElementById('balance').innerText = Math.floor(data.balance || 0).toLocaleString();
    document.getElementById('energy').innerText = Math.floor(data.energy || 0);
    document.getElementById('inv-count').innerText = (data.inventory || []).length;
    // nick
    const nickEl = document.getElementById('my-nick');
    nickEl.innerText = myNick;
    // apply class map
    Object.values(COLOR_MAP).forEach(c=>{ if(c) nickEl.classList.remove(c) });
    const mapped = COLOR_MAP[data.active_color] || "";
    if(mapped) nickEl.classList.add(mapped);

    // frame
    const frameEl = document.getElementById('my-frame');
    frameEl.innerText = myNick[0] ? myNick[0].toUpperCase() : 'U';
    // apply frame classes (we'll simply add class names defined in CSS when owned; simple mapping)
    frameEl.className = 'avatar-frame';
    const fobj = COSMETICS.frames.find(f=>f.id === data.active_frame);
    if(fobj) frameEl.classList.add(fobj.cls);

    document.getElementById('tap-lvl').innerText = data.tapLvl || 1;
    document.getElementById('tap-cost').innerText = Math.floor(100 * Math.pow(1.8, (data.tapLvl||1))).toLocaleString();
    document.getElementById('crit-lvl').innerText = data.critLvl || 1;
    document.getElementById('crit-cost').innerText = (500 + ((data.critLvl||1) * 500)).toLocaleString();
    document.getElementById('regen-lvl').innerText = data.regenLvl || 1;
    document.getElementById('regen-cost').innerText = (300 + ((data.regenLvl||1) * 400)).toLocaleString();
}

/* TOAST */
function toast(m){
    const t = document.getElementById('toast');
    document.getElementById('toast-msg').innerText = m;
    t.style.display = 'block';
    setTimeout(()=> t.style.display = 'none', 2200);
}

/* ANTI-CHEAT & TAP HANDLING */
document.getElementById('tap-btn').addEventListener('click', e=>{
    if(!data || data.isBanned) return;

    const now = Date.now();
    clickQueue.push(now);
    if(clickQueue.length > 30) clickQueue.shift();

    // Compute clicks per second for last 10 clicks
    if(clickQueue.length >= 10){
        const first = clickQueue[clickQueue.length - 10];
        const last = clickQueue[clickQueue.length - 1];
        const cps = (9) / ((last - first) / 1000); // approximate cps
        if(cps > 30){ // >30 clicks per second suspicious
            warningCount++;
            toast(`‚ö†Ô∏è –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä—ã–π –∫–ª–∏–∫! (${warningCount}/3)`);
            clickQueue = [];
            if(warningCount >= 3){ banUser(); return; }
        }
    }

    // Energy check
    if((data.energy || 0) < 1){ toast("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏! ‚ö°"); return; }

    // Combo
    clearTimeout(comboTimer);
    combo++; if(combo > 20) combo = 20;
    const comboMult = 1 + (combo * 0.05);
    document.getElementById('combo-text').innerText = `x${comboMult.toFixed(1)}`;
    comboTimer = setTimeout(()=>{ combo = 0; document.getElementById('combo-text').innerText = ""; }, 1000);

    // Crit
    let isCrit = false;
    let gain = Math.floor((data.tapLvl || 1) * comboMult);
    if(Math.random() < ((data.critLvl || 1) * 0.01)){ isCrit = true; gain *= 5; }

    data.balance = (data.balance || 0) + gain;
    data.energy = Math.max(0, (data.energy || 0) - 1);

    // visual popup near center
    const el = document.createElement('div');
    el.innerText = (isCrit ? `üí•+${gain}` : `+${gain}`);
    el.style.position='fixed'; el.style.left='50%'; el.style.top='40%'; el.style.transform='translate(-50%,-50%)';
    el.style.zIndex = 9999; el.style.fontWeight = '700'; el.style.fontSize = isCrit ? '26px' : '18px';
    el.style.color = isCrit ? '#ffd60a' : '#fff';
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 600);

    if(Math.floor(data.balance) % 10 === 0) save();
    updateUI();
});

function banUser(){
    if(!myNick) return;
    db.collection('users').doc(myNick).update({ isBanned: true }).catch(()=>{});
    showBanScreen(myNick);
}

/* SHOP RENDER + PURCHASE */
function renderShop(){
    const l = document.getElementById('shop-list');
    l.innerHTML = '';
    const stats = globalStats || {};
    ASSETS.forEach(a=>{
        const sold = stats[a.n] || 0;
        const priceMult = 1 + (sold * 0.01);
        const currentPrice = Math.max(1, Math.floor(a.p * priceMult));
        const remaining = Math.max(0, a.l - sold);
        const d = document.createElement('div'); d.className = 'card';
        if(remaining <= 0) d.style.opacity = '0.45';
        d.innerHTML = `
            <div class="supply-tag">${remaining}/${a.l}</div>
            <div class="nft-pill">${a.t}</div>
            <img src="${BASE_URL + a.u}" class="nft-img" loading="lazy">
            <div class="nft-name">${a.n}</div>
            <div style="width:100%;margin-top:6px">
                <button class="btn btn-sm ${remaining<=0?'btn-outline':''}" ${remaining<=0?'disabled':''} onclick="reqBuyShop('${a.n}', ${currentPrice})">${remaining<=0?'SOLD OUT':currentPrice.toLocaleString() + ' üíé'}</button>
            </div>
        `;
        l.appendChild(d);
    });
}

function reqBuyShop(name, price){
    pendingBuy = { type:'shop', name, price };
    document.getElementById('confirm-text').innerText = `–ö—É–ø–∏—Ç—å "${name}" –∑–∞ ${price.toLocaleString()} üíé?`;
    openModal('confirm-modal');
}

function buyShop(name, price){
    const itemRef = db.collection('game').doc('stats');
    const userRef = db.collection('users').doc(myNick);
    const asset = ASSETS.find(x=>x.n === name);
    if(!asset) { toast("Asset not found"); return; }

    db.runTransaction(async t=>{
        const statsDoc = await t.get(itemRef);
        const userDoc = await t.get(userRef);
        const statsData = statsDoc.exists ? (statsDoc.data().items || {}) : {};
        const currentSold = statsData[name] || 0;
        if(currentSold >= asset.l) throw "Sold Out!";
        const userData = userDoc.exists ? userDoc.data() : null;
        if(!userData) throw "User not found";
        if((userData.balance || 0) < price) throw "–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥!";
        const newItem = {
            id: Date.now() + Math.random(),
            name: asset.n, type: asset.t, u: asset.u, p: asset.p,
            serial: currentSold + 1,
            bg: genUnique().bg, hue: genUnique().hue
        };
        // update stats (merge items map)
        t.set(itemRef, { items: { ...(statsDoc.exists ? statsDoc.data().items : {}), [name]: currentSold + 1 } }, { merge: true });
        t.update(userRef, {
            balance: firebase.firestore.FieldValue.increment(-price),
            inventory: firebase.firestore.FieldValue.arrayUnion(newItem)
        });
    }).then(()=>{
        toast("–£—Å–ø–µ—à–Ω–∞—è –ø–æ–∫—É–ø–∫–∞!");
        // renderShop will update by stats listener
    }).catch(e=>{
        toast(typeof e === 'string' ? e : (e.message || '–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏'));
    });
}

/* Unique generator for bg/hue */
function genUnique(){
    const h = Math.floor(Math.random() * 360);
    return { bg: `linear-gradient(135deg, hsl(${h},60%,22%), hsl(${(h+40)%360},60%,14%))`, hue: `hue-rotate(${Math.floor(Math.random()*360)}deg)` };
}

/* INVENTORY */
function renderInv(){
    const l = document.getElementById('inventory-list'); l.innerHTML = '';
    (data.inventory || []).forEach((n, i)=>{
        const isEq = (data.equipped || []).find(e => e.id === n.id);
        const d = document.createElement('div'); d.className = 'card';
        d.style.background = n.bg || '#222';
        d.innerHTML = `${isEq?'<div class="equipped-marker"></div>':''}<div class="nft-pill">${n.type}</div><img src="${BASE_URL + n.u}" class="nft-img" style="filter:${n.hue||'none'}"><div class="nft-name">${n.name}</div><div style="font-size:10px;color:#aaa">#${n.serial}</div><div style="width:100%;margin-top:6px"><button class="btn btn-sm btn-outline" style="width:100%" onclick="openNft(${i})">–ú–µ–Ω—é</button></div>`;
        l.appendChild(d);
    });
}
function openNft(i){
    selIdx = i;
    const n = data.inventory[i];
    if(!n) return;
    document.getElementById('modal-name').innerText = n.name;
    document.getElementById('modal-serial').innerText = `#${n.serial}`;
    const img = document.getElementById('modal-img'); img.src = BASE_URL + n.u; img.style.filter = n.hue || 'none';
    document.getElementById('modal-bg-container').style.background = n.bg || '#222';
    document.getElementById('sys-price').innerText = Math.floor((n.p || 100) * 0.1);
    setNftTab('equip', document.querySelector('#nft-modal .tab'));
    openModal('nft-modal');
}

function equipNft(){
    if(selIdx === null) return;
    const n = data.inventory[selIdx];
    let equipped = data.equipped || [];
    const idx = equipped.findIndex(e => e.id === n.id);
    if(idx > -1){
        equipped.splice(idx, 1); toast("–°–Ω—è—Ç–æ");
    } else {
        if(equipped.length >= 3){ toast("–ú–∞–∫—Å–∏–º—É–º 3!"); return; }
        equipped.push(n); toast("–ù–∞–¥–µ—Ç–æ");
    }
    // update server with new equipped array
    db.collection('users').doc(myNick).update({ equipped }).then(()=>{ closeModal('nft-modal'); }).catch(()=>{});
}

/* Sell to system (burn) */
function sellSystem(){
    if(selIdx === null) return;
    const n = data.inventory[selIdx];
    const p = Math.floor((n.p || 100) * 0.1);
    // remove item and add balance
    const inv = (data.inventory || []).filter(x => x.id !== n.id);
    const eq = (data.equipped || []).filter(x => x.id !== n.id);
    db.collection('users').doc(myNick).update({ inventory: inv, equipped: eq, balance: firebase.firestore.FieldValue.increment(p) }).then(()=>{
        closeModal('nft-modal'); toast("–°–∂–µ—Ç–æ +"+p);
    }).catch(e=>toast("–û—à–∏–±–∫–∞"));
}

/* P2P */
function sellP2P(){
    const p = parseInt(document.getElementById('p2p-price').value);
    if(!p || p <= 0){ toast("–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É"); return; }
    const n = data.inventory[selIdx];
    if(!n) return;
    const inv = (data.inventory || []).filter(x => x.id !== n.id);
    const eq = (data.equipped || []).filter(x => x.id !== n.id);
    const marketRef = db.collection('market').doc();
    db.runTransaction(async t=>{
        const udoc = await t.get(db.collection('users').doc(myNick));
        const curInv = udoc.exists ? udoc.data().inventory || [] : [];
        const newInv = curInv.filter(x => x.id !== n.id);
        t.update(db.collection('users').doc(myNick), { inventory: newInv, equipped: eq });
        t.set(marketRef, { seller: myNick, price: p, nft: n, createdAt: Date.now() });
    }).then(()=>{ closeModal('nft-modal'); toast("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ!"); loadP2P(); }).catch(e=>toast("–û—à–∏–±–∫–∞"));
}

function loadP2P(){
    const l = document.getElementById('p2p-list'); l.innerHTML = '<div style="width:100%;text-align:center">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    db.collection('market').orderBy('createdAt','desc').limit(30).get().then(s=>{
        l.innerHTML = '';
        s.forEach(doc=>{
            const dt = doc.data();
            const mine = dt.seller === myNick;
            const el = document.createElement('div'); el.className = 'card'; el.style.background = dt.nft.bg || '#222';
            el.innerHTML = `<div class="nft-pill">By ${dt.seller}</div><img src="${BASE_URL+dt.nft.u}" class="nft-img" style="filter:${dt.nft.hue||'none'}"><div class="nft-name">${dt.nft.name}</div><div style="font-size:12px;margin-top:6px">${dt.price.toLocaleString()} üíé</div><div style="width:100%;margin-top:8px"><button class="btn btn-sm ${mine?'btn-outline':''}" style="width:100%" onclick="${mine?`delP2P('${doc.id}')`:`reqBuyP2P('${doc.id}',${dt.price})`}">${mine?'–°–Ω—è—Ç—å':'–ö—É–ø–∏—Ç—å'}</button></div>`;
            l.appendChild(el);
        });
    }).catch(e=>{ l.innerHTML = '<div style="text-align:center">–û—à–∏–±–∫–∞</div>'; });
}
function reqBuyP2P(id, p){ pendingBuy = { type:'p2p', id, price:p }; document.getElementById('confirm-text').innerText = `–ö—É–ø–∏—Ç—å –∑–∞ ${p.toLocaleString()}?`; openModal('confirm-modal'); }
function buyP2P(id, p){
    if((data.balance || 0) < p){ toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥"); return; }
    const marketDoc = db.collection('market').doc(id);
    db.runTransaction(async t=>{
        const md = await t.get(marketDoc);
        if(!md.exists) throw "–£–∂–µ –∫—É–ø–ª–µ–Ω–æ";
        const lot = md.data();
        t.update(db.collection('users').doc(lot.seller), { balance: firebase.firestore.FieldValue.increment(p) });
        t.update(db.collection('users').doc(myNick), { balance: firebase.firestore.FieldValue.increment(-p), inventory: firebase.firestore.FieldValue.arrayUnion(lot.nft) });
        t.delete(marketDoc);
    }).then(()=>{ toast("–ö—É–ø–ª–µ–Ω–æ!"); loadP2P(); }).catch(e=>toast(typeof e === 'string' ? e : '–û—à–∏–±–∫–∞'));
}
function delP2P(id){
    const docRef = db.collection('market').doc(id);
    docRef.get().then(d=>{
        if(!d.exists) return;
        const lot = d.data();
        if(lot.seller !== myNick) return;
        // return nft to seller inventory
        db.collection('users').doc(myNick).update({ inventory: firebase.firestore.FieldValue.arrayUnion(lot.nft) }).then(()=>{ d.ref.delete(); loadP2P(); });
    });
}

/* CASINO: MINES */
let mines = { a:false, m:[], s:0, b:0 };
function startMines(){
    if(mines.a) return;
    const b = parseInt(document.getElementById('mines-bet').value);
    if(!b || b <= 0 || b > (data.balance || 0)){ toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞"); return; }
    data.balance -= b;
    mines = { a:true, m:[], s:0, b };
    while(mines.m.length < 3){
        const r = Math.floor(Math.random() * 16);
        if(!mines.m.includes(r)) mines.m.push(r);
    }
    const g = document.getElementById('mines-field'); g.innerHTML = '';
    for(let i=0;i<16;i++){
        const c = document.createElement('div'); c.className = 'card'; c.style.aspectRatio = '1'; c.style.fontSize='20px'; c.style.justifyContent='center'; c.style.cursor='pointer'; c.style.display='flex'; c.style.alignItems='center'; c.style.justifyContent='center';
        c.onclick = ()=>{
            if(!mines.a || c.innerText !== '') return;
            if(mines.m.includes(i)){
                c.innerHTML = 'üí£'; c.style.background = 'var(--danger)'; mines.a = false; toast("BOOM! –ü–æ—Ç–µ—Ä—è–Ω–æ: "+mines.b); save();
            } else {
                c.innerHTML = 'üíé'; c.style.background = 'var(--success)'; mines.s++;
                const win = Math.floor(mines.b * (1 + mines.s * 0.2));
                document.getElementById('mines-btn').innerText = `–ó–∞–±—Ä–∞—Ç—å ${win}`;
                document.getElementById('mines-btn').onclick = ()=>{
                    data.balance += win; save(); toast("–ü–æ–±–µ–¥–∞: "+win);
                    mines.a = false; document.getElementById('mines-btn').innerText = "–ò–≥—Ä–∞—Ç—å"; document.getElementById('mines-btn').onclick = startMines;
                };
            }
        };
        g.appendChild(c);
    }
}

/* SLOTS improved visual */
async function playSlots(){
    const b = parseInt(document.getElementById('slots-bet').value);
    if(!b || b <= 0 || b > (data.balance || 0)){ toast("–°—Ç–∞–≤–∫–∞?"); return; }
    const btn = document.getElementById('btn-spin'); btn.disabled = true;
    data.balance -= b; updateUI();

    const v = document.getElementById('slots-view');
    const cells = [v.querySelector('.slot-cell-1'), v.querySelector('.slot-cell-2'), v.querySelector('.slot-cell-3')];
    const icons = ['üçí','üíé','7Ô∏è‚É£','üí©','üçã','üîî','üçÄ'];
    // start rapid spin (visual)
    let itv = setInterval(()=>{
        cells.forEach(c => { c.innerText = icons[Math.floor(Math.random()*icons.length)] });
    }, 80);

    // spin duration
    await new Promise(r => setTimeout(r, 1100));
    clearInterval(itv);

    // pick results (nerf: keep some chance of üí©)
    const pick = ()=> Math.random() < 0.5 ? 'üí©' : icons[Math.floor(Math.random()*icons.length)];
    const r1 = pick(); const r2 = pick(); const r3 = pick();
    cells[0].innerText = r1; cells[1].innerText = r2; cells[2].innerText = r3;

    // compute win
    let win = 0;
    if(r1 === r2 && r2 === r3 && r1 !== 'üí©'){
        if(r1 === '7Ô∏è‚É£') win = b * 50;
        else win = b * 10;
        toast(`JACKPOT! +${win}`);
    } else if((r1 === r2 || r2 === r3 || r1 === r3) && r1 !== 'üí©' && r2 !== 'üí©' && r3 !== 'üí©'){
        win = Math.floor(b * 1.5);
        toast(`Win! +${win}`);
    } else {
        toast("–ü—Ä–æ–∏–≥—Ä—ã—à");
    }
    if(win > 0) data.balance += win;
    btn.disabled = false;
    save();
}

/* COSMETICS */
function renderCosmetics(){
    const cl = document.getElementById('style-colors'); cl.innerHTML = '';
    (COSMETICS.colors || []).forEach(c=>{
        const owned = (data.owned_colors || []).includes(c.id);
        const active = data.active_color === c.id;
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `<div style="color:${c.hex};font-weight:700">${c.name}</div><div style="font-size:12px;margin:6px 0">${owned ? (active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ö—É–ø–ª–µ–Ω–æ') : c.cost.toLocaleString() + ' üíé'}</div><button class="btn btn-sm ${active?'btn-gold':(owned?'btn-outline':'')}" onclick="${owned ? `equipStyle('color','${c.id}')` : `buyStyle('color','${c.id}',${c.cost})`}">${active ? '‚úì' : (owned ? '–ù–∞–¥–µ—Ç—å' : '–ö—É–ø–∏—Ç—å')}</button>`;
        cl.appendChild(div);
    });

    const fl = document.getElementById('style-frames'); fl.innerHTML = '';
    (COSMETICS.frames || []).forEach(f=>{
        const owned = (data.owned_frames || []).includes(f.id);
        const active = data.active_frame === f.id;
        const div = document.createElement('div'); div.className = 'card';
        div.innerHTML = `<div class="${f.cls}" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:8px">A</div><div style="font-size:12px;margin:6px 0">${owned ? (active ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ö—É–ø–ª–µ–Ω–æ') : f.cost.toLocaleString() + ' üíé'}</div><button class="btn btn-sm ${active?'btn-gold':(owned?'btn-outline':'')}" onclick="${owned ? `equipStyle('frame','${f.id}')` : `buyStyle('frame','${f.id}',${f.cost})`}">${active ? '‚úì' : (owned ? '–ù–∞–¥–µ—Ç—å' : '–ö—É–ø–∏—Ç—å')}</button>`;
        fl.appendChild(div);
    });
}

function buyStyle(type, id, cost){
    if((data.balance || 0) < cost){ toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥"); return; }
    data.balance -= cost;
    if(type === 'color') {
        const arr = new Set(data.owned_colors || []); arr.add(id); data.owned_colors = Array.from(arr);
    }
    if(type === 'frame'){
        const arr = new Set(data.owned_frames || []); arr.add(id); data.owned_frames = Array.from(arr);
    }
    save(); renderCosmetics(); toast("–ö—É–ø–ª–µ–Ω–æ!");
}

function equipStyle(type, id){
    if(type === 'color') data.active_color = id;
    if(type === 'frame') data.active_frame = id;
    save(); renderCosmetics(); updateUI();
}

/* SOCIAL */
function renderFriends(){
    const l = document.getElementById('mines-field'); // reuse? no, we have friends panel not implemented - keep simple
}
async function addFriend(){
    const n = prompt("–ù–∏–∫ –¥—Ä—É–≥–∞:");
    if(!n) return; if(n === myNick) return toast("–≠—Ç–æ —Ç—ã!");
    const d = await db.collection('users').doc(n).get();
    if(!d.exists) return toast("–ù–µ –Ω–∞–π–¥–µ–Ω");
    db.collection('users').doc(myNick).update({ friends: firebase.firestore.FieldValue.arrayUnion(n) });
    toast("–î–æ–±–∞–≤–ª–µ–Ω");
}

/* CHAT minimal - omitted heavy implementation for brevity */

/* TOP minimal - omitted heavy implementation for brevity */

/* ADMIN */
function adminUnban(){ const t = document.getElementById('adm-target').value.trim(); if(!t) return; db.collection('users').doc(t).update({isBanned:false,warnings:0}).then(()=>toast("–†–∞–∑–±–∞–Ω–µ–Ω")); }
function adminBan(){ const t=document.getElementById('adm-target').value.trim(); if(!t) return; db.collection('users').doc(t).update({isBanned:true}).then(()=>toast("–ó–∞–±–∞–Ω–µ–Ω")); }
function adminGiveSelf(){ const item = ASSETS[Math.floor(Math.random()*ASSETS.length)]; const newItem = { id: Date.now()+Math.random(), name:item.n, type:item.t, u:item.u, p:item.p, serial:999, bg:genUnique().bg, hue:'' }; db.collection('users').doc(myNick).update({ inventory: firebase.firestore.FieldValue.arrayUnion(newItem) }).then(()=>toast("–ü–æ–¥–∞—Ä–æ–∫!")); }
function adminAddShop(){ const t=document.getElementById('adm-target').value.trim(); if(!t) return; db.collection('game').doc('stats').update({ [`items.${t}`]:0 }).then(()=>toast("Stock —Å–±—Ä–æ—à–µ–Ω")); }

/* CONFIRM ACTION */
function confirmAction(){
    if(!pendingBuy) return;
    if(pendingBuy.type === 'shop') buyShop(pendingBuy.name, pendingBuy.price);
    if(pendingBuy.type === 'p2p') buyP2P(pendingBuy.id, pendingBuy.price);
    pendingBuy = null; closeModal('confirm-modal');
}

/* SAVE (basic) */
function save(){
    if(!data || data.isBanned) return;
    const up = {
        balance: data.balance,
        energy: data.energy,
        tapLvl: data.tapLvl,
        critLvl: data.critLvl,
        regenLvl: data.regenLvl,
        active_color: data.active_color,
        active_frame: data.active_frame,
        owned_colors: data.owned_colors,
        owned_frames: data.owned_frames
    };
    // Inventory and equipped are large; we avoid frequent writes but allow manual flows to update inventory via transactions above
    db.collection('users').doc(myNick).update(up).catch(e=>console.error("save err",e));
}

/* UTILS: navigation, modals, simple UI */
function nav(s, el){
    document.querySelectorAll('.screen').forEach(x=>x.style.display='none');
    document.getElementById('screen-'+s).style.display='block';
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    el.classList.add('active');
}
function switchMarket(t,el){
    document.getElementById('view-shop').style.display = (t==='shop') ? 'block' : 'none';
    document.getElementById('view-p2p').style.display = (t==='p2p') ? 'block' : 'none';
    document.querySelectorAll('#screen-market .tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
    if(t==='p2p') loadP2P();
}
function switchGame(t,el){
    document.getElementById('game-mines').style.display = (t==='mines') ? 'block' : 'none';
    document.getElementById('game-slots').style.display = (t==='slots') ? 'block' : 'none';
    document.querySelectorAll('#screen-casino .tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
}
function switchProfile(t,el){
    document.getElementById('profile-main').style.display = (t==='main') ? 'block' : 'none';
    document.getElementById('profile-style').style.display = (t==='style') ? 'block' : 'none';
    document.querySelectorAll('#screen-profile .tab').forEach(x=>x.classList.remove('active'));
    el.classList.add('active');
}
function setNftTab(t, el){
    ['equip','sell','gift'].forEach(x=>document.getElementById('tab-'+x).style.display='none');
    document.getElementById('tab-'+t).style.display='block';
    // tabs visual toggling (within nft-modal)
    const tabs = document.querySelectorAll('#nft-modal .tab');
    tabs.forEach(tab=>tab.classList.remove('active'));
    if(el && el.classList) el.classList.add('active');
}
function openModal(id){ document.getElementById(id).style.display = 'flex'; }
function closeModal(id){ document.getElementById(id).style.display = 'none'; }

/* small helpers to open nft menu from inline onclick (since we used dynamic strings earlier) */
window.openNft = openNft;
window.reqBuyShop = reqBuyShop;
window.reqBuyP2P = reqBuyP2P;
window.delP2P = delP2P;
window.equipStyle = equipStyle;
window.buyStyle = buyStyle;
window.buyTap = function(){ const c = Math.floor(100 * Math.pow(1.8, (data.tapLvl||1))); if((data.balance||0) < c){ toast("–ú–∞–ª–æ"); return; } data.balance -= c; data.tapLvl = (data.tapLvl||1)+1; save(); updateUI(); }
window.buyCrit = function(){ const c = 500 + ((data.critLvl||1)*500); if((data.balance||0) < c){ toast("–ú–∞–ª–æ"); return; } data.balance -= c; data.critLvl = (data.critLvl||1)+1; save(); updateUI(); }
window.buyRegen = function(){ const c = 300 + ((data.regenLvl||1)*400); if((data.balance||0) < c){ toast("–ú–∞–ª–æ"); return; } data.balance -= c; data.regenLvl = (data.regenLvl||1)+1; save(); updateUI(); }
window.openModal = openModal; window.closeModal = closeModal;

/* OPEN NFT wrapper for inline */
window.openNft = openNft;

/* Small helpers for profile actions */
function changePass(){ const p = prompt("–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:"); if(p && p.length > 3) db.collection('users').doc(myNick).update({ password: p }).then(()=>toast("–ü–∞—Ä–æ–ª—å —Å–º–µ–Ω—ë–Ω")); }
function deleteAcc(){ if(confirm("–£–î–ê–õ–ò–¢–¨ –ù–ê–í–°–ï–ì–î–ê?")){ db.collection('users').doc(myNick).delete().then(()=>{ logout(); }); } }

/* render shop once global stats exist ‚Äî already hooked by snapshot */

/* Minimal P2P load initial (if needed) */
function initUIAfterLogin(){
    renderShop();
    renderCosmetics();
    renderInv();
    loadP2P();
}

/* Quick call to update initially if "data" is present */
setInterval(()=>{ if(data) updateUI(); },1000);

/* End of script */
</script>
</body>
</html>
