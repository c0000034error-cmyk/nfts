<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NFT Universe: FIXED</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --surface: #111;
            --primary: #6366f1;
            --accent: #d946ef;
            --gold: #fbbf24;
            --danger: #ff2a2a;
            --success: #00ff88;
            --text: #ffffff;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* UI */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff; border: none; padding: 14px; border-radius: 12px;
            font-weight: 700; font-size: 14px; width: 100%; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn-outline { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); box-shadow: none; color:white; }
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(255, 42, 42, 0.4); }
        .btn-success { background: var(--success); color: black; box-shadow: 0 4px 15px rgba(0, 255, 136, 0.4); }
        .btn-sm { padding: 8px 14px; font-size: 11px; width: auto; border-radius: 8px; }
        
        input { background: #1a1a1a; border: 1px solid #333; padding: 12px; border-radius: 12px; color: white; width: 100%; outline: none; margin-bottom: 10px; font-size: 16px; }
        input:focus { border-color: var(--primary); }

        .header { padding: 15px; padding-top: max(15px, env(safe-area-inset-top)); background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; z-index: 50; }
        .avatar-frame { width: 45px; height: 45px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #333; position: relative; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; padding-bottom: 50px; }
        .card { border-radius: var(--radius); padding: 10px; display: flex; flex-direction: column; align-items: center; border: 1px solid #222; background: #111; position: relative; }
        .nft-img { width: 70px; height: 70px; object-fit: contain; margin: 10px 0; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }
        
        .screen { display: none; flex: 1; overflow-y: auto; padding: 20px; }
        .screen.active { display: block; }
        
        .navbar { position: fixed; bottom: 0; width: 100%; background: #0a0a0a; display: flex; justify-content: space-around; padding: 12px 0; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid #222; z-index: 100; }
        .nav-item { color: #555; font-size: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 24px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-box { width: 100%; max-width: 350px; background: #111; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #333; }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #222; padding: 10px 20px; border-radius: 30px; z-index: 3000; display: none; border: 1px solid #444; font-size: 14px; }

        /* Tap Animation */
        #tap-btn { width: 240px; height: 240px; border-radius: 50%; background: radial-gradient(circle, #333, #000); display: flex; justify-content: center; align-items: center; margin: 20px auto; border: 5px solid #222; box-shadow: 0 0 30px rgba(0,0,0,0.5); active: scale(0.95); transition: 0.05s; }
        @keyframes float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        .float-text { position: absolute; pointer-events: none; animation: float 0.8s forwards; font-weight: bold; font-size: 20px; color: var(--success); }

        .tabs { display: flex; background: #1a1a1a; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 8px; border-radius: 8px; font-size: 13px; color: #666; cursor: pointer; }
        .tab.active { background: #333; color: white; }
    </style>
</head>
<body>

    <!-- Auth -->
    <div id="auth-modal" class="modal-overlay" style="display:flex;">
        <div class="modal-box">
            <h1>NFT UNIVERSE</h1>
            <p>–í–µ—Ä—Å–∏—è: Fixed & Hardcore</p>
            <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button class="btn" onclick="auth()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div style="display:flex; gap:10px; align-items:center;">
            <div class="avatar-frame" id="my-frame">U</div>
            <div>
                <div id="my-nick" style="font-weight:bold;">Player</div>
                <div style="font-size:12px; color:var(--gold);"><span id="balance">0</span> üíé</div>
            </div>
        </div>
        <button class="btn-sm btn-outline" onclick="openModal('boost-modal')">‚ö° <span id="energy">100</span></button>
    </div>

    <!-- Home -->
    <div id="screen-home" class="screen active">
        <div id="tap-btn" onmousedown="tap(event)" ontouchstart="tap(event)">
            <img src="https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis/Objects/Money%20Bag.png" width="140" style="pointer-events:none;">
        </div>
        <h3>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div class="grid" id="inventory-list"></div>
    </div>

    <!-- Shop -->
    <div id="screen-shop" class="screen">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('shop', 'official')">–ú–∞–≥–∞–∑–∏–Ω</div>
            <div class="tab" onclick="switchTab('shop', 'p2p')">–ë–∏—Ä–∂–∞</div>
        </div>
        <div id="shop-official">
            <div class="grid" id="shop-list"></div>
        </div>
        <div id="shop-p2p" style="display:none;">
            <button class="btn btn-outline" onclick="loadP2P()" style="margin-bottom:10px;">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div class="grid" id="p2p-list"></div>
        </div>
    </div>

    <!-- Casino -->
    <div id="screen-casino" class="screen">
        <h3>–ö–∞–∑–∏–Ω–æ</h3>
        <div style="background:#1a1a1a; padding:20px; border-radius:16px; text-align:center; margin-bottom:20px;">
            <h4>–ö–æ—Å—Ç–∏ (Dice)</h4>
            <div id="dice-result" style="font-size:40px; margin:10px;">üé≤</div>
            <input type="number" id="dice-bet" placeholder="–°—Ç–∞–≤–∫–∞">
            <div style="display:flex; gap:5px;">
                <button class="btn-sm btn-outline" onclick="playDice('low')">–ú–µ–Ω—å—à–µ 7</button>
                <button class="btn-sm btn-success" onclick="playDice('7')">–†–æ–≤–Ω–æ 7 (x5)</button>
                <button class="btn-sm btn-outline" onclick="playDice('high')">–ë–æ–ª—å—à–µ 7</button>
            </div>
        </div>
    </div>

    <!-- Profile/Admin -->
    <div id="screen-profile" class="screen">
        <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
        <p>ID: <span id="my-id">...</span></p>
        <button class="btn btn-danger" onclick="logout()">–í—ã–π—Ç–∏</button>
        
        <div id="admin-panel" style="display:none; margin-top:30px; border-top:1px solid #333; padding-top:20px;">
            <h3 style="color:var(--danger)">–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞ (Kayivi)</h3>
            <input type="text" id="adm-target" placeholder="–ù–∏–∫ –∏–≥—Ä–æ–∫–∞">
            <input type="number" id="adm-amount" placeholder="–°—É–º–º–∞ –¥–µ–Ω–µ–≥">
            <button class="btn btn-success" onclick="admGiveMoney()" style="margin-bottom:5px;">–í—ã–¥–∞—Ç—å –¥–µ–Ω—å–≥–∏</button>
            <button class="btn btn-outline" onclick="admResetShop()" style="margin-bottom:5px;">–°–±—Ä–æ—Å–∏—Ç—å –°—Ç–æ–∫ –ú–∞–≥–∞–∑–∏–Ω–∞</button>
            <button class="btn btn-outline" onclick="admPopulateMarket()">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ë–∏—Ä–∂—É (–ë–æ—Ç—ã)</button>
            <button class="btn btn-danger" onclick="admUnban()">–†–∞–∑–±–∞–Ω–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="nft-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="modal-name">Item</h2>
            <p id="modal-id" style="color:#666; font-size:12px;">#0</p>
            <img id="modal-img" src="" style="width:100px; margin:10px;">
            <input type="number" id="sell-price" placeholder="–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏">
            <button class="btn" onclick="sellP2P()">–ü—Ä–æ–¥–∞—Ç—å –Ω–∞ –±–∏—Ä–∂–µ</button>
            <button class="btn btn-outline" onclick="closeModal('nft-modal')" style="margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="boost-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>–£–ª—É—á—à–µ–Ω–∏—è</h3>
            <p>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏</p>
            <button class="btn" onclick="buyRegen()">–£–ª—É—á—à–∏—Ç—å (5000)</button>
            <button class="btn-outline btn" onclick="closeModal('boost-modal')" style="margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <!-- Nav -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home', this)"><i class="ri-home-line"></i><span>–î–æ–º</span></div>
        <div class="nav-item" onclick="nav('shop', this)"><i class="ri-store-line"></i><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" onclick="nav('casino', this)"><i class="ri-gamepad-line"></i><span>–ò–≥—Ä—ã</span></div>
        <div class="nav-item" onclick="nav('profile', this)"><i class="ri-user-line"></i><span>–Ø</span></div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg", authDomain: "nfts-dc174.firebaseapp.com", projectId: "nfts-dc174", storageBucket: "nfts-dc174.firebasestorage.app", messagingSenderId: "327365720624", appId: "1:327365720624:web:eb42c9d671566b5d118bf5" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        // LIMITED ASSETS LIST (12 Items)
        const BASE = "https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis";
        const ASSETS = [
            {id: "crown", n: "–ö–æ—Ä–æ–Ω–∞", t: "GOD", u: "/Objects/Crown.png", p: 1000000, l: 3},
            {id: "ufo", n: "–ù–õ–û", t: "GOD", u: "/Travel%20and%20places/Flying%20Saucer.png", p: 800000, l: 5},
            {id: "dragon", n: "–î—Ä–∞–∫–æ–Ω", t: "LEGEND", u: "/Animals/Dragon.png", p: 500000, l: 10},
            {id: "castle", n: "–ó–∞–º–æ–∫", t: "LEGEND", u: "/Travel%20and%20places/Castle.png", p: 450000, l: 10},
            {id: "rocket", n: "–†–∞–∫–µ—Ç–∞", t: "EPIC", u: "/Travel%20and%20places/Rocket.png", p: 100000, l: 50},
            {id: "diamond", n: "–ê–ª–º–∞–∑", t: "EPIC", u: "/Objects/Gem%20Stone.png", p: 100000, l: 50},
            {id: "car", n: "–°—É–ø–µ—Ä–∫–∞—Ä", t: "RARE", u: "/Travel%20and%20places/Automobile.png", p: 50000, l: 100},
            {id: "plane", n: "–î–∂–µ—Ç", t: "RARE", u: "/Travel%20and%20places/Airplane.png", p: 50000, l: 100},
            {id: "laptop", n: "–ú–∞–∫–±—É–∫", t: "UNCOMMON", u: "/Objects/Laptop.png", p: 10000, l: 500},
            {id: "phone", n: "–ê–π—Ñ–æ–Ω", t: "UNCOMMON", u: "/Objects/Mobile%20Phone.png", p: 8000, l: 500},
            {id: "pizza", n: "–ü–∏—Ü—Ü–∞", t: "COMMON", u: "/Food/Pizza.png", p: 1000, l: 5000},
            {id: "cat", n: "–ö–æ—Ç", t: "COMMON", u: "/Animals/Cat%20Face.png", p: 1000, l: 5000}
        ];

        let myNick = localStorage.getItem('nft_nick');
        let data = null;
        let lastTap = 0;
        let selectedItemIdx = -1;

        if (myNick) checkSession();

        function auth() {
            const n = document.getElementById('auth-nick').value.trim();
            const p = document.getElementById('auth-pass').value.trim();
            if (!n || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");

            db.collection('users').doc(n).get().then(doc => {
                if (doc.exists) {
                    if (doc.data().password === p) loginSuccess(n);
                    else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
                } else {
                    // Register
                    db.collection('users').doc(n).set({
                        nickname: n, password: p, balance: 0, energy: 100,
                        inventory: [], regenLvl: 1, isBanned: false
                    }).then(() => loginSuccess(n));
                }
            });
        }

        function loginSuccess(n) {
            localStorage.setItem('nft_nick', n);
            myNick = n;
            document.getElementById('auth-modal').style.display = 'none';
            checkSession();
        }

        function logout() {
            localStorage.removeItem('nft_nick');
            location.reload();
        }

        function checkSession() {
            db.collection('users').doc(myNick).onSnapshot(doc => {
                if (doc.exists) {
                    data = doc.data();
                    if (data.isBanned) {
                        document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:50px;'>–í–´ –ó–ê–ë–ê–ù–ï–ù–´ –ó–ê –ß–ò–¢–´</h1>";
                        return;
                    }
                    updateUI();
                    renderShop();
                    
                    // Admin Check
                    if (myNick === 'kayivi') document.getElementById('admin-panel').style.display = 'block';
                }
            });

            // Energy Regen Loop
            setInterval(() => {
                if (data && data.energy < 100) {
                    // Regen speed based on level
                    const regenAmount = data.regenLvl ? data.regenLvl : 1;
                    db.collection('users').doc(myNick).update({
                        energy: Math.min(100, data.energy + regenAmount)
                    });
                }
            }, 2000); // Every 2 seconds
        }

        function updateUI() {
            document.getElementById('my-nick').innerText = myNick;
            document.getElementById('my-frame').innerText = myNick[0].toUpperCase();
            document.getElementById('balance').innerText = Math.floor(data.balance).toLocaleString();
            document.getElementById('energy').innerText = data.energy;
            document.getElementById('my-id').innerText = myNick; // Simple ID

            const inv = document.getElementById('inventory-list');
            inv.innerHTML = '';
            
            // Render Inventory with safe checks for undefined
            if (data.inventory) {
                data.inventory.forEach((item, idx) => {
                    // Fallback for old data structure
                    const name = item.n || item.name || "Error Item";
                    const type = item.t || item.type || "???";
                    const url = item.u || item.url || "/Symbols/Question%20Mark.png";
                    const serial = item.s || item.serial || "?";

                    inv.innerHTML += `
                        <div class="card" onclick="openNFT(${idx})">
                            <div style="font-size:9px; color:#888;">${type}</div>
                            <img src="${BASE + url}" class="nft-img">
                            <div style="font-weight:bold; font-size:12px;">${name}</div>
                            <div style="font-size:9px;">#${serial}</div>
                        </div>
                    `;
                });
            }
        }

        // --- GAMEPLAY ---
        function tap(e) {
            e.preventDefault(); // Prevent zoom double tap
            if (data.energy <= 0) return toast("–ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏!");
            
            // Relaxed Anti-Cheat: Just cooldown, no ban
            const now = Date.now();
            if (now - lastTap < 60) return; // Too fast, ignore click (60ms limit)
            lastTap = now;

            // Visual Float
            const touch = e.touches ? e.touches[0] : e;
            const float = document.createElement('div');
            float.className = 'float-text';
            float.innerText = "+1";
            float.style.left = touch.clientX + 'px';
            float.style.top = touch.clientY + 'px';
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 800);

            // Logic
            db.collection('users').doc(myNick).update({
                balance: firebase.firestore.FieldValue.increment(1),
                energy: firebase.firestore.FieldValue.increment(-1)
            });
            
            // Local update for smoothness
            data.balance++; 
            data.energy--;
            document.getElementById('balance').innerText = data.balance.toLocaleString();
            document.getElementById('energy').innerText = data.energy;
        }

        // --- SHOP ---
        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = '';
            
            // Get global stats for stock
            db.collection('game').doc('stats').get().then(doc => {
                const stats = doc.exists ? doc.data().items : {};

                ASSETS.forEach(item => {
                    const sold = stats[item.n] || 0; // Use name as key
                    const left = item.l - sold;
                    // Dynamic price: +1% per sale
                    const price = Math.floor(item.p * (1 + (sold * 0.01)));

                    const el = document.createElement('div');
                    el.className = 'card';
                    el.style.opacity = left <= 0 ? 0.5 : 1;
                    el.innerHTML = `
                        <div style="font-size:9px; color:red; position:absolute; top:5px; right:5px;">${left}/${item.l}</div>
                        <img src="${BASE + item.u}" class="nft-img">
                        <div style="font-size:12px; font-weight:bold;">${item.n}</div>
                        <div style="font-size:11px; color:#gold;">${price.toLocaleString()} üíé</div>
                        <button class="btn-sm btn-outline" style="margin-top:5px;" onclick="buyItem('${item.id}', ${price})" ${left<=0 ? 'disabled' : ''}>–ö—É–ø–∏—Ç—å</button>
                    `;
                    list.appendChild(el);
                });
            });
        }

        function buyItem(id, price) {
            if (data.balance < price) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–µ–Ω–µ–≥");

            const itemRef = ASSETS.find(x => x.id === id);
            
            // Transaction for safety
            db.runTransaction(async (t) => {
                const statsRef = db.collection('game').doc('stats');
                const userRef = db.collection('users').doc(myNick);
                
                const statsDoc = await t.get(statsRef);
                let stats = statsDoc.exists ? statsDoc.data().items : {};
                const sold = stats[itemRef.n] || 0;

                if (sold >= itemRef.l) throw "–†–∞—Å–∫—É–ø–ª–µ–Ω–æ!";

                // Create new Item Object (Standardized)
                const newItem = {
                    n: itemRef.n, // name
                    t: itemRef.t, // type
                    u: itemRef.u, // url
                    p: itemRef.p, // original price
                    s: sold + 1   // serial number
                };

                t.update(userRef, {
                    balance: firebase.firestore.FieldValue.increment(-price),
                    inventory: firebase.firestore.FieldValue.arrayUnion(newItem)
                });

                t.set(statsRef, { items: { ...stats, [itemRef.n]: sold + 1 } }, { merge: true });

            }).then(() => {
                toast("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!");
            }).catch(e => toast(e));
        }

        // --- INVENTORY & P2P ---
        function openNFT(idx) {
            selectedItemIdx = idx;
            const item = data.inventory[idx];
            document.getElementById('modal-name').innerText = item.n || item.name;
            document.getElementById('modal-id').innerText = "#" + (item.s || item.serial);
            document.getElementById('modal-img').src = BASE + (item.u || item.url);
            document.getElementById('nft-modal').style.display = 'flex';
        }

        function sellP2P() {
            const price = parseInt(document.getElementById('sell-price').value);
            if (!price || price <= 0) return toast("–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É");

            const item = data.inventory[selectedItemIdx];

            // Remove from inventory, add to market
            db.collection('users').doc(myNick).update({
                inventory: firebase.firestore.FieldValue.arrayRemove(item)
            }).then(() => {
                db.collection('market').add({
                    seller: myNick,
                    item: item,
                    price: price,
                    ts: Date.now()
                });
                closeModal('nft-modal');
                toast("–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ –±–∏—Ä–∂—É");
            });
        }

        function loadP2P() {
            const list = document.getElementById('p2p-list');
            list.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            db.collection('market').orderBy('ts', 'desc').limit(20).get().then(snap => {
                list.innerHTML = '';
                if (snap.empty) {
                    list.innerHTML = '<div style="grid-column:1/-1; text-align:center;">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</div>';
                    return;
                }
                snap.forEach(doc => {
                    const offer = doc.data();
                    const isMe = offer.seller === myNick;
                    // Standardize item reading
                    const iName = offer.item.n || offer.item.name;
                    const iUrl = offer.item.u || offer.item.url;

                    list.innerHTML += `
                        <div class="card">
                            <div style="font-size:9px;">Seller: ${offer.seller}</div>
                            <img src="${BASE + iUrl}" class="nft-img">
                            <div style="font-weight:bold;">${iName}</div>
                            <div>${offer.price} üíé</div>
                            <button class="btn-sm ${isMe ? 'btn-danger' : 'btn-success'}" 
                                onclick="${isMe ? `cancelSell('${doc.id}')` : `buyP2P('${doc.id}', ${offer.price})`}">
                                ${isMe ? '–°–Ω—è—Ç—å' : '–ö—É–ø–∏—Ç—å'}
                            </button>
                        </div>
                    `;
                });
            });
        }

        function buyP2P(docId, price) {
            if (data.balance < price) return toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");

            db.runTransaction(async t => {
                const offerRef = db.collection('market').doc(docId);
                const offerDoc = await t.get(offerRef);
                if (!offerDoc.exists) throw "–ü—Ä–µ–¥–º–µ—Ç —É–∂–µ –∫—É–ø–ª–µ–Ω";

                const offer = offerDoc.data();
                
                // Deduct money from buyer, add item
                t.update(db.collection('users').doc(myNick), {
                    balance: firebase.firestore.FieldValue.increment(-price),
                    inventory: firebase.firestore.FieldValue.arrayUnion(offer.item)
                });
                
                // Add money to seller
                t.update(db.collection('users').doc(offer.seller), {
                    balance: firebase.firestore.FieldValue.increment(price)
                });

                t.delete(offerRef);
            }).then(() => {
                toast("–ö—É–ø–ª–µ–Ω–æ!");
                loadP2P();
            }).catch(e => toast(e));
        }
        
        function cancelSell(docId) {
             db.collection('market').doc(docId).get().then(doc => {
                 if(doc.exists) {
                     const item = doc.data().item;
                     db.collection('users').doc(myNick).update({
                         inventory: firebase.firestore.FieldValue.arrayUnion(item)
                     });
                     doc.ref.delete();
                     toast("–°–Ω—è—Ç–æ —Å –ø—Ä–æ–¥–∞–∂–∏");
                     setTimeout(loadP2P, 500);
                 }
             });
        }

        // --- CASINO ---
        function playDice(pick) {
            const bet = parseInt(document.getElementById('dice-bet').value);
            if (!bet || bet > data.balance || bet <= 0) return toast("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç–∞–≤–∫–∞");

            db.collection('users').doc(myNick).update({
                balance: firebase.firestore.FieldValue.increment(-bet)
            }).then(() => {
                const r1 = Math.ceil(Math.random() * 6);
                const r2 = Math.ceil(Math.random() * 6);
                const sum = r1 + r2;
                document.getElementById('dice-result').innerText = `${r1} + ${r2} = ${sum}`;

                let win = 0;
                if (pick === 'low' && sum < 7) win = bet * 2;
                else if (pick === 'high' && sum > 7) win = bet * 2;
                else if (pick === '7' && sum === 7) win = bet * 5;

                if (win > 0) {
                    db.collection('users').doc(myNick).update({
                        balance: firebase.firestore.FieldValue.increment(win)
                    });
                    toast(`–ü–æ–±–µ–¥–∞! +${win}`);
                } else {
                    toast("–ü—Ä–æ–∏–≥—Ä—ã—à");
                }
            });
        }

        // --- ADMIN FUNCTIONS ---
        function admGiveMoney() {
            const target = document.getElementById('adm-target').value;
            const amount = parseInt(document.getElementById('adm-amount').value);
            if (!target || !amount) return;
            db.collection('users').doc(target).update({
                balance: firebase.firestore.FieldValue.increment(amount)
            }).then(() => toast(`–í—ã–¥–∞–Ω–æ ${amount} –∏–≥—Ä–æ–∫—É ${target}`));
        }

        function admResetShop() {
            if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤?")) {
                db.collection('game').doc('stats').set({ items: {} });
                toast("–ú–∞–≥–∞–∑–∏–Ω —Å–±—Ä–æ—à–µ–Ω");
            }
        }
        
        function admPopulateMarket() {
            // Adds dummy listings
            const botItem = ASSETS[Math.floor(Math.random() * ASSETS.length)];
            const fakeItem = { n: botItem.n, u: botItem.u, t: botItem.t, s: 999 };
            db.collection('market').add({
                seller: "Kayivi_Bot",
                item: fakeItem,
                price: Math.floor(Math.random() * 5000) + 1000,
                ts: Date.now()
            });
            toast("–ë–æ—Ç –≤—ã—Å—Ç–∞–≤–∏–ª –ø—Ä–µ–¥–º–µ—Ç");
        }

        function admUnban() {
            const target = document.getElementById('adm-target').value;
            db.collection('users').doc(target).update({ isBanned: false });
            toast("–†–∞–∑–±–∞–Ω–µ–Ω");
        }

        // --- UTILS ---
        function buyRegen() {
            if (data.balance >= 5000) {
                db.collection('users').doc(myNick).update({
                    balance: firebase.firestore.FieldValue.increment(-5000),
                    regenLvl: firebase.firestore.FieldValue.increment(1)
                });
                closeModal('boost-modal');
                toast("–£–ª—É—á—à–µ–Ω–æ!");
            } else toast("–ú–∞–ª–æ –¥–µ–Ω–µ–≥");
        }

        function nav(screen, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screen).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(screen === 'shop') switchTab('shop', 'official');
        }

        function switchTab(screen, tabId) {
            document.getElementById(screen + '-official').style.display = tabId === 'official' ? 'block' : 'none';
            document.getElementById(screen + '-p2p').style.display = tabId === 'p2p' ? 'block' : 'none';
            if(tabId === 'p2p') loadP2P();
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }
    </script>
</body>
</html>
