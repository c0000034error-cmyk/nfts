<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NFT Universe: ULTRA 3D</title>
    
    <!-- Firebase SDK (–°—Ç–∞–±–∏–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --surface: #121212;
            --primary: #6366f1;
            --accent: #d946ef;
            --gold: #fbbf24;
            --danger: #ef4444;
            --success: #10b981;
            --text: #ffffff;
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            perspective: 1000px; /* –î–ª—è 3D */
        }

        /* --- UI COMPONENTS --- */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: #fff; border: none; padding: 14px; border-radius: 12px;
            font-weight: 700; font-size: 14px; width: 100%; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); transition: 0.1s; position: relative; overflow: hidden;
        }
        .btn::after { content:''; position: absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: 0.5s; }
        .btn:active::after { left: 100%; transition: 0s; }
        .btn:active { transform: scale(0.96); }
        .btn-outline { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); box-shadow: none; color:white; }
        .btn-danger { background: var(--danger); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
        .btn-gold { background: var(--gold); color: black; box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4); }
        .btn-sm { padding: 6px 12px; font-size: 11px; width: auto; border-radius: 8px; }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }

        input, select {
            background: #222; border: 1px solid #333;
            padding: 12px; border-radius: 12px; color: white; width: 100%; outline: none; margin-bottom: 10px; font-size: 16px; transition: 0.3s;
        }
        input:focus { border-color: var(--primary); background: #2a2a2a; }

        /* --- HEADER & NAV --- */
        .header {
            padding: 10px 15px; padding-top: max(10px, env(safe-area-inset-top));
            background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(15px);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 50;
        }

        .avatar-container { position: relative; width: 45px; height: 45px; display:flex; justify-content: center; align-items: center; }
        .avatar-frame {
            width: 100%; height: 100%; border-radius: 50%; background: #222;
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px;
            border: 2px solid #333; position: relative; z-index: 2; overflow: hidden;
        }
        .orbiter { position: absolute; width: 22px; height: 22px; z-index: 1; pointer-events: none; filter: drop-shadow(0 0 5px black); }
        @keyframes orbit { from { transform: rotate(0deg) translateX(50px) rotate(0deg); } to { transform: rotate(360deg) translateX(50px) rotate(-360deg); } }
        .orb-1 { animation: orbit 5s linear infinite; }
        .orb-2 { animation: orbit 7s linear infinite reverse; }
        .orb-3 { animation: orbit 9s linear infinite; }

        /* --- CONTENT AREA --- */
        .content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 110px; opacity: 0; transition: opacity 0.5s; }
        .content.loaded { opacity: 1; }
        .screen { display: none; animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .screen.active { display: block; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- TAPPER --- */
        #tap-btn { 
            width: 260px; height: 260px; margin: 0 auto;
            border-radius: 50%; position: relative; 
            background: radial-gradient(circle at 30% 30%, #4f46e5, #000);
            box-shadow: 0 0 50px rgba(79, 70, 229, 0.3), inset 0 0 20px rgba(255,255,255,0.1);
            border: 4px solid rgba(255,255,255,0.05);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.05s; cursor: pointer;
            z-index: 10;
        }
        #tap-btn:active { transform: scale(0.94); }
        #tap-btn img { width: 160px; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); pointer-events: none; transition: 0.1s; }
        #tap-btn:active img { transform: scale(1.1) rotate(5deg); }
        
        .floating-text {
            position: absolute; font-weight: bold; pointer-events: none; z-index: 1000;
            animation: floatUp 0.8s ease-out forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity:1; } 100% { transform: translateY(-100px) scale(1.2); opacity:0; } }

        /* --- CARDS & GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 10px; padding-bottom: 20px; }
        .card {
            border-radius: var(--radius); padding: 10px; position: relative;
            display: flex; flex-direction: column; align-items: center;
            background: #18181b; border: 1px solid rgba(255,255,255,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:active { transform: scale(0.95); }
        
        .nft-img { width: 80px; height: 80px; object-fit: contain; margin: 10px 0; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }
        .nft-pill { position: absolute; top:8px; left:8px; font-size: 8px; padding: 2px 6px; border-radius: 6px; background: rgba(0,0,0,0.6); color: #fff; backdrop-filter: blur(4px); }
        
        /* RARITY COLORS */
        .r-common { border-bottom: 3px solid #9ca3af; }
        .r-rare { border-bottom: 3px solid #3b82f6; box-shadow: 0 5px 15px rgba(59, 130, 246, 0.1); }
        .r-epic { border-bottom: 3px solid #a855f7; box-shadow: 0 5px 15px rgba(168, 85, 247, 0.15); }
        .r-leg { border-bottom: 3px solid #eab308; background: linear-gradient(180deg, #18181b 0%, #2a2008 100%); border-color: #eab308; }

        /* --- 3D INSPECT CARD STYLES --- */
        .modal-3d-wrapper {
            perspective: 1200px;
            width: 240px; height: 320px;
            margin: 20px auto;
            position: relative;
        }
        .card-3d {
            width: 100%; height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out; /* Smooth follow */
            border-radius: 20px;
        }
        /* Layers for Parallax */
        .layer-bg {
            position: absolute; top:0; left:0; width:100%; height:100%;
            border-radius: 20px;
            background: radial-gradient(circle, #333, #000);
            transform: translateZ(0px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.1);
        }
        .layer-img {
            position: absolute; top: 50%; left: 50%;
            width: 160px; height: 160px;
            transform: translate(-50%, -50%) translateZ(40px); /* Pops out */
            filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6));
            object-fit: contain;
        }
        .layer-shine {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: linear-gradient(135deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.0) 40%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 60%);
            border-radius: 20px;
            transform: translateZ(1px);
            opacity: 0.6; pointer-events: none; mix-blend-mode: overlay;
        }
        .layer-txt {
            position: absolute; bottom: 20px; width: 100%; text-align: center;
            transform: translateZ(20px);
            text-shadow: 0 2px 4px black; font-weight: 800; font-size: 18px; color: white;
        }
        
        .auto-rotate { animation: autoRotate 6s infinite ease-in-out; }
        @keyframes autoRotate { 0% { transform: rotateY(-15deg) rotateX(5deg); } 50% { transform: rotateY(15deg) rotateX(-5deg); } 100% { transform: rotateY(-15deg) rotateX(5deg); } }


        /* --- UI HELPERS --- */
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,35,0.95); padding: 12px 24px; border-radius: 40px; z-index: 9999; display: none; border: 1px solid rgba(255,255,255,0.1); font-size: 14px; font-weight: 600; box-shadow: 0 15px 40px rgba(0,0,0,0.6); color: white; align-items: center; gap: 10px; animation: slideDownToast 0.3s; }
        @keyframes slideDownToast { from { top: -50px; } to { top: 20px; } }

        .navbar { position: fixed; bottom: 0; width: 100%; background: rgba(18, 18, 20, 0.9); display: flex; justify-content: space-around; padding: 10px 0; padding-bottom: max(14px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(20px); z-index: 100; }
        .nav-item { color: #52525b; font-size: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; position: relative; }
        .nav-item i { font-size: 24px; transition: 0.2s; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-4px); filter: drop-shadow(0 4px 10px var(--primary)); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal-box { width: 100%; max-width: 380px; background: #1c1c20; padding: 24px; border-radius: 30px; text-align: center; box-shadow: 0 20px 80px rgba(0,0,0,0.9); border: 1px solid rgba(255,255,255,0.08); position: relative; }

        /* Tabs */
        .tabs { display: flex; background: #27272a; padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-size: 13px; color: #a1a1aa; cursor: pointer; transition: 0.2s; }
        .tab.active { background: #3f3f46; color: white; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }

        /* Loader */
        .loader-ring { display: inline-block; width: 24px; height: 24px; }
        .loader-ring:after { content: " "; display: block; width: 20px; height: 20px; margin: 2px; border-radius: 50%; border: 2px solid var(--primary); border-color: var(--primary) transparent var(--primary) transparent; animation: ring 1.2s linear infinite; }
        @keyframes ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Slots Styles */
        .slot-machine { background: #000; border: 4px solid var(--gold); border-radius: 20px; padding: 20px; box-shadow: 0 0 40px rgba(251, 191, 36, 0.2); }
        .reels-container { display: flex; gap: 8px; justify-content: center; margin: 15px 0; background: #111; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .reel { width: 60px; height: 80px; background: white; border-radius: 6px; overflow: hidden; position: relative; font-size: 36px; line-height: 80px; color:black; text-shadow:none;}
        .strip { position: absolute; top:0; left:0; width:100%; text-align: center; transition: top 0.1s linear; }

        .craft-zone {
            border: 2px dashed #444; border-radius: 20px; min-height: 100px; margin: 20px 0;
            display: flex; align-items: center; justify-content: center; color: #666; font-size: 14px;
            flex-wrap: wrap; gap: 10px; padding: 10px; transition: 0.3s;
        }
        .craft-zone.valid { border-color: var(--success); background: rgba(16, 185, 129, 0.1); color: var(--success); }

    </style>
</head>
<body>

    <!-- AUTH & LOADING SCREEN -->
    <div id="auth-modal" class="modal-overlay" style="display:flex; z-index:9000; background:#000;">
        <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <!-- Loading View -->
            <div id="view-loading" style="text-align:center; display:none;">
                <div style="font-size: 60px; margin-bottom: 20px; animation: orbit 2s linear infinite;">üõ∏</div>
                <h2 style="margin:0;">–ó–ê–ì–†–£–ó–ö–ê...</h2>
                <div style="color:#666; margin-top:10px; font-size:12px;">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Å–µ–ª–µ–Ω–Ω–æ–π NFT</div>
                <button onclick="resetApp()" class="btn-sm btn-outline" style="margin-top:30px; width:auto; display:none;" id="retry-btn">–°–±—Ä–æ—Å / –í—ã—Ö–æ–¥</button>
            </div>

            <!-- Login View -->
            <div id="view-auth" class="modal-box" style="border:none; background:transparent;">
                <div style="font-size: 70px; margin-bottom: 20px;">üèÜ</div>
                <h1 style="margin-bottom: 5px; font-weight:900; letter-spacing: 1px; color: white;">NFT UNIVERSE</h1>
                <div style="color:var(--danger); font-size:12px; letter-spacing:4px; margin-bottom:40px; font-weight:bold;">ULTRA 3D EDITION</div>
                
                <div style="background: #1c1c20; padding: 30px; border-radius: 24px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <div style="display:flex; background:#111; border-radius:12px; margin-bottom:20px; padding:4px;">
                        <div id="tab-login" class="tab active" onclick="toggleAuth(false)">–í—Ö–æ–¥</div>
                        <div id="tab-reg" class="tab" onclick="toggleAuth(true)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
                    </div>
                    
                    <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º (eng)">
                    <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px; font-size:13px; color:#888;">
                        <input type="checkbox" id="remember-me" checked style="width:auto; margin:0; cursor:pointer;"> 
                        <label for="remember-me">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
                    </div>
                    
                    <button class="btn" onclick="submitAuth()">
                        <span id="btn-text">–í–û–ô–¢–ò</span> <span class="loader-ring" id="btn-load" style="display:none; width:16px; height:16px;"></span>
                    </button>
                    <div id="auth-error" style="color:var(--danger); font-size:12px; margin-top:15px; min-height:16px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN UI HEADER -->
    <div class="header">
        <div style="display:flex; gap:12px; align-items:center;">
            <div class="avatar-container" onclick="nav('profile')">
                <div id="my-frame" class="avatar-frame">U</div>
                <img src="" class="orbiter orb-1" id="orb-1" style="display:none;">
                <img src="" class="orbiter orb-2" id="orb-2" style="display:none;">
            </div>
            <div>
                <div id="my-nick" style="font-weight:700; font-size:15px;">Player</div>
                <div style="font-size:13px; color:var(--text-sec); display:flex; gap:6px; align-items:center;">
                    <i class="ri-vip-diamond-fill" style="color:var(--gold)"></i> <span id="balance">0</span>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:8px;">
            <div style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:20px; font-size:12px; display:flex; align-items:center; gap:5px;">
                ‚ö° <span id="energy">100</span>
            </div>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="content" id="main-content">

        <!-- 1. HOME -->
        <div id="screen-home" class="screen active">
            <div style="text-align:center; min-height:24px; margin-bottom:10px; font-weight:800; color:var(--gold); text-transform: uppercase; font-size:20px; text-shadow:0 0 20px var(--gold);" id="combo-text"></div>
            
            <div id="tap-btn">
                <img src="https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis/Objects/Money%20Bag.png">
            </div>

            <div style="text-align:center; font-size:13px; color:#555; margin-top:30px; margin-bottom:10px;">–≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–∞–º–∞...</div>
            
            <div style="padding: 10px 0; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (<span id="inv-count">0</span>)</h3>
                <button class="btn-sm btn-outline" onclick="nav('craft')">üî® –ö—Ä–∞—Ñ—Ç</button>
            </div>
            <div class="grid" id="inventory-list"></div>
        </div>

        <!-- 2. MARKET -->
        <div id="screen-market" class="screen">
            <div class="tabs">
                <div class="tab active" onclick="switchMarket('shop', this)">Global Shop</div>
                <div class="tab" onclick="switchMarket('p2p', this)">–ò–≥—Ä–æ–∫–∏</div>
            </div>
            
            <div id="view-shop">
                <div style="padding: 0 0 10px 0; display:flex; overflow-x:auto; gap:8px;">
                     <button class="btn-sm" onclick="renderShop('all')">–í—Å–µ</button>
                     <button class="btn-sm btn-outline" onclick="renderShop('–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ')">Legend</button>
                     <button class="btn-sm btn-outline" onclick="renderShop('–ñ–∏–≤–æ—Ç–Ω—ã–µ')">Animals</button>
                     <button class="btn-sm btn-outline" onclick="renderShop('–¢–µ—Ö–Ω–æ')">Tech</button>
                </div>
                <div class="grid" id="shop-list"></div>
            </div>
            
            <div id="view-p2p" style="display:none;">
                <button class="btn btn-outline" onclick="loadP2P()" style="width:100%; margin-bottom:15px;">–û–±–Ω–æ–≤–∏—Ç—å —Ä—ã–Ω–æ–∫</button>
                <div class="grid" id="p2p-list"></div>
            </div>
        </div>

        <!-- 3. CRAFTING SYSTEM (NEW) -->
        <div id="screen-craft" class="screen">
            <h2 style="text-align:center; margin-top:0;">–°–∏–Ω—Ç–µ–∑ –ü—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
            <p style="text-align:center; font-size:12px; color:#aaa;">–û–±—ä–µ–¥–∏–Ω–∏ 3 –ª—é–±—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ –æ–¥–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å 1 –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–π –ø—Ä–µ–¥–º–µ—Ç.</p>
            
            <div class="craft-zone" id="craft-slots" onclick="fillCraftFromInv()">
                –ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å 3 –ø—Ä–µ–¥–º–µ—Ç–∞
            </div>

            <button id="craft-btn" class="btn" onclick="doCraft()" disabled>–°–ò–ù–¢–ï–ó (0/3)</button>
            
            <h3 style="margin-top:30px;">–¢–≤–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã:</h3>
            <div class="grid" id="craft-inv-list"></div>
        </div>

        <!-- 4. CASINO -->
        <div id="screen-casino" class="screen">
            <div class="slot-machine">
                <div style="text-align:center; color:#eab308; margin-bottom:10px; font-weight:bold;">SUPER SLOTS 777</div>
                <div class="reels-container">
                    <div class="reel" id="reel-1"><div class="strip">üçí</div></div>
                    <div class="reel" id="reel-2"><div class="strip">üçí</div></div>
                    <div class="reel" id="reel-3"><div class="strip">üçí</div></div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:#666;">
                    <span>–ú–Ω–æ–∂–∏—Ç–µ–ª—å: x10 - x50</span>
                    <span>–î–∂–µ–∫–ø–æ—Ç: 777</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="bet-input" placeholder="–°—Ç–∞–≤–∫–∞" value="100">
                    <button class="btn btn-gold" id="spin-btn" onclick="spinSlots()">SPIN</button>
                </div>
            </div>
            
            <h3 style="margin-top:30px;">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ù–∞–≥—Ä–∞–¥–∞</h3>
            <div class="card" style="flex-direction:row; justify-content:space-between; align-items:center;">
                <div style="text-align:left; flex:1;">
                    <div style="font-weight:bold;">–ë–æ–Ω—É—Å –í—Ö–æ–¥–∞</div>
                    <div style="font-size:11px; color:#888;" id="daily-timer">–î–æ—Å—Ç—É–ø–Ω–æ!</div>
                </div>
                <button class="btn-sm btn-success" id="daily-btn" onclick="claimDaily()">–ó–ê–ë–†–ê–¢–¨ 500üíé</button>
            </div>
        </div>
        
        <!-- 5. PROFILE -->
        <div id="screen-profile" class="screen">
            <button class="btn-outline btn" onclick="openModal('boost-modal')" style="margin-bottom:15px;">
                ‚ö° –ü—Ä–æ–∫–∞—á–∫–∞ –ù–∞–≤—ã–∫–æ–≤
            </button>
            <div style="background:#18181b; padding:15px; border-radius:16px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>–ó–≤—É–∫–∏</span> <input type="checkbox" style="width:auto;" checked disabled>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>–í–µ—Ä—Å–∏—è</span> <span style="color:#666;">v3.0 Ultra</span>
                </div>
                <button class="btn btn-outline" onclick="resetApp()" style="margin-top:20px; border-color:var(--danger); color:var(--danger);">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
            </div>
        </div>

    </div>

    <!-- MODAL: NFT DETAILS (WITH 3D) -->
    <div id="nft-modal" class="modal-overlay">
        <div class="modal-box" style="overflow:visible;"> <!-- visible overflow for 3d effect -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="modal-name" style="margin:0; font-size:20px;">Name</h2>
                <div style="background:#333; padding:2px 8px; border-radius:6px; font-size:12px;" id="modal-rarity">Common</div>
            </div>
            
            <!-- 3D AREA -->
            <div class="modal-3d-wrapper" id="card-wrapper">
                <div class="card-3d auto-rotate" id="card-3d-el">
                    <div class="layer-bg" id="modal-card-bg"></div>
                    <img src="" class="layer-img" id="modal-card-img">
                    <div class="layer-shine"></div>
                    <div class="layer-txt" id="modal-card-serial">#001</div>
                </div>
            </div>

            <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                 <button class="btn-sm btn-outline" id="btn-toggle-3d" onclick="toggle3DInteraction()">üñê –í–∫–ª—é—á–∏—Ç—å 3D –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</button>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="equipNft()">–ù–∞–¥–µ—Ç—å</button>
                <button class="btn btn-danger" onclick="sellSystem()">–ü—Ä–æ–¥–∞—Ç—å (+<span id="sys-price">0</span>)</button>
            </div>
            
            <button onclick="closeModal('nft-modal')" style="background:transparent; border:none; color:#555; margin-top:20px; font-size:12px;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <!-- MODAL: UPGRADES -->
    <div id="boost-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>–ú–∞–≥–∞–∑–∏–Ω –£–º–µ–Ω–∏–π</h3>
            <div style="margin-bottom:15px; background:#111; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-weight:bold; color:var(--primary);">–ú—É–ª—å—Ç–∏-–¢–∞–ø</div>
                    <div style="font-size:10px; color:#888;">–£—Ä–æ–≤–µ–Ω—å: <span id="lvl-tap">1</span></div>
                </div>
                <button class="btn-sm" onclick="buyUpgrade('tap')">UP (<span id="cost-tap">100</span>üíé)</button>
            </div>
            <div style="margin-bottom:15px; background:#111; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-weight:bold; color:var(--danger);">–®–∞–Ω—Å –ö—Ä–∏—Ç–∞</div>
                    <div style="font-size:10px; color:#888;">–£—Ä–æ–≤–µ–Ω—å: <span id="lvl-crit">1</span></div>
                </div>
                <button class="btn-sm" onclick="buyUpgrade('crit')">UP (<span id="cost-crit">500</span>üíé)</button>
            </div>
            <div style="margin-bottom:15px; background:#111; padding:10px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                <div style="text-align:left;">
                    <div style="font-weight:bold; color:var(--success);">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫</div>
                    <div style="font-size:10px; color:#888;">–£—Ä–æ–≤–µ–Ω—å: <span id="lvl-regen">1</span></div>
                </div>
                <button class="btn-sm" onclick="buyUpgrade('regen')">UP (<span id="cost-regen">300</span>üíé)</button>
            </div>
            <button class="btn-outline" onclick="closeModal('boost-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- NAV BAR -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home', this)"><i class="ri-home-4-fill"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></div>
        <div class="nav-item" onclick="nav('market', this)"><i class="ri-store-3-fill"></i><span>–†—ã–Ω–æ–∫</span></div>
        <div class="nav-item" onclick="nav('casino', this)"><i class="ri-gamepad-fill"></i><span>–ò–≥—Ä—ã</span></div>
        <div class="nav-item" onclick="nav('profile', this)"><i class="ri-user-5-fill"></i><span>–ú–µ–Ω—é</span></div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg", authDomain: "nfts-dc174.firebaseapp.com", projectId: "nfts-dc174", storageBucket: "nfts-dc174.firebasestorage.app", messagingSenderId: "327365720624", appId: "1:327365720624:web:eb42c9d671566b5d118bf5" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();
        const BASE_URL = "https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis";

        // ASSETS DATABASE
        const ASSETS = [
             {n: "–ö–æ—à–µ–ª–µ–∫", u: "/Objects/Purse.png", t: "Common", p: 100},
             {n: "–ö–µ–ø–∫–∞", u: "/Objects/Billed%20Cap.png", t: "Common", p: 150},
             {n: "–ß–∞—Å—ã", u: "/Objects/Watch.png", t: "Common", p: 200},
             {n: "–î–∂–æ–π—Å—Ç–∏–∫", u: "/Activities/Video%20Game.png", t: "–¢–µ—Ö–Ω–æ", p: 500},
             {n: "–ù–æ—É—Ç–±—É–∫", u: "/Objects/Laptop.png", t: "–¢–µ—Ö–Ω–æ", p: 1500},
             {n: "–†–æ–±–æ—Ç", u: "/Smilies/Robot.png", t: "–¢–µ—Ö–Ω–æ", p: 3000},
             {n: "–†–∞–∫–µ—Ç–∞", u: "/Travel%20and%20places/Rocket.png", t: "–¢–µ—Ö–Ω–æ", p: 8000},
             {n: "–ö–æ—Ç", u: "/Animals/Cat.png", t: "–ñ–∏–≤–æ—Ç–Ω—ã–µ", p: 1000},
             {n: "–¢–∏–≥—Ä", u: "/Animals/Tiger.png", t: "–ñ–∏–≤–æ—Ç–Ω—ã–µ", p: 2500},
             {n: "–î—Ä–∞–∫–æ–Ω", u: "/Animals/Dragon.png", t: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ", p: 50000},
             {n: "–ï–¥–∏–Ω–æ—Ä–æ–≥", u: "/Animals/Unicorn.png", t: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ", p: 40000},
             {n: "–ù–õ–û", u: "/Travel%20and%20places/Flying%20Saucer.png", t: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ", p: 60000},
             {n: "–ö–æ—Ä–æ–Ω–∞", u: "/Objects/Crown.png", t: "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ", p: 100000}
        ];
        
        // Add 100 more fake items logic for the user requirement (Procedural)
        const ADJECTIVES = ["Red","Blue","Golden","Cyber","Lost","Ancient"];
        const NOUNS = ["Key","Map","Book","Potion","Sword","Shield"];
        ADJECTIVES.forEach(adj => {
            NOUNS.forEach(noun => {
                ASSETS.push({
                    n: `${adj} ${noun}`,
                    u: "/Objects/Key.png", // Generic placeholder or randomize
                    t: "Common",
                    p: 300
                });
            });
        });

        let state = {
            nick: localStorage.getItem('ultra_nick'),
            user: null,
            inv: [],
            loaded: false,
            energyTick: 0
        };

        // --- INIT ---
        window.onload = () => {
            if(state.nick) {
                // Show loader immediately
                document.getElementById('view-auth').style.display = 'none';
                document.getElementById('view-loading').style.display = 'block';
                // Failsafe timer: if 5 seconds pass and no data -> reset
                setTimeout(() => {
                    if(!state.loaded) {
                        document.getElementById('retry-btn').style.display = 'inline-block';
                    }
                }, 5000);
                startApp();
            }
        };

        function resetApp() {
            localStorage.removeItem('ultra_nick');
            location.reload();
        }

        let isRegMode = false;
        function toggleAuth(mode) {
            isRegMode = mode;
            document.querySelectorAll('#auth-modal .tab').forEach(t=>t.classList.remove('active'));
            if(mode) document.getElementById('tab-reg').classList.add('active');
            else document.getElementById('tab-login').classList.add('active');
            document.getElementById('btn-text').innerText = mode ? "–°–û–ó–î–ê–¢–¨" : "–í–û–ô–¢–ò";
        }

        async function submitAuth() {
            const n = document.getElementById('auth-nick').value.trim();
            const p = document.getElementById('auth-pass').value.trim();
            if(n.length<3 || p.length<4) return alert("Error: Data too short");

            document.getElementById('btn-text').style.display='none';
            document.getElementById('btn-load').style.display='inline-block';
            
            const docRef = db.collection('users').doc(n);
            
            try {
                const snap = await docRef.get();
                if(isRegMode) {
                    if(snap.exists) throw "Nick taken";
                    await docRef.set({
                        pass: p, bal: 0, energy: 100,
                        inv: [], eq: [],
                        tap:1, crit:1, regen:1, lastDaily: 0,
                        createdAt: Date.now()
                    });
                } else {
                    if(!snap.exists || snap.data().pass !== p) throw "Invalid login";
                }
                
                localStorage.setItem('ultra_nick', n);
                state.nick = n;
                startApp();

            } catch(e) {
                document.getElementById('auth-error').innerText = e;
                document.getElementById('btn-text').style.display='inline';
                document.getElementById('btn-load').style.display='none';
            }
        }

        function startApp() {
            // Subscribe to user
            db.collection('users').doc(state.nick).onSnapshot(doc => {
                if(!doc.exists) { resetApp(); return; }
                state.user = doc.data();
                state.loaded = true;
                
                // Hide loader
                document.getElementById('auth-modal').style.display = 'none';
                document.getElementById('main-content').classList.add('loaded');
                
                renderUI();
                renderShop('all'); // Load initial shop
            });
            
            // Local Loops
            setInterval(energyLoop, 1000);
            checkDaily();
        }

        function renderUI() {
            const u = state.user;
            document.getElementById('my-nick').innerText = state.nick;
            document.getElementById('balance').innerText = Math.floor(u.bal).toLocaleString();
            document.getElementById('inv-count').innerText = u.inv ? u.inv.length : 0;
            
            // Equipped items visuals
            ['orb-1','orb-2'].forEach(id => document.getElementById(id).style.display='none');
            if(u.eq && u.eq[0]) {
                 document.getElementById('orb-1').src = BASE_URL + u.eq[0].u;
                 document.getElementById('orb-1').style.display='block';
            }
            if(u.eq && u.eq[1]) {
                 document.getElementById('orb-2').src = BASE_URL + u.eq[1].u;
                 document.getElementById('orb-2').style.display='block';
            }
            
            renderInv();
            updateUpgrades();
        }
        
        // --- ENERGY SYSTEM FIX ---
        function energyLoop() {
            if(!state.user || !state.loaded) return;
            // Regen logic
            if(state.user.energy < 100) {
                state.user.energy = Math.min(100, state.user.energy + (state.user.regen * 0.5));
                state.energyTick++;
                
                // Sync to DB every 5 seconds (not every second to save writes)
                if(state.energyTick >= 5) {
                    db.collection('users').doc(state.nick).update({energy: state.user.energy});
                    state.energyTick = 0;
                }
            }
            // Visual Update always
            document.getElementById('energy').innerText = Math.floor(state.user.energy);
        }

        // --- GAMEPLAY ---
        let clickCount = 0;
        document.getElementById('tap-btn').addEventListener('pointerdown', (e) => {
             if(!state.user || state.user.energy < 1) {
                 toast("‚ö° –ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏!"); return;
             }

             // Logic
             let gain = state.user.tap * (1 + (clickCount>10?0.5:0));
             let isCrit = Math.random() < (state.user.crit * 0.02);
             if(isCrit) gain *= 3;
             gain = Math.floor(gain);

             state.user.bal += gain;
             state.user.energy -= 1;
             
             // Update local visual instantly
             document.getElementById('balance').innerText = Math.floor(state.user.bal);
             document.getElementById('energy').innerText = Math.floor(state.user.energy);
             
             // Save periodically
             clickCount++;
             if(clickCount % 10 === 0) {
                 db.collection('users').doc(state.nick).update({ 
                     bal: state.user.bal, 
                     energy: state.user.energy 
                 });
             }
             
             // Visual Effects
             spawnFloatText(e.clientX, e.clientY, gain, isCrit);
        });
        
        document.getElementById('tap-btn').addEventListener('pointerup', () => {
             // Reset scale effect is handled by CSS
        });

        function spawnFloatText(x, y, amount, crit) {
             const el = document.createElement('div');
             el.className = 'floating-text';
             el.innerText = crit ? `CRIT +${amount}` : `+${amount}`;
             el.style.left = (x - 20) + 'px';
             el.style.top = (y - 50) + 'px';
             el.style.color = crit ? '#ef4444' : '#fff';
             el.style.fontSize = crit ? '24px' : '18px';
             document.body.appendChild(el);
             setTimeout(() => el.remove(), 800);
        }

        // --- SHOP & INV ---
        function renderShop(filter) {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            let shown = 0;
            ASSETS.forEach(item => {
                if(shown > 40) return; // limit render
                if(filter !== 'all' && item.t !== filter) return;
                
                const d = document.createElement('div'); d.className = 'card';
                d.innerHTML = `
                    <div class="nft-pill" style="right:5px; left:auto; background:${getPriceColor(item.p)}">${item.p}üíé</div>
                    <img src="${BASE_URL+item.u}" class="nft-img">
                    <div style="font-size:11px; font-weight:bold;">${item.n}</div>
                    <div style="font-size:9px; color:#666; margin-bottom:5px;">${item.t}</div>
                    <button class="btn-sm btn-outline" style="width:100%" onclick="buyItem('${item.n}')">–ö—É–ø–∏—Ç—å</button>
                `;
                list.appendChild(d);
                shown++;
            });
        }
        function getPriceColor(p){ return p > 5000 ? '#eab308' : (p > 1000 ? '#a855f7' : '#333'); }

        async function buyItem(name) {
            const item = ASSETS.find(x => x.n === name);
            if(state.user.bal < item.p) return toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤");
            
            // Create Instance
            const instance = {
                id: Date.now() + Math.random().toString(),
                base: item,
                u: item.u, n: item.n, p: item.p,
                bg: genGradient()
            };
            
            state.user.bal -= item.p;
            toast("–ö—É–ø–ª–µ–Ω–æ: " + item.n);
            
            await db.collection('users').doc(state.nick).update({
                bal: state.user.bal,
                inv: firebase.firestore.FieldValue.arrayUnion(instance)
            });
        }
        
        function genGradient() {
             const h = Math.floor(Math.random()*360);
             return `linear-gradient(135deg, hsl(${h}, 50%, 20%), #000)`;
        }

        let curNftIdx = -1;
        function renderInv() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = "";
            const rawList = state.user.inv || [];
            
            rawList.forEach((item, i) => {
                const el = document.createElement('div');
                el.className = 'card';
                // Find Rarity Color
                let rClass = 'r-common';
                if(item.base) {
                     if(item.base.t === '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ') rClass = 'r-leg';
                     else if(item.base.t === '–¢–µ—Ö–Ω–æ') rClass = 'r-rare';
                }
                el.classList.add(rClass);
                el.style.background = item.bg || '#18181b';
                
                el.innerHTML = `
                   <div class="nft-pill">ID:${i}</div>
                   <img src="${BASE_URL + item.u}" class="nft-img">
                   <div style="font-size:10px; font-weight:700;">${item.n}</div>
                `;
                el.onclick = () => openNft(i);
                list.appendChild(el);
            });
        }

        // --- 3D INTERACTION LOGIC ---
        let is3DActive = false;
        function openNft(idx) {
            curNftIdx = idx;
            const item = state.user.inv[idx];
            document.getElementById('modal-name').innerText = item.n;
            document.getElementById('modal-rarity').innerText = item.base ? item.base.t : 'Common';
            document.getElementById('sys-price').innerText = Math.floor(item.p * 0.5);
            
            // Setup 3D Card
            const cardImg = document.getElementById('modal-card-img');
            const cardBg = document.getElementById('modal-card-bg');
            const cardWrap = document.getElementById('card-3d-el');
            
            cardImg.src = BASE_URL + item.u;
            cardBg.style.background = item.bg || '#333';
            
            // Reset transforms
            cardWrap.style.transform = '';
            cardWrap.classList.add('auto-rotate'); // Start with auto anim
            is3DActive = false;
            document.getElementById('btn-toggle-3d').classList.remove('active');
            
            openModal('nft-modal');
        }

        function toggle3DInteraction() {
             const el = document.getElementById('card-3d-el');
             const btn = document.getElementById('btn-toggle-3d');
             const wrapper = document.getElementById('card-wrapper');
             
             is3DActive = !is3DActive;
             if(is3DActive) {
                 el.classList.remove('auto-rotate');
                 btn.classList.add('btn-primary');
                 btn.innerText = "–ê–∫—Ç–∏–≤–Ω–æ! –î–≤–∏–≥–∞–π –º—ã—à–∫–æ–π";
                 
                 // Enable Listener
                 wrapper.addEventListener('mousemove', handleTilt);
                 wrapper.addEventListener('touchmove', handleTouchTilt);
                 wrapper.addEventListener('mouseleave', resetTilt);
             } else {
                 el.classList.add('auto-rotate');
                 btn.classList.remove('btn-primary');
                 btn.innerText = "üñê –í–∫–ª—é—á–∏—Ç—å 3D –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ";
                 
                 // Remove listeners
                 wrapper.removeEventListener('mousemove', handleTilt);
                 wrapper.removeEventListener('touchmove', handleTouchTilt);
             }
        }

        function handleTilt(e) {
             const el = document.getElementById('card-3d-el');
             const box = e.currentTarget.getBoundingClientRect();
             const x = e.clientX - box.left;
             const y = e.clientY - box.top;
             
             // Calculate rotation range (-20deg to 20deg)
             const xP = (x / box.width) - 0.5;
             const yP = (y / box.height) - 0.5;
             
             el.style.transform = `rotateY(${xP * 40}deg) rotateX(${yP * -40}deg)`;
        }
        function handleTouchTilt(e) {
             // simplified touch support
             handleTilt(e.touches[0]);
             e.preventDefault(); 
        }
        function resetTilt() {
             document.getElementById('card-3d-el').style.transform = 'rotateY(0deg) rotateX(0deg)';
        }

        async function sellSystem() {
            if(curNftIdx===-1) return;
            const item = state.user.inv[curNftIdx];
            const price = Math.floor(item.p * 0.5);
            
            state.user.inv.splice(curNftIdx, 1);
            // Unequip if needed
            state.user.eq = state.user.eq.filter(x => x.id !== item.id);
            state.user.bal += price;
            
            closeModal('nft-modal');
            toast(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${price}üíé`);
            
            await db.collection('users').doc(state.nick).update({
                 bal: state.user.bal,
                 inv: state.user.inv,
                 eq: state.user.eq
            });
        }
        
        async function equipNft() {
             const item = state.user.inv[curNftIdx];
             if(state.user.eq.length >= 2) return toast("–ú–∞–∫—Å–∏–º—É–º 2 —Å—Ñ–µ—Ä—ã");
             state.user.eq.push(item);
             toast("–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ");
             closeModal('nft-modal');
             await db.collection('users').doc(state.nick).update({eq:state.user.eq});
        }

        // --- UPGRADES ---
        function updateUpgrades() {
            const u = state.user;
            document.getElementById('lvl-tap').innerText = u.tap;
            document.getElementById('cost-tap').innerText = 100 * u.tap;
            document.getElementById('lvl-crit').innerText = u.crit;
            document.getElementById('cost-crit').innerText = 500 * u.crit;
            document.getElementById('lvl-regen').innerText = u.regen;
            document.getElementById('cost-regen').innerText = 300 * u.regen;
        }

        async function buyUpgrade(type) {
             const u = state.user;
             let cost = 0;
             if(type==='tap') cost = 100 * u.tap;
             if(type==='crit') cost = 500 * u.crit;
             if(type==='regen') cost = 300 * u.regen;
             
             if(u.bal < cost) return toast("–ù—É–∂–Ω–æ –±–æ–ª—å—à–µ üíé");
             u.bal -= cost;
             u[type]++;
             updateUpgrades();
             
             await db.collection('users').doc(state.nick).update({
                 [type]: u[type],
                 bal: u.bal
             });
        }

        // --- NEW: CRAFT SYSTEM ---
        let selectedForCraft = [];
        
        function nav(s, el) {
            document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
            document.getElementById('screen-'+s).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if(s==='craft') loadCraftUI();
        }
        
        function loadCraftUI() {
            selectedForCraft = [];
            updateCraftZone();
            const list = document.getElementById('craft-inv-list');
            list.innerHTML = "";
            state.user.inv.forEach((item, i) => {
                const el = document.createElement('div');
                el.className = 'card';
                el.style.background = '#222';
                el.innerHTML = `<img src="${BASE_URL+item.u}" width="50">`;
                el.onclick = () => addToCraft(i);
                list.appendChild(el);
            });
        }
        
        function addToCraft(invIndex) {
            if(selectedForCraft.length >= 3) return toast("–ú–∞–∫—Å–∏–º—É–º 3 –ø—Ä–µ–¥–º–µ—Ç–∞");
            if(selectedForCraft.includes(invIndex)) return toast("–£–∂–µ –≤—ã–±—Ä–∞–Ω");
            selectedForCraft.push(invIndex);
            updateCraftZone();
        }
        
        function updateCraftZone() {
            const zone = document.getElementById('craft-slots');
            const btn = document.getElementById('craft-btn');
            
            zone.innerHTML = "";
            selectedForCraft.forEach(idx => {
                const item = state.user.inv[idx];
                const img = document.createElement('img');
                img.src = BASE_URL + item.u;
                img.style.width = '60px';
                zone.appendChild(img);
            });
            
            if(selectedForCraft.length === 3) {
                 zone.classList.add('valid');
                 btn.disabled = false;
                 btn.innerText = "–°–ò–ù–¢–ï–ó–ò–†–û–í–ê–¢–¨";
            } else {
                 zone.classList.remove('valid');
                 btn.disabled = true;
                 btn.innerText = `–°–ò–ù–¢–ï–ó (${selectedForCraft.length}/3)`;
                 if(selectedForCraft.length===0) zone.innerText = "–í—ã–±–µ—Ä–∏ 3 –ø—Ä–µ–¥–º–µ—Ç–∞ —Å–Ω–∏–∑—É";
            }
        }
        
        async function doCraft() {
            // Remove 3 old items
            // Add 1 new rare item
            const oldItems = selectedForCraft.map(i => state.user.inv[i]);
            
            // Verify types (Simpler version: Just combines any)
            
            // Create Reward
            const rewardBase = ASSETS.find(a => a.t === '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ') || ASSETS[0];
            const reward = {
                id: Date.now().toString(),
                base: rewardBase,
                n: rewardBase.n + " (Crafted)",
                u: rewardBase.u,
                p: rewardBase.p * 1.5,
                bg: "linear-gradient(45deg, gold, purple)"
            };
            
            // Logic to remove indices: Sort desc to delete without shifting errors
            selectedForCraft.sort((a,b)=>b-a).forEach(idx => {
                state.user.inv.splice(idx, 1);
            });
            state.user.inv.push(reward);
            
            // Reset
            toast("–ö–†–ê–§–¢ –£–°–ü–ï–®–ï–ù!");
            nav('home');
            
            await db.collection('users').doc(state.nick).update({inv: state.user.inv});
        }

        // --- CASINO LOGIC (SPIN) ---
        function spinSlots() {
            const bet = parseInt(document.getElementById('bet-input').value);
            if(bet > state.user.bal || bet <= 0) return toast("–û—à–∏–±–∫–∞ —Å—Ç–∞–≤–∫–∏");
            
            state.user.bal -= bet;
            document.getElementById('spin-btn').disabled = true;
            
            const reels = [document.getElementById('reel-1'), document.getElementById('reel-2'), document.getElementById('reel-3')];
            const icons = ['üçí','üçá','üçã','7Ô∏è‚É£','üí©'];
            
            // Animate
            let result = [];
            reels.forEach((r, i) => {
                 let count = 0;
                 let strip = r.querySelector('.strip');
                 let timer = setInterval(() => {
                      strip.style.top = (count%2==0 ? '5px' : '-5px'); // Shake
                      strip.innerText = icons[Math.floor(Math.random()*icons.length)];
                      count++;
                      if(count > 10 + (i*5)) {
                          clearInterval(timer);
                          strip.style.top = '0';
                          // Bias logic (slight lose bias)
                          let outcome = Math.random() < 0.6 ? 'üí©' : icons[Math.floor(Math.random()*icons.length)];
                          strip.innerText = outcome;
                          result.push(outcome);
                          
                          if(result.length === 3) checkWin(result, bet);
                      }
                 }, 80);
            });
        }
        
        function checkWin(res, bet) {
            document.getElementById('spin-btn').disabled = false;
            if(res[0] === res[1] && res[1] === res[2]) {
                if(res[0] === '7Ô∏è‚É£') { 
                    toast("JACKPOT! x50"); state.user.bal += bet*50;
                } else if(res[0] !== 'üí©') {
                    toast("WIN! x10"); state.user.bal += bet*10;
                } else {
                    toast("Looose");
                }
            } else {
                toast("Try again");
            }
            db.collection('users').doc(state.nick).update({bal:state.user.bal});
        }
        
        // --- DAILY REWARD ---
        function checkDaily() {
            const now = Date.now();
            const last = state.user.lastDaily || 0;
            const diff = now - last;
            if(diff > 86400000) { // 24 hours
                document.getElementById('daily-timer').innerText = "–ì–æ—Ç–æ–≤–æ!";
                document.getElementById('daily-btn').disabled = false;
            } else {
                const left = 86400000 - diff;
                document.getElementById('daily-timer').innerText = `–ñ–¥–∏ ${Math.floor(left/3600000)}—á`;
                document.getElementById('daily-btn').disabled = true;
            }
        }
        
        async function claimDaily() {
             state.user.bal += 500;
             state.user.lastDaily = Date.now();
             toast("–ü–æ–ª—É—á–µ–Ω–æ +500üíé");
             checkDaily();
             await db.collection('users').doc(state.nick).update({
                 bal:state.user.bal,
                 lastDaily:state.user.lastDaily
             });
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function toast(m) { 
            const t = document.getElementById('toast');
            t.innerText = m;
            t.style.display = 'flex';
            setTimeout(()=>t.style.display='none', 2000);
        }
        function switchMarket(type, el) {
             document.querySelectorAll('#screen-market .tab').forEach(t=>t.classList.remove('active'));
             el.classList.add('active');
             document.getElementById('view-shop').style.display = type==='shop'?'block':'none';
             document.getElementById('view-p2p').style.display = type==='p2p'?'block':'none';
        }
        
    </script>
</body>
</html>
