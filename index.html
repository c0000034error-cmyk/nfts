<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crypto NFT Robots</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --primary: #8b5cf6; /* Violet like TON */
            --accent: #06b6d4;
            --danger: #f43f5e;
            --success: #10b981;
            --text: #f8fafc;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* –ó–ê–ì–†–£–ó–ö–ê */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 5000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .loader {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HEADER */
        .header {
            padding: 15px; padding-top: max(15px, env(safe-area-inset-top));
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 50;
            backdrop-filter: blur(10px);
        }
        .user-block { display: flex; flex-direction: column; }
        .nickname { font-weight: bold; font-size: 14px; color: var(--text); }
        .balance { font-size: 18px; color: var(--success); font-weight: 800; }

        .btn-logout {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #ccc; padding: 6px 12px; border-radius: 8px; font-size: 12px; margin-left: 10px;
        }
        .btn-admin {
            background: #f43f5e; color: white; border: none; padding: 4px 8px; 
            border-radius: 6px; font-size: 10px; font-weight: bold; display: none; margin-bottom: 2px;
        }

        /* CONTENT */
        .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 100px; }
        .screen { display: none; animation: fadeIn 0.3s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* NFT CARDS */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card {
            background: var(--panel); border-radius: var(--radius); padding: 8px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.05); position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .nft-img {
            width: 100%; aspect-ratio: 1; border-radius: 12px; margin-bottom: 8px;
            background: #0f172a; object-fit: contain; /* –ß—Ç–æ–±—ã —Ä–æ–±–æ—Ç –≤–ª–µ–∑–∞–ª —Ü–µ–ª–∏–∫–æ–º */
        }
        .rarity-badge {
            position: absolute; top: 12px; right: 12px; font-size: 10px;
            padding: 3px 6px; border-radius: 6px; background: rgba(0,0,0,0.8);
            color: white; font-weight: bold; border: 1px solid rgba(255,255,255,0.2);
        }

        /* BUTTONS */
        .btn { background: var(--primary); color: white; padding: 12px; border-radius: 12px; width: 100%; font-size: 14px; font-weight: 600; border: none; cursor: pointer; }
        .btn:active { transform: scale(0.97); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: var(--danger); }
        
        /* AUTH MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; padding: 20px;
        }
        .modal-box {
            width: 100%; max-width: 360px; background: var(--panel);
            padding: 24px; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1);
            text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        input {
            background: #0f172a; border: 1px solid #334155; padding: 14px;
            border-radius: 12px; color: white; width: 100%; margin-bottom: 12px;
            font-size: 16px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }

        /* TAP */
        .tap-area { display: flex; justify-content: center; margin: 30px 0; }
        .tap-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #3b82f6);
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.4);
            display: flex; justify-content: center; align-items: center;
            font-size: 80px; cursor: pointer; border: 6px solid rgba(255,255,255,0.2);
            user-select: none;
        }
        .tap-btn:active { transform: scale(0.95); }

        /* NAVBAR */
        .navbar {
            position: fixed; bottom: 0; width: 100%; background: var(--panel);
            display: flex; border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: env(safe-area-inset-bottom); z-index: 100;
        }
        .nav-item { flex: 1; padding: 14px 0; text-align: center; font-size: 10px; color: #64748b; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        .toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 10px 20px; border-radius: 50px; z-index: 3000;
            display: none; border: 1px solid #555; font-size: 14px;
        }
        
        /* Game Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; }
        .tab { padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 20px; font-size: 12px; white-space: nowrap; }
        .tab.active { background: var(--primary); color: white; }

    </style>
</head>
<body>

    <!-- –ó–ê–ì–†–£–ó–ö–ê -->
    <div id="loading-screen">
        <div class="loader"></div>
        <div>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º...</div>
    </div>

    <!-- AUTH MODAL (–°–î–ï–õ–ê–ù –¢–ê–ö –ß–¢–û–ë–´ –ù–ï–õ–¨–ó–Ø –ë–´–õ–û –ó–ê–ö–†–´–¢–¨) -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="auth-title" style="margin-bottom: 5px;">–í—Ö–æ–¥</h2>
            <p style="color:#94a3b8; font-size: 13px; margin-bottom: 20px;">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
            
            <input type="text" id="auth-nick" placeholder="–ù–∏–∫–Ω–µ–π–º">
            <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            
            <button class="btn" onclick="submitAuth()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            
            <p onclick="toggleAuth()" style="margin-top: 15px; font-size: 12px; color: var(--primary); cursor: pointer;">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <span style="text-decoration: underline;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
            </p>
            <p id="auth-error" style="color:var(--danger); font-size:12px; min-height:16px; margin-top:5px;"></p>
        </div>
    </div>

    <!-- –ü–†–û–î–ê–ñ–ê -->
    <div id="sell-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">NFT Item</h3>
            <img src="" id="sell-img" class="nft-img" style="background:black;">
            <p id="sell-info" style="color:#ccc; margin-bottom:15px;"></p>
            
            <button class="btn btn-outline" onclick="sellSystem()">‚ôªÔ∏è –°–∂–µ—á—å (+<span id="sys-price">0</span> üí∞)</button>
            <div style="margin: 10px 0; font-size: 12px; color: #666;">--- –ò–õ–ò ---</div>
            <input type="number" id="p2p-price" placeholder="–¶–µ–Ω–∞ –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤">
            <button class="btn" onclick="sellP2P()">üì¢ –í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ —Ä—ã–Ω–æ–∫</button>
            <button class="btn btn-danger" onclick="closeModal('sell-modal')" style="margin-top:10px; padding: 8px;">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ê–î–ú–ò–ù–ö–ê -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-box" style="border-color: #f43f5e;">
            <h2 style="color:#f43f5e">ADMIN MENU</h2>
            <button class="btn" onclick="admMoney()">+5000 Money</button>
            <br><br>
            <button class="btn" onclick="admEnergy()">Full Energy</button>
            <br><br>
            <button class="btn btn-outline" onclick="closeModal('admin-modal')">Close</button>
        </div>
    </div>

    <div id="toast" class="toast">Msg</div>

    <!-- UI -->
    <div class="header">
        <div class="user-block">
            <button id="admin-btn" class="btn-admin" onclick="openModal('admin-modal')">ADMIN</button>
            <div class="nickname" id="my-nick">...</div>
            <div class="balance"><span id="balance">0</span> üí∞</div>
        </div>
        <div>
            <span style="font-size:12px; color:#aaa; margin-right:5px;">‚ö° <span id="energy">0</span></span>
            <button class="btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <!-- CONTENT -->
    <div class="content">
        
        <!-- HOME -->
        <div id="tab-home" class="screen active">
            <div class="tap-area">
                <div class="tap-btn" id="tap-btn">ü§ñ</div>
            </div>
            
            <h3 style="border-bottom: 1px solid #333; padding-bottom: 5px;">–ú–æ–∏ NFT</h3>
            <div class="grid" id="inventory-list"></div>
        </div>

        <!-- MARKET -->
        <div id="tab-market" class="screen">
            <div class="tabs">
                <div class="tab active" onclick="switchShop('sys')" id="t-sys">–ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="tab" onclick="switchShop('p2p')" id="t-p2p">–ë–∏—Ä–∂–∞</div>
            </div>

            <div id="view-sys">
                <div class="grid" id="sys-list"></div>
            </div>
            <div id="view-p2p" style="display:none;">
                <button class="btn btn-outline" onclick="loadP2P()" style="margin-bottom:10px; padding:8px;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                <div class="grid" id="p2p-list"></div>
            </div>
        </div>

        <!-- CASINO -->
        <div id="tab-casino" class="screen">
            <div class="tabs">
                <div class="tab active" onclick="switchGame('slots')">Slots</div>
                <div class="tab" onclick="switchGame('dice')">Dice</div>
                <div class="tab" onclick="switchGame('coin')">Coin</div>
            </div>

            <!-- SLOTS -->
            <div id="game-slots" class="card" style="padding: 20px; text-align: center;">
                <h2>üé∞ 777</h2>
                <div style="font-size:40px; margin: 15px 0;" id="slots-view">üçí üçí üçí</div>
                <input type="number" id="slots-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <button class="btn" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å (x5)</button>
            </div>
            
            <!-- DICE -->
            <div id="game-dice" class="card" style="padding: 20px; text-align: center; display:none;">
                <h2>üé≤ –ö–æ—Å—Ç–∏</h2>
                <div style="font-size:50px; margin: 15px 0; color:var(--accent);" id="dice-view">50</div>
                <p>–ë–æ–ª—å—à–µ –∏–ª–∏ –º–µ–Ω—å—à–µ 50?</p>
                <input type="number" id="dice-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <div class="grid">
                    <button class="btn btn-danger" onclick="playDice('under')">&lt; 50</button>
                    <button class="btn btn-success" onclick="playDice('over')">&gt; 50</button>
                </div>
            </div>

            <!-- COIN -->
            <div id="game-coin" class="card" style="padding: 20px; text-align: center; display:none;">
                <h2>ü™ô –ú–æ–Ω–µ—Ç–∫–∞</h2>
                <div style="font-size:60px; margin: 15px 0;" id="coin-view">‚ùì</div>
                <input type="number" id="coin-bet" placeholder="–°—Ç–∞–≤–∫–∞">
                <div class="grid">
                    <button class="btn" style="background:#fbbf24; color:black" onclick="playCoin('heads')">–û—Ä—ë–ª</button>
                    <button class="btn" style="background:#94a3b8; color:white" onclick="playCoin('tails')">–†–µ—à–∫–∞</button>
                </div>
            </div>
        </div>

    </div>

    <!-- NAVBAR -->
    <div class="navbar">
        <div class="nav-item active" onclick="nav('home')"><span class="nav-icon">üè†</span></div>
        <div class="nav-item" onclick="nav('market')"><span class="nav-icon">üõí</span></div>
        <div class="nav-item" onclick="nav('casino')"><span class="nav-icon">üé≤</span></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg",
            authDomain: "nfts-dc174.firebaseapp.com",
            projectId: "nfts-dc174",
            storageBucket: "nfts-dc174.firebasestorage.app",
            messagingSenderId: "327365720624",
            appId: "1:327365720624:web:eb42c9d671566b5d118bf5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let uid, data, isReg=false, selIdx=null, shop=[];

        // === AUTH LOGIC FIX ===
        auth.onAuthStateChanged(async (user) => {
            document.getElementById('loading-screen').style.display = 'none';
            if (user) {
                uid = user.uid;
                // –ü–†–û–í–ï–†–Ø–ï–ú –°–£–©–ï–°–¢–í–£–ï–¢ –õ–ò –ê–ö–ö–ê–£–ù–¢
                const doc = await db.collection('users').doc(uid).get();
                if (doc.exists) {
                    closeModal('auth-modal');
                    initGame();
                } else {
                    // –ï—Å–ª–∏ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω, –Ω–æ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –≤—ã—Ö–æ–¥–∏–º
                    auth.signOut();
                    openModal('auth-modal');
                }
            } else {
                openModal('auth-modal');
            }
        });

        function logout() {
            auth.signOut().then(() => location.reload());
        }

        function toggleAuth() {
            isReg = !isReg;
            document.getElementById('auth-title').innerText = isReg ? "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è" : "–í—Ö–æ–¥";
            document.getElementById('auth-error').innerText = "";
        }

        async function submitAuth() {
            const nick = document.getElementById('auth-nick').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            const email = `${nick.replace(/[^a-z0-9]/gi,'')}@nfts.game`.toLowerCase();
            const err = document.getElementById('auth-error');

            if(nick.length < 3) return err.innerText = "–ù–∏–∫ –∫–æ—Ä–æ—Ç–∫–∏–π";
            if(pass.length < 6) return err.innerText = "–ü–∞—Ä–æ–ª—å –º–∏–Ω 6 —Å–∏–º–≤–æ–ª–æ–≤";
            
            err.innerText = "–ü–æ–¥–æ–∂–¥–∏—Ç–µ...";

            try {
                if(isReg) {
                    const check = await db.collection('users').where('nickname', '==', nick).get();
                    if(!check.empty) throw "–ù–∏–∫ –∑–∞–Ω—è—Ç!";
                    const cred = await auth.createUserWithEmailAndPassword(email, pass);
                    await db.collection('users').doc(cred.user.uid).set({
                        nickname: nick, balance: 500, energy: 1000, inventory: [], createdAt: Date.now()
                    });
                } else {
                    await auth.signInWithEmailAndPassword(email, pass);
                }
            } catch(e) {
                console.log(e);
                err.innerText = "–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –∏–ª–∏ –Ω–∏–∫ –∑–∞–Ω—è—Ç";
            }
        }

        // === GAME ===
        function initGame() {
            db.collection('users').doc(uid).onSnapshot(doc => {
                if(doc.exists) {
                    data = doc.data();
                    updateUI();
                    renderInv();
                    if(data.nickname === 'kayivi') document.getElementById('admin-btn').style.display = 'block';
                }
            });
            genShop();
            loadP2P();
        }

        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(data.balance);
            document.getElementById('energy').innerText = Math.floor(data.energy);
            document.getElementById('my-nick').innerText = data.nickname;
        }

        // === GENERATOR (ROBOHASH) ===
        function genNFT(forced) {
            const r = Math.random();
            let rarity = forced || (r>0.98?"Legendary":r>0.8?"Rare":"Common");
            const seed = Math.floor(Math.random()*999999);
            // set1 = robots, set2 = monsters, set3 = cyborg heads
            let set = 'set1';
            if(rarity === 'Rare') set = 'set2';
            if(rarity === 'Legendary') set = 'set3';

            return {
                id: Date.now() + "_" + Math.floor(Math.random()*100),
                seed: seed,
                rarity: rarity,
                img: `https://robohash.org/${seed}?set=${set}&bgset=bg1`,
                price: rarity==='Legendary'?2000:(rarity==='Rare'?500:50)
            };
        }

        function getCol(r) { return r==='Legendary'?'#fbbf24':r==='Rare'?'#8b5cf6':'#94a3b8'; }

        // === CLICKER ===
        document.getElementById('tap-btn').addEventListener('click', (e) => {
            if(data.energy < 1) return toast("–ú–∞–ª–æ —ç–Ω–µ—Ä–≥–∏–∏");
            data.balance++; data.energy--;
            
            if(Math.random()<0.01) {
                const n = genNFT(); data.inventory.push(n); toast(`üéÅ ${n.rarity}!`);
            }
            if(data.balance%20===0) save();
            updateUI();
            
            const f = document.createElement('div'); f.innerText='+1'; 
            f.style.position='absolute'; f.style.left=e.clientX+'px'; f.style.top=e.clientY+'px';
            f.style.color='white'; f.style.pointerEvents='none';
            document.body.appendChild(f); setTimeout(()=>f.remove(), 500);
        });
        setInterval(() => { if(data && data.energy < 1000) { data.energy += 5; updateUI(); } }, 1000);
        function save() { db.collection('users').doc(uid).update({ balance: data.balance, energy: data.energy, inventory: data.inventory }); }

        // === INVENTORY ===
        function renderInv() {
            const l = document.getElementById('inventory-list'); l.innerHTML='';
            data.inventory.forEach((n, i) => {
                const d = document.createElement('div'); d.className='card';
                d.innerHTML = `
                    <span class="rarity-badge" style="background:${getCol(n.rarity)}">${n.rarity}</span>
                    <img src="${n.img}" class="nft-img">
                    <button class="btn btn-outline" style="font-size:10px; padding:6px;" onclick="openSell(${i})">–ú–µ–Ω—é</button>
                `;
                l.appendChild(d);
            });
        }
        function openSell(i) {
            selIdx=i; const n=data.inventory[i];
            document.getElementById('sell-img').src = n.img;
            document.getElementById('sell-info').innerText = `${n.rarity} | –¶–µ–Ω–∞: ${n.price}`;
            document.getElementById('sys-price').innerText = Math.floor(n.price*0.5);
            openModal('sell-modal');
        }
        function sellSystem() {
            const p = Math.floor(data.inventory[selIdx].price*0.5);
            data.balance+=p; data.inventory.splice(selIdx,1); save(); closeModal('sell-modal'); toast(`–ü—Ä–æ–¥–∞–Ω–æ +${p}`);
        }
        function sellP2P() {
            const p = parseInt(document.getElementById('p2p-price').value);
            if(!p || p<1) return toast("–¶–µ–Ω–∞?");
            const n = data.inventory[selIdx];
            db.runTransaction(async t => {
                const doc = await t.get(db.collection('users').doc(uid));
                const inv = doc.data().inventory; inv.splice(selIdx,1);
                t.update(db.collection('users').doc(uid), {inventory: inv});
                t.set(db.collection('market').doc(), { seller: uid, sellerName: data.nickname, price: p, nft: n, createdAt: Date.now() });
            }).then(() => { closeModal('sell-modal'); toast("–ù–∞ —Ä—ã–Ω–∫–µ!"); loadP2P(); });
        }

        // === SHOP ===
        function genShop() {
            shop=[]; for(let i=0; i<4; i++) shop.push(genNFT());
            renderShop();
        }
        function renderShop() {
            const l = document.getElementById('sys-list'); l.innerHTML='';
            shop.forEach((n, i) => {
                const p = Math.floor(n.price*1.5);
                const d = document.createElement('div'); d.className='card';
                d.innerHTML = `
                    <span class="rarity-badge" style="background:${getCol(n.rarity)}">${n.rarity}</span>
                    <img src="${n.img}" class="nft-img">
                    <button class="btn" onclick="buySys(${i}, ${p})">${p} üí∞</button>
                `;
                l.appendChild(d);
            });
        }
        function buySys(i, p) {
            if(data.balance < p) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");
            data.balance-=p; data.inventory.push(shop[i]);
            shop[i] = genNFT(); save(); renderShop(); toast("–ö—É–ø–ª–µ–Ω–æ!");
        }
        function switchShop(t) {
            document.getElementById('view-sys').style.display = t==='sys'?'block':'none';
            document.getElementById('view-p2p').style.display = t==='p2p'?'block':'none';
            document.getElementById('t-sys').classList.toggle('active', t==='sys');
            document.getElementById('t-p2p').classList.toggle('active', t==='p2p');
            if(t==='p2p') loadP2P();
        }
        function loadP2P() {
            const l = document.getElementById('p2p-list');
            db.collection('market').orderBy('createdAt', 'desc').limit(20).get().then(s => {
                l.innerHTML = '';
                if(s.empty) return l.innerHTML='<p style="width:200%; text-align:center;">–ü—É—Å—Ç–æ</p>';
                s.forEach(d => {
                    const dt = d.data(); const mine = dt.seller===uid;
                    const el = document.createElement('div'); el.className='card';
                    el.innerHTML = `
                        <span class="rarity-badge" style="background:${getCol(dt.nft.rarity)}">${dt.nft.rarity}</span>
                        <img src="${dt.nft.img}" class="nft-img">
                        <div style="font-size:10px;">@${dt.sellerName}</div>
                        <button class="btn ${mine?'btn-danger':''}" onclick="${mine?`cancel('${d.id}')`:`buy('${d.id}',${dt.price})`}">
                            ${mine ? '–û—Ç–º–µ–Ω–∞' : `–ö—É–ø–∏—Ç—å ${dt.price}`}
                        </button>
                    `;
                    l.appendChild(el);
                });
            });
        }
        function buy(id, p) {
            if(data.balance<p) return toast("–ù–µ—Ç –¥–µ–Ω–µ–≥");
            db.runTransaction(async t => {
                const mDoc = await t.get(db.collection('market').doc(id));
                if(!mDoc.exists) throw "–ö—É–ø–∏–ª–∏ —É–∂–µ";
                const lot = mDoc.data();
                t.update(db.collection('users').doc(lot.seller), {balance: firebase.firestore.FieldValue.increment(p)});
                t.update(db.collection('users').doc(uid), {balance: firebase.firestore.FieldValue.increment(-p), inventory: firebase.firestore.FieldValue.arrayUnion(lot.nft)});
                t.delete(mDoc.ref);
            }).then(() => { toast("–ö—É–ø–ª–µ–Ω–æ!"); loadP2P(); }).catch(e=>toast("–û—à–∏–±–∫–∞"));
        }
        function cancel(id) {
            db.collection('market').doc(id).get().then(d => {
                db.collection('users').doc(uid).update({inventory: firebase.firestore.FieldValue.arrayUnion(d.data().nft)});
                d.ref.delete(); loadP2P();
            });
        }

        // === CASINO ===
        function switchGame(g) {
            ['slots','dice','coin'].forEach(x=>document.getElementById('game-'+x).style.display='none');
            document.getElementById('game-'+g).style.display='block';
        }
        function playSlots() {
            const b = parseInt(document.getElementById('slots-bet').value);
            if(!b || b>data.balance) return toast("–°—Ç–∞–≤–∫–∞?");
            data.balance-=b; updateUI();
            const em=['üçí','üçã','üçá','7Ô∏è‚É£'], r=[0,0,0].map(()=>em[Math.floor(Math.random()*4)]);
            document.getElementById('slots-view').innerText = r.join(' ');
            if(r[0]===r[1]&&r[1]===r[2]) { data.balance+=b*5; toast("JACKPOT x5"); }
            else if(r[0]===r[1]||r[1]===r[2]||r[0]===r[2]) { data.balance+=Math.floor(b*1.5); toast("Win x1.5"); }
            save();
        }
        function playDice(pick) {
            const b = parseInt(document.getElementById('dice-bet').value);
            if(!b || b>data.balance) return toast("–°—Ç–∞–≤–∫–∞?");
            data.balance-=b;
            const res = Math.floor(Math.random()*100)+1;
            document.getElementById('dice-view').innerText=res;
            if((pick==='over'&&res>50)||(pick==='under'&&res<50)) { data.balance+=Math.floor(b*1.9); toast("Win!"); }
            updateUI(); save();
        }
        function playCoin(pick) {
            const b = parseInt(document.getElementById('coin-bet').value);
            if(!b || b>data.balance) return toast("–°—Ç–∞–≤–∫–∞?");
            data.balance-=b;
            const res = Math.random()<0.5?'heads':'tails';
            document.getElementById('coin-view').innerText=res==='heads'?'ü¶Ö':'ü™ô';
            if(pick===res) { data.balance+=Math.floor(b*1.9); toast("Win!"); }
            updateUI(); save();
        }

        // === ADMIN ===
        function admMoney() { data.balance+=5000; save(); updateUI(); toast("Rich!"); }
        function admEnergy() { data.energy=1000; save(); updateUI(); toast("Energy!"); }

        // === UTIL ===
        function nav(t) {
            document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
            const m={'home':0,'market':1,'casino':2};
            document.querySelectorAll('.nav-item')[m[t]].classList.add('active');
        }
        function openModal(id) { document.getElementById(id).style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }

    </script>
</body>
</html>
