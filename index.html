<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NFT Universe ‚Äî FULL RESTORE</title>

<!-- Firebase (compat for simplicity) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- icons -->
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

<style>
:root{
  --bg:#050505; --card:#151517; --muted:#9a9aa0; --primary:#6366f1; --accent:#d946ef;
  --gold:#fbbf24; --danger:#ef4444; --success:#10b981; --glass: rgba(255,255,255,0.03);
  --radius:14px; --text:#eaeaea;
}
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial;background:var(--bg);color:var(--text)}
a{color:inherit}
.header{position:sticky;top:0;z-index:80;background:linear-gradient(180deg,rgba(0,0,0,0.6),rgba(0,0,0,0.2));border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:space-between;padding:12px 18px}
.left{display:flex;gap:12px;align-items:center}
.avatar{width:52px;height:52px;border-radius:50%;background:#0e0e10;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;border:2px solid transparent}
.user-info{display:flex;flex-direction:column}
.nick{font-weight:900}
.balance{font-size:12px;color:var(--gold);font-weight:700;margin-top:4px}
.controls{display:flex;gap:8px;align-items:center}

/* buttons */
.btn{background:linear-gradient(135deg,var(--primary),var(--accent));border:none;color:#fff;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;box-shadow:0 12px 30px rgba(99,102,241,0.08)}
.btn-sm{padding:6px 10px;font-size:13px;border-radius:8px}
.btn-outline{background:transparent;border:1px solid rgba(255,255,255,0.06); color:#fff}
.btn-danger{background:var(--danger); color:#fff}
.btn-gold{background:var(--gold); color:#000; font-weight:900}

/* layout */
.content{padding:18px 18px 120px;min-height:calc(100vh - 120px)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:10px;background:#0f0f10;color:var(--muted);cursor:pointer}
.tab.active{background:#222;color:#fff}

.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));align-items:start}
.card{background:var(--card);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;align-items:center;position:relative;transition:transform .18s}
.card:hover{transform:translateY(-6px);box-shadow:0 20px 50px rgba(0,0,0,0.6)}
.plate{width:92px;height:92px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;justify-content:center;overflow:hidden}
.plate img{width:78px;height:78px;object-fit:contain;transition:transform .35s}
.plate:hover img{transform:rotateX(8deg) rotateY(10deg) scale(1.05)}
.name{font-weight:800;margin-top:8px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
.type{font-size:11px;color:#cfcfcf;background:rgba(0,0,0,0.35);padding:4px 8px;border-radius:8px;margin-top:6px}
.price{font-weight:900;padding:6px 8px;border-radius:8px;margin-top:8px;background:linear-gradient(180deg,#6b5df2,#b76cd7)}
.supply{position:absolute;top:8px;left:8px;background:rgba(0,0,0,0.45);padding:4px 6px;border-radius:8px;font-size:11px}
.equipped{position:absolute;top:8px;right:8px;width:12px;height:12px;border-radius:50%;background:var(--success);box-shadow:0 0 8px var(--success)}

.navbar{position:fixed;left:0;right:0;bottom:0;background:linear-gradient(180deg,rgba(0,0,0,0.92),rgba(0,0,0,0.96));display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid rgba(255,255,255,0.03);z-index:90}
.nav-item{color:var(--muted);font-size:12px;text-align:center;cursor:pointer}
.nav-item.active{color:var(--primary)}

.screen{display:none}
.screen.active{display:block}

/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:999;padding:12px}
.modal .box{width:100%;max-width:520px;background:#0f0f11;border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.03)}

/* cosmetics */
.style-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}

/* small helpers */
.kv{font-size:12px;color:var(--muted)}
.mon{font-family:monospace;font-weight:800;font-size:12px;color:#ddd;background:rgba(0,0,0,0.25);padding:4px 6px;border-radius:6px}

/* tiny animations */
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.avatar{animation:floaty 3.5s ease-in-out infinite}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#0b0b0c;padding:10px 14px;border-radius:16px;border:1px solid rgba(255,255,255,0.03);z-index:1200"></div>

<!-- HEADER -->
<div class="header">
  <div class="left">
    <div id="avatar" class="avatar">K</div>
    <div class="user-info">
      <div id="nick" class="nick">User</div>
      <div class="balance"><span id="balance">0</span> üíé ‚Ä¢ <span id="energy">0</span> ‚ö°</div>
    </div>
  </div>
  <div class="controls">
    <button id="adminBtn" class="btn-gold btn-sm" style="display:none">ADM</button>
    <button class="btn btn-sm btn-outline" onclick="openModal('boost')">‚ö° Boost</button>
  </div>
</div>

<!-- CONTENT -->
<div class="content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <div class="tabs">
      <div class="tab active" onclick="show('home', this)">–î–æ–º</div>
      <div class="tab" onclick="show('shop', this)">–®–æ–ø</div>
      <div class="tab" onclick="show('casino', this)">–ò–≥—Ä—ã</div>
      <div class="tab" onclick="show('profile', this)">–ü—Ä–æ—Ñ–∏–ª—å</div>
    </div>
    <div class="kv">ID: <span id="userId" class="mon">-</span></div>
  </div>

  <!-- HOME -->
  <div id="home" class="screen active">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:900">–¢–≤–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è (<span id="invCount">0</span>)</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-outline" onclick="renderInventory()">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
    <div id="inventory" class="grid"></div>
  </div>

  <!-- SHOP -->
  <div id="shop" class="screen" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="kv">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –º–∏–Ω–∏–º—É–º 100 000; –∫–∞–∂–¥–∞—è –ø—Ä–æ–¥–∞–∂–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ü–µ–Ω—É +1%</div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm btn-outline" onclick="renderShop()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-sm" onclick="document.getElementById('adminBtn').click()">ADM</button>
      </div>
    </div>
    <div id="shopGrid" class="grid"></div>
  </div>

  <!-- CASINO -->
  <div id="casino" class="screen" style="display:none">
    <div style="display:flex;gap:12px">
      <div style="flex:1;background:#0e0e10;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–°–ª–æ—Ç—ã</h3>
        <div style="font-size:44px;display:flex;gap:18px;justify-content:center;align-items:center;height:84px">
          <div id="slot1">üçí</div>
          <div id="slot2">üçí</div>
          <div id="slot3">üçí</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="slotBet" placeholder="–°—Ç–∞–≤–∫–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn" onclick="playSlots()">–ö—Ä—É—Ç–∏—Ç—å</button>
        </div>
        <div id="slotInfo" style="margin-top:8px;color:var(--muted)">–®–∞–Ω—Å –¥–∂–µ–∫–ø–æ—Ç–∞: 0.5%</div>
      </div>
      <div style="width:320px;background:#0e0e10;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ú–∏–Ω—ã</h3>
        <div id="minesField" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px"></div>
        <div style="display:flex;gap:8px">
          <input id="minesBet" placeholder="–°—Ç–∞–≤–∫–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn" onclick="startMines()">–ò–≥—Ä–∞—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profile" class="screen" style="display:none">
    <div style="display:flex;gap:12px">
      <div style="flex:1;background:#0e0e10;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        <div style="background:#0b0b0c;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div>–ü–∞—Ä–æ–ª—å</div>
          <button class="btn-sm btn-outline" onclick="changePass()">–°–º–µ–Ω–∏—Ç—å</button>
        </div>
        <div style="background:#0b0b0c;padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center">
          <div style="color:var(--danger)">–ó–æ–Ω–∞ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏</div>
          <button class="btn-sm btn-danger" onclick="deleteAccount()">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
        <button class="btn btn-outline" onclick="logout()">–í—ã–π—Ç–∏</button>
      </div>
      <div style="width:420px;background:#0e0e10;padding:12px;border-radius:12px">
        <h3 style="margin:0 0 8px">–ì–∞—Ä–¥–µ—Ä–æ–±</h3>
        <div style="margin-bottom:8px"><b>–¶–≤–µ—Ç –Ω–∏–∫–∞</b></div>
        <div id="colorGrid" class="style-grid"></div>
        <div style="margin-top:12px"><b>–†–∞–º–∫–∏</b></div>
        <div id="frameGrid" class="style-grid"></div>
      </div>
    </div>
  </div>

</div> <!-- end content -->

<!-- Confirm modal -->
<div id="confirm" class="modal"><div class="box"><h3 id="confirmTitle">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ</h3><div id="confirmText" style="color:var(--muted);margin:8px 0"></div><div style="display:flex;gap:8px"><button class="btn" onclick="confirmOk()">–î–∞</button><button class="btn btn-outline" onclick="closeModal('confirm')">–û—Ç–º–µ–Ω–∞</button></div></div></div>

<!-- NFT modal -->
<div id="nftModal" class="modal"><div class="box">
  <h3 id="nftName">Item</h3>
  <div style="display:flex;gap:12px;margin-top:10px">
    <div style="width:140px">
      <div style="width:140px;height:140px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);display:flex;align-items:center;justify-content:center">
        <img id="nftImg" src="" style="width:120px;height:120px;object-fit:contain;border-radius:10px">
      </div>
    </div>
    <div style="flex:1">
      <div id="nftId" class="kv">#00001</div>
      <div id="nftType" class="type">Type</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="toggleEquip()">–î–µ–π—Å—Ç–≤–∏—è</button>
        <button class="btn btn-outline" onclick="showTab('sell')">–ü—Ä–æ–¥–∞—Ç—å</button>
        <button class="btn btn-outline" onclick="showTab('gift')">–ü–æ–¥–∞—Ä–∏—Ç—å</button>
      </div>

      <div id="tabEquip" style="margin-top:10px">
        <div style="color:var(--muted)">–ù–∞–¥–µ—Ç—å / –°–Ω—è—Ç—å</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-sm" onclick="toggleEquip()">–ù–∞–¥–µ—Ç—å/–°–Ω—è—Ç—å</button>
          <button class="btn btn-sm btn-outline" onclick="returnToShop()">–í–µ—Ä–Ω—É—Ç—å –≤ —à–æ–ø</button>
        </div>
      </div>

      <div id="tabSell" style="display:none;margin-top:10px">
        <div style="color:var(--muted)">–°–∂–µ—á—å –∏–ª–∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn btn-sm btn-danger" onclick="burnItem()">–°–∂–µ—á—å</button>
          <input id="p2pPrice" placeholder="–¶–µ–Ω–∞ –¥–ª—è P2P" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn btn-sm" onclick="listP2P()">–í—ã—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
      </div>

      <div id="tabGift" style="display:none;margin-top:10px">
        <div style="color:var(--muted)">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="giftNick" placeholder="–ù–∏–∫ –¥—Ä—É–≥–∞" style="flex:1;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff">
          <button class="btn btn-sm" onclick="sendGift()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>

    </div>
  </div>
  <div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-outline" onclick="closeModal('nftModal')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<!-- Boost modal -->
<div id="boost" class="modal"><div class="box">
  <h3>Boosts</h3>
  <div style="display:flex;flex-direction:column;gap:8px">
    <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
      <div><b>Multi-tap</b><br><span class="kv">lvl <span id="tapLv">1</span></span></div>
      <button class="btn-sm btn-outline" onclick="buyTap()">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
      <div><b>Crit chance</b><br><span class="kv">lvl <span id="critLv">1</span></span></div>
      <button class="btn-sm btn-outline" onclick="buyCrit()">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0c;padding:10px;border-radius:8px">
      <div><b>Energy Regen</b><br><span class="kv">lvl <span id="regenLv">1</span></span></div>
      <button class="btn-sm btn-outline" onclick="buyRegen()">–ö—É–ø–∏—Ç—å (–Ω–µ —Ä–µ–≥–µ–Ω–∏—Ç—Å—è)</button>
    </div>
    <button class="btn btn-outline" onclick="closeModal('boost')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div></div>

<!-- Admin modal -->
<div id="admin" class="modal"><div class="box">
  <h3 style="color:var(--danger)">GOD MODE</h3>
  <input id="admTarget" placeholder="–ù–∏–∫ / Item" style="width:100%;padding:8px;border-radius:8px;background:#0c0c0d;border:1px solid rgba(255,255,255,0.03);color:#fff;margin:8px 0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <button class="btn btn-sm" onclick="adminUnban()">–†–ê–ó–ë–ê–ù</button>
    <button class="btn btn-sm btn-gold" onclick="adminGive()">–í–´–î–ê–¢–¨ –°–ï–ë–ï</button>
    <button class="btn btn-sm btn-danger" onclick="adminBan()">–ë–ê–ù</button>
    <button class="btn btn-sm btn-outline" onclick="adminAddToShop()">+ –í –®–û–ü</button>
  </div>
  <div style="margin-top:8px;display:flex;gap:8px"><button class="btn btn-outline" onclick="closeModal('admin')">–ó–∞–∫—Ä—ã—Ç—å</button></div>
</div></div>

<div class="navbar">
  <div class="nav-item active" onclick="show('home', this)"><i class="ri-home-5-line"></i><div>–î–æ–º</div></div>
  <div class="nav-item" onclick="show('shop', this)"><i class="ri-store-2-line"></i><div>–®–æ–ø</div></div>
  <div class="nav-item" onclick="show('casino', this)"><i class="ri-gamepad-line"></i><div>–ò–≥—Ä—ã</div></div>
  <div class="nav-item" onclick="show('profile', this)"><i class="ri-user-settings-line"></i><div>–ü—Ä–æ—Ñ–∏–ª—å</div></div>
</div>

<!-- SCRIPT: full logic -->
<script>
/* ================== CONFIG ================== */
const firebaseConfig = {
  apiKey: "AIzaSyDpX5YSiVr6ekrQRYhALaTo8C69mc1vLcg",
  authDomain: "nfts-dc174.firebaseapp.com",
  projectId: "nfts-dc174",
  storageBucket: "nfts-dc174.firebasestorage.app",
  messagingSenderId: "327365720624",
  appId: "1:327365720624:web:eb42c9d671566b5d118bf5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* small helpers */
function el(id){ return document.getElementById(id) }
function toast(msg, t=2200){ const box = el('toast'); box.innerText = msg; box.style.display='block'; setTimeout(()=>box.style.display='none', t); }
function openModal(id){ el(id).style.display='flex' }
function closeModal(id){ el(id).style.display='none' }
function show(screen, tabEl){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); el(screen).classList.add('active'); document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); if(tabEl) tabEl.classList.add('active'); }

/* ASSET generation: 120 items programmatically */
const BASE_CDN = "https://cdn.jsdelivr.net/gh/Tarikul-Islam-Anik/Animated-Fluent-Emojis@master/Emojis";
const base = [
  ["–†–∞–∫–µ—Ç–∞","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Rocket.png"],
  ["–ö–æ—Ä–æ–Ω–∞","–†–æ—Å–∫–æ—à—å","/Objects/Crown.png"],
  ["–ê–ª–º–∞–∑","–†–æ—Å–∫–æ—à—å","/Objects/Gem%20Stone.png"],
  ["–î–µ–Ω—å–≥–∏","–†–æ—Å–∫–æ—à—å","/Objects/Money%20Bag.png"],
  ["–î—Ä–∞–∫–æ–Ω","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Dragon.png"],
  ["–ï–¥–∏–Ω–æ—Ä–æ–≥","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Unicorn.png"],
  ["–ë—É—Ä–≥–µ—Ä","–ï–¥–∞","/Food/Hamburger.png"],
  ["–ü–∏—Ü—Ü–∞","–ï–¥–∞","/Food/Pizza.png"],
  ["–ö–æ—Ç","–ü–∏—Ç–æ–º–µ—Ü","/Animals/Cat%20Face.png"],
  ["–ù–æ—É—Ç–±—É–∫","–¢–µ—Ö–Ω–æ","/Objects/Laptop.png"],
  ["–û–≥–æ–Ω—å","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Travel%20and%20places/Fire.png"],
  ["–ü—Ä–∏–∑—Ä–∞–∫","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Smilies/Ghost.png"],
  ["–ú–∞—à–∏–Ω–∞","–ê–≤—Ç–æ","/Travel%20and%20places/Automobile.png"],
  ["–°–∞–º–æ–ª–µ—Ç","–ê–≤—Ç–æ","/Travel%20and%20places/Airplane.png"],
  ["–ù–õ–û","–¢–µ—Ö–Ω–æ","/Travel%20and%20places/Flying%20Saucer.png"],
  ["–ö–Ω–∏–≥–∞","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Book.png"],
  ["–¢–µ–ª–µ—Ñ–æ–Ω","–¢–µ—Ö–Ω–æ","/Objects/Smartphone.png"],
  ["–ö–ª—é—á","–ö–æ–ª–ª–µ–∫—Ü–∏—è","/Objects/Key.png"],
  ["–©–∏—Ç","–ë–æ–µ–≤—ã–µ","/Objects/Shield.png"],
  ["–ú–µ—á","–ë–æ–µ–≤—ã–µ","/Objects/Sword.png"]
];

let ASSETS = [];
let idc = 1;
for(let r=0;r<7 && idc<=120;r++){
  for(let i=0;i<base.length && idc<=120;i++){
    const b = base[i];
    ASSETS.push({
      id: pad(idc,5),
      name: `${b[0]}${r?(' '+r):''}`,
      type: b[1],
      url: BASE_CDN + b[2],
      basePrice: 100000 + Math.floor(Math.random()*2000000) + i*3000 + r*2000,
      supply: 100 + Math.floor(Math.random()*900)
    });
    idc++;
  }
}
function pad(n,len=5){return (""+n).padStart(len,'0')}

/* cosmetics */
const COS = {
  colors:[
    {id:'nick_def',name:'Default',cls:'',cost:0},
    {id:'nick_gold',name:'Gold',cls:'nick-gold',cost:250000},
    {id:'nick_neon',name:'Neon',cls:'nick-neon',cost:150000},
    {id:'nick_red',name:'Red',cls:'nick-red',cost:100000},
    {id:'nick_purple',name:'Purple',cls:'nick-purple',cost:120000}
  ],
  frames:[
    {id:'frame_def',name:'Default',cls:'',cost:0},
    {id:'frame_gold',name:'Gold',cls:'frame-gold',cost:500000},
    {id:'frame_neon',name:'Neon',cls:'frame-neon',cost:350000},
    {id:'frame_red',name:'Red',cls:'frame-red',cost:200000},
    {id:'frame_purple',name:'Purple',cls:'frame-purple',cost:250000}
  ]
};

/* state */
let me = null; // user doc
let stats = {}; // global stats
let pending = null;
let selIndex = null;

/* ensure stats doc exists */
(async ()=>{
  try{
    const sref = db.collection('game').doc('stats');
    const sd = await sref.get();
    if(!sd.exists) await sref.set({items:{}})
  }catch(e){ console.error(e) }
})();

/* AUTH / session quick-login (demo) */
let sessionNick = localStorage.getItem('nft_nick') || prompt("–ù–∏–∫ –¥–ª—è –≤—Ö–æ–¥–∞ (—Å–æ–∑–¥–∞—Å—Ç—Å—è –Ω–æ–≤—ã–π):");
if(!sessionNick) sessionNick = 'guest_' + Math.floor(Math.random()*9999);
localStorage.setItem('nft_nick', sessionNick);
start(sessionNick);

/* start watching user */
function start(nick){
  el('userId').innerText = nick;
  const ref = db.collection('users').doc(nick);
  ref.get().then(d=>{
    if(!d.exists){
      // create default user
      ref.set({
        nickname: nick, password:'', balance:5000000, energy:100,
        inventory:[], equipped:[], owned_colors:['nick_def'], owned_frames:['frame_def'],
        active_color:'nick_def', active_frame:'frame_def',
        tapLvl:1, critLvl:1, regenLvl:1, isBanned:false
      });
    }
    // subscribe
    ref.onSnapshot(snap=>{
      if(!snap.exists) return;
      me = snap.data();
      if(me.isBanned) { /* don't show ban; auto-unban for safety */ db.collection('users').doc(nick).update({isBanned:false}).catch(()=>{}); }
      syncUI();
    });
  });

  // global stats
  db.collection('game').doc('stats').onSnapshot(s=>{
    stats = s.exists? s.data().items || {} : {};
    renderShop();
  });

  // render initial
  renderShop();
  renderInventory();
  renderCosmetics();
}

/* sync UI */
function syncUI(){
  if(!me) return;
  el('nick').innerText = me.nickname || sessionNick;
  el('balance').innerText = Math.floor(me.balance||0).toLocaleString();
  el('energy').innerText = Math.floor(me.energy||0);
  el('invCount').innerText = (me.inventory||[]).length;
  // avatar letter & frame
  el('avatar').innerText = (me.nickname||'U')[0].toUpperCase();
  el('avatar').className = 'avatar';
  const frame = (me.active_frame || 'frame_def');
  const fr = COS.frames.find(f=>f.id===frame);
  if(fr && fr.cls) el('avatar').classList.add(fr.cls);
  // show admin button if nickname matches (kayivi)
  if(me.nickname === 'kayivi') el('adminBtn').style.display='inline-block';
  else el('adminBtn').style.display='none';
}

/* RENDER SHOP */
function renderShop(){
  const holder = el('shopGrid');
  holder.innerHTML = '';
  ASSETS.forEach(a=>{
    const sold = stats[a.name] || 0;
    const price = Math.max(100000, Math.floor(a.basePrice * (1 + sold*0.01)));
    const remaining = Math.max(0, a.supply - sold);
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="supply">${remaining}/${a.supply}</div>
      <div class="type">${a.type}</div>
      <div class="plate"><img src="${a.url}" onerror="this.src='https://via.placeholder.com/120?text=NFT'"></div>
      <div class="name" title="${a.name}">${a.name}</div>
      <div style="display:flex;gap:8px;margin-top:8px;width:100%"><div class="price">${price.toLocaleString()} üíé</div><button class="btn btn-sm btn-outline" ${remaining<=0?'disabled':''} onclick="askBuy('${a.name}',${price})">–ö—É–ø–∏—Ç—å</button></div>
      <div style="display:flex;gap:8px;margin-top:8px"><button class="btn-sm btn-outline" style="flex:1" onclick="previewShop('${a.name}')">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button></div>
    `;
    holder.appendChild(card);
  });
}

/* preview shop item */
function previewShop(name){
  const a = ASSETS.find(x=>x.name===name);
  if(!a) return;
  el('nftName').innerText = a.name;
  el('nftImg').src = a.url;
  el('nftId').innerText = `#${a.id}`;
  el('nftType').innerText = a.type;
  showTab('equip'); openModal('nftModal');
}

/* ask buy */
function askBuy(name,price){
  pending = {name,price};
  el('confirmTitle').innerText = '–ü–æ–∫—É–ø–∫–∞';
  el('confirmText').innerText = `–ö—É–ø–∏—Ç—å "${name}" –∑–∞ ${price.toLocaleString()} üíé?`;
  openModal('confirm');
}

/* confirm OK */
async function confirmOk(){
  if(!pending){ closeModal('confirm'); toast('–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏'); return; }
  const {name,price} = pending;
  try{
    // transaction
    await db.runTransaction(async t=>{
      const userRef = db.collection('users').doc(me.nickname);
      const statsRef = db.collection('game').doc('stats');
      const userDoc = await t.get(userRef);
      const statDoc = await t.get(statsRef);
      if(!userDoc.exists) throw 'User missing';
      const ud = userDoc.data();
      if((ud.balance||0) < price) throw '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤';
      // find asset
      const asset = ASSETS.find(a=>a.name===name);
      if(!asset) throw '–ù–µ—Ç —Ç–∞–∫–æ–≥–æ —Ç–æ–≤–∞—Ä–∞';
      const sold = (statDoc.exists && statDoc.data().items)? (statDoc.data().items[name] || 0) : 0;
      if(sold >= asset.supply) throw '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏';
      // push new item to inventory
      const newItem = { id: Date.now()+Math.random(), name: asset.name, type: asset.type, url: asset.url, basePrice: asset.basePrice, serial: sold+1 };
      t.update(userRef, { balance: (ud.balance||0) - price, inventory: firebase.firestore.FieldValue.arrayUnion(newItem) });
      t.set(statsRef, { items: { ...(statDoc.exists?statDoc.data().items:{}), [name]: sold+1 } }, { merge: true });
    });
    toast('–ö—É–ø–ª–µ–Ω–æ');
    closeModal('confirm');
    pending = null;
  }catch(e){ toast(typeof e==='string'?e:(e.message||'–û—à–∏–±–∫–∞')); closeModal('confirm'); pending=null; }
}

/* RENDER INVENTORY */
function renderInventory(){
  const holder = el('inventory');
  holder.innerHTML = '';
  if(!me) return;
  (me.inventory||[]).forEach((it, idx)=>{
    const eq = (me.equipped||[]).find(x=>x.id===it.id);
    const card = document.createElement('div'); card.className='card';
    card.style.background = ''; // can set gradient from item
    card.innerHTML = `
      ${eq?'<div class="equipped"></div>':''}
      <div class="type">${it.type}</div>
      <div class="plate"><img src="${it.url}" onerror="this.src='https://via.placeholder.com/120?text=NFT'"></div>
      <div class="name">${it.name}</div>
      <div style="display:flex;gap:8px;margin-top:8px;width:100%"><button class="btn-sm btn-outline" style="flex:1" onclick="openItem(${idx})">–ú–µ–Ω—é</button><div class="mon">${pad(idx+1,5)}</div></div>
    `;
    holder.appendChild(card);
  });
}

/* open item modal */
function openItem(i){
  selIndex = i;
  const it = me.inventory[i];
  if(!it) return;
  el('nftName').innerText = it.name;
  el('nftImg').src = it.url;
  el('nftId').innerText = `#${pad(i+1,5)}`;
  el('nftType').innerText = it.type;
  showTab('equip');
  openModal('nftModal');
}

/* tabs inside nft modal */
function showTab(t){ el('tabEquip').style.display='none'; el('tabSell').style.display='none'; el('tabGift').style.display='none'; if(t==='equip') el('tabEquip').style.display='block'; if(t==='sell') el('tabSell').style.display='block'; if(t==='gift') el('tabGift').style.display='block'; }

/* equip toggle */
async function toggleEquip(){
  if(selIndex===null) return;
  const it = me.inventory[selIndex];
  if(!it) return;
  const current = me.equipped || [];
  const exists = current.find(x=>x.id===it.id);
  if(exists){
    const newEq = current.filter(x=>x.id!==it.id);
    await db.collection('users').doc(me.nickname).update({ equipped: newEq });
    toast('–°–Ω—è—Ç–æ');
  } else {
    if(current.length >= 3){ toast('–ú–∞–∫—Å–∏–º—É–º 3'); return; }
    await db.collection('users').doc(me.nickname).update({ equipped: firebase.firestore.FieldValue.arrayUnion(it) });
    toast('–ù–∞–¥–µ—Ç–æ');
  }
  closeModal('nftModal');
}

/* return to shop (admin-like) */
async function returnToShop(){
  if(selIndex===null) return;
  const it = me.inventory[selIndex];
  if(!it) return;
  // remove from inventory
  const newInv = me.inventory.filter((x,idx)=>idx!==selIndex);
  const newEq = (me.equipped||[]).filter(x=>x.id!==it.id);
  await db.collection('users').doc(me.nickname).update({ inventory:newInv, equipped:newEq });
  // decrease sold count in stats
  const statsRef = db.collection('game').doc('stats');
  await db.runTransaction(async t=>{
    const s = await t.get(statsRef);
    const items = s.exists? s.data().items || {} : {};
    const cur = items[it.name] || 0;
    t.set(statsRef, { items: { ...(items), [it.name]: Math.max(0, cur-1) } }, { merge:true });
  });
  toast('–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ —à–æ–ø');
  closeModal('nftModal');
}

/* burn item */
async function burnItem(){
  if(selIndex===null) return;
  const it = me.inventory[selIndex];
  if(!it) return;
  const refund = Math.floor((it.basePrice||100000)*0.1);
  const newInv = me.inventory.filter((x,idx)=>idx!==selIndex);
  const newEq = (me.equipped||[]).filter(x=>x.id!==it.id);
  await db.collection('users').doc(me.nickname).update({ inventory:newInv, equipped:newEq, balance: firebase.firestore.FieldValue.increment(refund) });
  toast('–°–æ–∂–∂–µ–Ω–æ +'+refund);
  closeModal('nftModal');
}

/* list P2P */
async function listP2P(){
  if(selIndex===null) return;
  const it = me.inventory[selIndex];
  if(!it) return;
  const price = parseInt(el('p2pPrice').value);
  if(!price || price < 1000) return toast('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É');
  await db.collection('market').doc(it.id + '_' + me.nickname).set({ seller:me.nickname, price, item:it, placedAt:Date.now() });
  // remove from inventory
  const newInv = me.inventory.filter((x,idx)=>idx!==selIndex);
  await db.collection('users').doc(me.nickname).update({ inventory:newInv });
  toast('–í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä—ã–Ω–æ–∫');
  closeModal('nftModal');
}

/* send gift */
async function sendGift(){
  if(selIndex===null) return;
  const it = me.inventory[selIndex];
  if(!it) return;
  const nick = el('giftNick').value.trim();
  if(!nick) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫');
  if(nick === me.nickname) return toast('–ù–µ–ª—å–∑—è —Å–µ–±–µ');
  const target = await db.collection('users').doc(nick).get();
  if(!target.exists) return toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
  // remove from me, add to other
  const newInv = me.inventory.filter((x,idx)=>idx!==selIndex);
  await db.collection('users').doc(me.nickname).update({ inventory:newInv });
  await db.collection('users').doc(nick).update({ inventory: firebase.firestore.FieldValue.arrayUnion(it) });
  toast('–ü–æ–¥–∞—Ä–µ–Ω–æ');
  closeModal('nftModal');
}

/* render cosmetics */
function renderCosmetics(){
  const cg = el('colorGrid'); cg.innerHTML=''; COS.colors.forEach(c=>{
    const owned = (me.owned_colors||[]).includes(c.id);
    const active = me.active_color === c.id;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="color:${c.id==='nick_def'?'#fff':(c.id==='nick_gold'? '#fbbf24': (c.id==='nick_neon'?'#00f2ff':(c.id==='nick_red'?'#ff6b6b':'#d946ef')))};font-weight:800">${c.name}</div><div class="kv">${owned?(active?'–ê–∫—Ç–∏–≤–Ω–æ':'–ö—É–ø–ª–µ–Ω–æ'):(c.cost.toLocaleString()+' üíé')}</div><div style="margin-top:8px"><button class="btn btn-sm ${active?'btn-gold':''}" onclick="${owned?`equipStyle('color','${c.id}')`:`buyStyle('color','${c.id}',${c.cost})`}">${active?'‚úì':'–ö—É–ø–∏—Ç—å'}</button></div>`;
    cg.appendChild(div);
  });
  const fg = el('frameGrid'); fg.innerHTML=''; COS.frames.forEach(f=>{
    const owned = (me.owned_frames||[]).includes(f.id);
    const active = me.active_frame === f.id;
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<div style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;margin-bottom:8px" class="${f.cls}">A</div><div class="kv">${owned?(active?'–ê–∫—Ç–∏–≤–Ω–æ':'–ö—É–ø–ª–µ–Ω–æ'):(f.cost.toLocaleString()+' üíé')}</div><div style="margin-top:8px"><button class="btn btn-sm ${active?'btn-gold':''}" onclick="${owned?`equipStyle('frame','${f.id}')`:`buyStyle('frame','${f.id}',${f.cost})`}">${active?'‚úì':'–ö—É–ø–∏—Ç—å'}</button></div>`;
    fg.appendChild(div);
  });
}

/* buy/equip style */
async function buyStyle(type,id,cost){
  if((me.balance||0) < cost) return toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ');
  if(type==='color'){
    await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(-cost), owned_colors: firebase.firestore.FieldValue.arrayUnion(id) });
  } else {
    await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(-cost), owned_frames: firebase.firestore.FieldValue.arrayUnion(id) });
  }
  toast('–ö—É–ø–ª–µ–Ω–æ');
}
async function equipStyle(type,id){
  if(type==='color') await db.collection('users').doc(me.nickname).update({ active_color:id });
  else await db.collection('users').doc(me.nickname).update({ active_frame:id });
  toast('–ü—Ä–∏–º–µ–Ω–µ–Ω–æ');
}

/* simple boosts */
async function buyTap(){ await db.collection('users').doc(me.nickname).update({ tapLvl: firebase.firestore.FieldValue.increment(1) }); toast('–ö—É–ø–ª–µ–Ω–æ'); }
async function buyCrit(){ await db.collection('users').doc(me.nickname).update({ critLvl: firebase.firestore.FieldValue.increment(1) }); toast('–ö—É–ø–ª–µ–Ω–æ'); }
async function buyRegen(){ await db.collection('users').doc(me.nickname).update({ regenLvl: firebase.firestore.FieldValue.increment(1) }); toast('–ö—É–ø–ª–µ–Ω–æ (–Ω–æ —Ä–µ–≥–µ–Ω –æ—Ç–∫–ª—é—á—ë–Ω)'); }

/* admin functions */
async function adminBan(){ const t = el('admTarget').value.trim(); if(!t) return toast('–ù–∏–∫?'); await db.collection('users').doc(t).update({ isBanned:true }); toast('–ó–∞–±–∞–Ω–µ–Ω'); }
async function adminUnban(){ const t = el('admTarget').value.trim(); if(!t) return toast('–ù–∏–∫?'); await db.collection('users').doc(t).update({ isBanned:false }); toast('–†–∞–∑–±–∞–Ω–µ–Ω'); }
async function adminGive(){ const s = el('admTarget').value.trim(); if(!s) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); const asset = ASSETS.find(a=>a.name===s); if(!asset) return toast('–ù–µ—Ç —Ç–∞–∫–æ–≥–æ'); await db.collection('users').doc(me.nickname).update({ inventory: firebase.firestore.FieldValue.arrayUnion({id:Date.now(),name:asset.name,type:asset.type,url:asset.url,basePrice:asset.basePrice}) }); toast('–í—ã–¥–∞–Ω–æ'); }
async function adminAddToShop(){ const s = el('admTarget').value.trim(); if(!s) return toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); const statsRef = db.collection('game').doc('stats'); await statsRef.set({ items: { ...(stats||{}), [s]: 0 } }, { merge:true }); toast('–î–æ–±–∞–≤–ª–µ–Ω–æ/—Å–±—Ä–æ—à–µ–Ω–æ'); }

/* SLOTS and MINES simple logic */
const slotSym = ["üçí","üçã","üçá","üíé","üçÄ","‚≠ê","7Ô∏è‚É£"];
async function playSlots(){
  let bet = parseInt(el('slotBet').value); if(isNaN(bet) || bet<100) return toast('–ú–∏–Ω 100'); if((me.balance||0) < bet) return toast('–ú–∞–ª–æüíé');
  await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(-bet) });
  const r1 = rand(slotSym), r2 = rand(slotSym), r3 = rand(slotSym);
  el('slot1').innerText = r1; el('slot2').innerText = r2; el('slot3').innerText = r3;
  let win = 0;
  if(r1===r2 && r2===r3){ if(r1==='7Ô∏è‚É£') win = bet*50; else if(r1==='üíé') win = bet*25; else win = bet*10; }
  else if(r1===r2 || r2===r3 || r1===r3) win = bet*2;
  if(win>0){ await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(win) }); toast('–í—ã–∏–≥—Ä—ã—à +'+win); } else toast('–ü—Ä–æ–∏–≥—Ä—ã—à');
}
function rand(a){ return a[Math.floor(Math.random()*a.length)]; }

/* MINES */
let mines = { active:false, field:[], bet:0 };
async function startMines(){
  if(mines.active) return toast('–ò–≥—Ä–∞ –∏–¥–µ—Ç');
  let bet = parseInt(el('minesBet').value); if(isNaN(bet)||bet<100) return toast('–ú–∏–Ω 100'); if((me.balance||0)<bet) return toast('–ú–∞–ª–æüíé');
  await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(-bet) });
  mines.active=true; mines.bet=bet; mines.field = Array(16).fill('safe'); // place bombs
  let bombs = 4; while(bombs){ const p = Math.floor(Math.random()*16); if(mines.field[p]==='safe'){ mines.field[p]='bomb'; bombs--; } }
  renderMines();
}
function renderMines(){
  const holder = el('minesField'); holder.innerHTML=''; mines.field.forEach((v,i)=>{
    const d = document.createElement('div'); d.style.background='#111'; d.style.borderRadius='8px'; d.style.height='60px'; d.style.display='flex'; d.style.alignItems='center'; d.style.justifyContent='center'; d.style.cursor='pointer';
    d.onclick = async ()=>{ if(!mines.active) return; if(mines.field[i]==='bomb'){ d.innerText='üí£'; d.style.background='#400'; mines.active=false; toast('–ë–æ–º–±–∞! –ü—Ä–æ–∏–≥—Ä—ã—à'); } else { d.innerText='üíé'; d.style.background='#063'; mines.bet += Math.floor(mines.bet*0.25); await db.collection('users').doc(me.nickname).update({ balance: firebase.firestore.FieldValue.increment(Math.floor(mines.bet*0.2)) }); toast('–í—ã–∏–≥—Ä—ã—à!'); } };
    holder.appendChild(d);
  });
}

/* profile actions */
function changePass(){ const p = prompt('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:'); if(p && p.length>3) db.collection('users').doc(me.nickname).update({ password:p }).then(()=>toast('–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω')); }
function deleteAccount(){ if(confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?')) db.collection('users').doc(me.nickname).delete().then(()=>{ localStorage.removeItem('nft_nick'); location.reload(); }); }
function logout(){ localStorage.removeItem('nft_nick'); location.reload(); }

/* account utilities */
function pad(n,len=5){ return (''+n).padStart(len,'0') }

/* remove ban artifacts (guaranteed) - placed and executed */
(function removeBanArtifacts(){
  // remove any existing banned element
  document.querySelectorAll("#ban-screen").forEach(el=>el.remove());
  // override showBanScreen if present
  window.showBanScreen = function(){};
  // periodic cleanup in case something injects text
  setInterval(()=>document.querySelectorAll('*').forEach(el=>{
    try{
      if(el && el.innerText && (el.innerText.includes('BANNED') || el.innerText.includes('–∞–≤—Ç–æ–∫–ª–∏–∫–µ—Ä–∞') || el.innerText.includes('–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'))) el.remove();
    }catch(e){}
  }), 200);
})();

/* initial renders & utilities */
window.renderShop = renderShop;
window.renderInventory = renderInventory;
window.renderCosmetics = renderCosmetics;
setTimeout(()=>{ renderShop(); renderInventory(); renderCosmetics(); }, 600);

/* expose some functions */
window.askBuy = askBuy;
window.openItem = openItem;
window.playSlots = playSlots;
window.startMines = startMines;
window.buyStyle = buyStyle;
window.equipStyle = equipStyle;
window.adminBan = adminBan;
window.adminUnban = adminUnban;
window.adminGive = adminGive;
window.adminAddToShop = adminAddToShop;
window.openModal = openModal;
window.closeModal = closeModal;

/* quick keyboard: Esc closes modals */
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); } });
</script>

</body>
</html>
